import{_ as t,e,a as s,r as n,b as r,$ as a,j as i,T as o,F as c,L as h,S as l,i as d,s as u,c as f,t as p,d as g,f as w,g as y,h as m,k as _,l as b,m as v,n as I,o as B,u as D,p as E,q as S,v as T,w as O,x as M,y as L,z as j,A as H,B as N}from"./vendor.b11087fc.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();let k=class{};k=t([e()],k);let R=class{};R=t([e()],R);class A extends R{}const x=(t,e,s)=>(r,a,i)=>{const o=i.value;if("function"!=typeof o)throw new TypeError;const c=async function(...r){const a=new n;this[s]=a.promise;const i=o.apply(this,r);return this[e].requestTransaction(t,(t=>(a.resolve(t),i)))};return Reflect.set(c,"source",o),i.value=c,i};let P=class{calcBranchId(t){const e=t-this.startTime;if(e<0)throw new RangeError("invald time: "+t);let s=e/this.timespan;return s%1==0&&(s+=1),Math.ceil(s)}calcNextBranchId(t){let e=t/this.branchGroupCount;return e%1==0&&(e+=1),Math.ceil(e)}calcBranchIdRange(t){const e=(t-1)*this.branchGroupCount;return{start:e+1,end:e+this.branchGroupCount}}};P=t([e()],P);let F=class{msgIsSign(t,e){return this.signIsSign(this.getSignature(t),e)}signIsSign(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0}compareMessage(t,e){const s=this.getCreateTime(t),n=this.getCreateTime(e);if(s<n)return-1;if(s>n)return 1;const r=this.getSignature(t),a=this.getSignature(e);if(r.length<a.length)return-1;if(r.length>a.length)return 1;for(let i=0;i<r.length;++i){const t=r[i],e=a[i];if(t<e)return-1;if(t>e)return 1}return 0}};var C,$,q,G,W,J;F=t([e()],F);let U=class{constructor(t,e,s,n){this.config=t,this.cryptoHelper=e,this.messageHelper=n,this._store=s.fork(["timeline"])}addLeaf(t){return this._addLeaf(t,this._store)}async hasManyLeaf(t){const e=await this._trs;return this._batchHas(t,e)}async _batchHas(t,e){const{messageHelper:s}=this,n=[],r=new Map;for(const a of t){const t=this.config.calcBranchId(s.getCreateTime(a));let i=r.get(t);if(void 0===i&&(i=await e.getJsObject(["blocks",`block-${t}`])||null,r.set(t,i)),null!==i){const t=s.getSignature(a),e=K(t,i.indexedDigit),r=i.mapData.get(e);if(void 0!==r){n.push(s.msgIsSign(r,t));continue}}n.push(!1)}return n}async _addLeaf(t,e){const{messageHelper:s}=this,n=s.getCreateTime(t),r=this.config.calcBranchId(n),a=["blocks",`block-${r}`],i=await e.getJsObject(a)||{indexedDigit:8,mapData:new Y},o=s.getSignature(t);do{const e=K(o,i.indexedDigit),n=i.mapData.get(e);if(void 0===n){i.mapData.set(e,t);break}if(s.msgIsSign(n,o))return!1;if(256===i.indexedDigit)throw console.error("signature should be equal",o,n),new Error("out of indexedDigit");const r=i.indexedDigit=2*i.indexedDigit,a=new Map;for(const t of i.mapData.values())a.set(K(s.getSignature(t),r),t);i.mapData=a}while(i.indexedDigit<=256);let c=0,h=0,l=r;const d=[];do{++c,h=this.config.calcNextBranchId(l),d.unshift({paths:["tree-hash",`level-${c}`,`branch-${h}`],dirtyBranchId:l}),l=h}while(1!==h);for(const u of d){let t=await e.getJsObject(u.paths);if(void 0!==t){if(t.subDirty.has(u.dirtyBranchId))continue;t.dirty=!0,t.subDirty.add(u.dirtyBranchId),t.subHash.delete(u.dirtyBranchId)}else t={hash:V,dirty:!0,subDirty:new Set([u.dirtyBranchId]),subHash:new Map};await e.setJsObject(u.paths,t)}return await e.setJsObject(a,i),{branchId:r}}async addManyLeaf(t){const e=await this._trs,s=[];for(const n of t)s.push({success:await this._addLeaf(n,e),leaf:n});return s}getLeafFromBranchData(t,e){const s=K(e,t.indexedDigit),n=t.mapData.get(s);if(n&&this.messageHelper.msgIsSign(n,e))return n}async getBranchData(t){const e=["blocks",`block-${t}`];return this._store.getJsObject(e)}async _getBlockHash(t){const e=await this._store.getBinary(["blocks",`block-${t}`]);return e?await this.cryptoHelper.sha256Binary(e):V}async _getBranchHash(t,e,s){if(0===s){const s=["level-1",`branch-${this.config.calcNextBranchId(e)}`],n=await t.getJsObject(s);if(void 0===n)return V;const r=n.subDirty.has(e)||n.subHash.get(e);let a=V;return!0===r?(a=await this._getBlockHash(e),0===a.length?n.subHash.delete(e):n.subHash.set(e,a),n.subDirty.delete(e),await t.setJsObject(s,n)):void 0!==r&&(a=r),a}const n=[`level-${s}`,`branch-${e}`],r=await t.getJsObject(n);if(void 0===r)return V;if(!1===r.dirty)return r.hash;if(0!==r.subDirty.size){const e=s-1;if(0===e)for(const t of r.subDirty){const e=await this._getBlockHash(t);0===e.length?r.subHash.delete(t):r.subHash.set(t,e)}else for(const s of r.subDirty){const n=await this._getBranchHash(t,s,e);0===n.length?r.subHash.delete(s):r.subHash.set(s,n)}r.subDirty.clear()}const a=[...r.subHash].sort(((t,e)=>t[0]-e[0]));switch(a.length){case 0:r.hash=V;break;case 1:r.hash=a[0][1];break;default:const t=this.cryptoHelper.sha256HashBuilder();for(const e of a)t.update(e[1]);r.hash=await t.digest()}return r.dirty=!1,await t.setJsObject(n,r),r.hash}async getBranchRoute(t){const e=await this._trs_th;let s=0,n=this.config.calcBranchId(t);const r=[{level:s,branchId:n,hash:await this._getBranchHash(e,n,s)}];for(;1!==n;)n=this.config.calcNextBranchId(n),s+=1,r.push({level:s,branchId:n,hash:await this._getBranchHash(e,n,s)});return r}async getBranchChildren(t,e){const s=await this._trs_th;if(e<1)throw new RangeError(`invalid branch level: ${e} when get branch(${t})`);const n=await s.getJsObject([`level-${e}`,`branch-${t}`]),r=new Map;if(void 0!==n){const t=e-1;for(const e of[...n.subDirty,...n.subHash.keys()]){const n=await this._getBranchHash(s,e,t);0!==n.length&&r.set(e,n)}}return r}};t([x([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof(C="undefined"!=typeof Iterable&&Iterable)?C:Object]),s("design:returntype",Promise)],U.prototype,"hasManyLeaf",null),t([x([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof($="undefined"!=typeof Iterable&&Iterable)?$:Object]),s("design:returntype",Promise)],U.prototype,"addManyLeaf",null),t([x(["tree-hash"],"_store","_trs_th"),s("design:type",Function),s("design:paramtypes",[Number]),s("design:returntype",Promise)],U.prototype,"getBranchRoute",null),t([x(["tree-hash"],"_store","_trs_th"),s("design:type",Function),s("design:paramtypes",[Number,Number]),s("design:returntype",Promise)],U.prototype,"getBranchChildren",null),U=t([e(),s("design:paramtypes",["function"==typeof(q=void 0!==P&&P)?q:Object,"function"==typeof(G=void 0!==k&&k)?G:Object,"function"==typeof(W=void 0!==A&&A)?W:Object,"function"==typeof(J=void 0!==F&&F)?J:Object])],U);class Y extends Map{constructor(){super(...arguments),this._okl=[]}get[Symbol.toStringTag](){return"OrderMap"}set(t,e){if(Number.isNaN(t))throw new TypeError("order-map's key must be finite number");const s=this.size;return super.set(t,e),this.size!==s&&(this._okl.push(t),this._okl.sort()),this}delete(t){return!!super.delete(t)&&(this._okl.splice(this._okl.indexOf(t)),!0)}keys(){return this._okl[Symbol.iterator]()}*entries(){for(const t of this._okl)yield[t,this.get(t)]}[Symbol.iterator](){return this.entries()}toMap(){return new Map(this)}static fromMap(t){const e=new Y(t);return e._okl=[...t.keys()].sort(),e}}const z=(t,e)=>{switch(e){case 8:return t[0]||0;case 16:return((t[0]||0)<<8)+(t[1]||0);case 32:return(z(t,16)<<16)+z(t.slice(16),16)}},Q=(t,e)=>{switch(e){case 64:return(BigInt(z(t,32))<<32n)+BigInt(z(t.slice(32),32));case 128:return(BigInt(Q(t,64))<<64n)+BigInt(Q(t.slice(64),64));case 256:return(BigInt(Q(t,128))<<128n)+BigInt(Q(t.slice(128),128))}},K=(t,e)=>e<=32?z(t,e):Q(t,e),V=new Uint8Array(0);let X=class{max(t,e=this.now()){return t>=e?t:e}};X=t([e()],X);class Z extends X{now(){return performance.now()+performance.timeOrigin}}const tt=(t,e,s)=>{const n=t.getJsObject(e);return void 0!==n&&"then"in n?n.then((t=>s(t))):s(n)};var et;let st=class{constructor(t){this.storage=t}addAudio(t){this.storage.setBinary(["assets","audio"],t)}addVideo(t){this.storage.setBinary(["assets","video"],t)}addDocument(t){this.storage.setBinary(["assets","document"],t)}addPicture(t){this.storage.setBinary(["assets","picture"],t)}addCode(t){this.storage.setBinary(["assets","code"],t)}async addFile(t){this.storage.setBinary(["assets",t.type],new Uint8Array(await t.arrayBuffer()))}};var nt,rt,at,it,ot,ct,ht,lt;st=t([e(),s("design:paramtypes",["function"==typeof(et=void 0!==A&&A)?et:Object])],st);const dt=(t,e)=>t<e?-1:t>e?1:0,ut=(t,e)=>t<e?1:t>e?-1:0;let ft=class{constructor(t,e){this.config=t,this.timeHelper=e,this._cache=new Map}getDataList(t,e){const s=[`receipt-${e}`];let n=this._cache.get(e);if(!n&&(n={lastUpdateTime:this.timeHelper.now(),dataList:tt(t,s,(t=>t||[]))},this._cache.set(e,n),this._cache.size>3)){const t=this.timeHelper.now();for(const[e,s]of this._cache){if(s.lastUpdateTime+1e4>t)break;void 0===s.writerQueue&&this._cache.delete(e)}}return n.dataList}setDataList(t,e,s){let r=this._cache.get(e);const a=this.timeHelper.now();r?(this._cache.delete(e),r.lastUpdateTime=a,r.dataList=s):r={dataList:s,lastUpdateTime:a},this._cache.set(e,r);let i=r.writerQueue;if(void 0===i){i=r.writerQueue=new n;const s=r,a=i;queueMicrotask((async()=>{const n=[`receipt-${e}`];s.writerQueue=void 0;try{await t.setJsObject(n,s.dataList),a.resolve()}catch(r){a.reject(r)}}))}return i.promise}_getBranchMetaGroup(t,e){var s;if((null==(s=this._metaCache)?void 0:s.groupId)!==e){this._metaCache={groupId:e,cache:void 0};const s=this._metaCache;s.cache=tt(t,["meta-branch",`group-${e}`],(t=>(s.cache=t,t)))}return this._metaCache.cache}_setBranchMetaGroup(t,e,s){return this._metaCache={groupId:e,cache:s},t.setJsObject(["meta-branch",`group-${e}`],s)}async getBranchMeta(t,e){const s=this.config.calcNextBranchId(e),n=await this._getBranchMetaGroup(t,s);return null==n?void 0:n.map.get(e)}async setBranchMeta(t,e,s){const n=this.config.calcNextBranchId(e),r=await this._getBranchMetaGroup(t,n)||{groupId:n,map:new Map};return r.map.set(e,s),this._setBranchMetaGroup(t,n,r)}async upsertBranchMeta(t,e,s){const n=await this.getBranchMeta(t,e)||{preBranchId:e,nextBranchId:e};return this.setBranchMeta(t,e,Object.assign(n,s))}async*BranchIdWalker(t,e,s=wt.UP){const n=this.config.calcNextBranchId(e);let r;if(r=await this._getBranchMetaGroup(t,n),void 0===r){const{files:e}=await t.listPaths(["meta-branch"]),a=[];for(const t of e)t.startsWith("group-")&&a.push(+t.slice(6));a.sort(s===wt.DOWN?ut:dt);let i=a.findIndex((t=>dt(n,t)!==s));if(-1===i)return;for(;i<a.length;){const e=a[i];if(r=await this._getBranchMetaGroup(t,e),void 0!==r)break;console.error(new Error(`数据库异常，可能发生数据丢失(${t.currentPaths}, ${["meta-branch",`group-${e}`]})`)),i++}}for(;;){if(void 0===r)return;const n=[...r.map.keys()].sort(s===wt.DOWN?ut:dt);if(0===n.length)throw new Error(`数据库异常，可能是数据丢失，索引断链，需要重新整理数据重建索引(${t.currentPaths}, ${r.groupId})`);let a=n.findIndex((t=>ut(e,t)===s));if(-1!==a)do{yield n[a]}while(++a<n.length);const i=r.map.get(n[n.length-1]),o=s===wt.UP?i.nextBranchId:i.preBranchId,c=this.config.calcNextBranchId(o);if(c===r.groupId)return;r=await this._getBranchMetaGroup(t,c)}}};ft=t([e(),s("design:paramtypes",["function"==typeof(nt=void 0!==P&&P)?nt:Object,"function"==typeof(rt=void 0!==Z&&Z)?rt:Object])],ft);let pt=class{constructor(t,e,s){this.config=t,this.timeHelper=e,this._branchHanlder=s}getMeta(t){return void 0===this._meta&&(this._meta=tt(t,["meta"],(async e=>{if(e){if(0!==e.firstBranchId){0===(await this._branchHanlder.getDataList(t,e.firstBranchId)).length&&(e.firstBranchId=0)}if(e.lastBranchId!==e.secondLastBranchId){0===(await this._branchHanlder.getDataList(t,e.lastBranchId)).length&&(e.lastBranchId=e.secondLastBranchId)}}return this._meta=null!=e?e:{firstBranchId:0,lastBranchId:0,secondLastBranchId:0}}))),this._meta}setMeta(t,e){return t.setJsObject(["meta"],e)}};pt=t([e(),s("design:paramtypes",["function"==typeof(at=void 0!==P&&P)?at:Object,"function"==typeof(it=void 0!==Z&&Z)?it:Object,ft])],pt);let gt=class{constructor(t,e,s,n,r){this.config=t,this.timeHelper=e,this._branchHanlder=n,this._metaHanlder=r,this._perNow=0,this._store=s.fork(["datalist"])}async _upsertMetaWhenAddNewItem(t,e){const s=await this._metaHanlder.getMeta(t);let n=0;if(0===s.firstBranchId)s.firstBranchId=e,s.secondLastBranchId=e,s.lastBranchId=e;else{if(!(s.lastBranchId<e)){if(s.lastBranchId===e)return;throw new Error("NOSUPPORT: new-branchId should not less then last-branchId")}n=s.secondLastBranchId=s.lastBranchId,s.lastBranchId=e}await this._metaHanlder.setMeta(t,s),0!==n&&await this._branchHanlder.upsertBranchMeta(t,n,{nextBranchId:e}),await this._branchHanlder.setBranchMeta(t,e,{preBranchId:n,nextBranchId:e})}async addItem(t,e=this.timeHelper.now()){const s=this.timeHelper.max(this._perNow+1,e);this._perNow=s;const n=this.config.calcBranchId(s),r=await this._trs;await this._upsertMetaWhenAddNewItem(r,n);const a=await this._branchHanlder.getDataList(r,n);return a.push({insertTime:s,data:t}),await this._branchHanlder.setDataList(r,n,a),e}async addManyItem(t,e=this.timeHelper.now()){const s=await this._trs;let n,r=0;const a=[];for(const i of t){const t=this.timeHelper.max(this._perNow+1,e);a.push(t),this._perNow=t;const o=this.config.calcBranchId(t);o!==r&&(await this._upsertMetaWhenAddNewItem(s,o),void 0!==n&&(await this._branchHanlder.setDataList(s,r,n),n=void 0),r=o),void 0===n&&(n=await this._branchHanlder.getDataList(s,o)),n.push({insertTime:t,data:i})}return n&&await this._branchHanlder.setDataList(s,r,n),a}async*ItemReader(t,e=wt.UP){let s,n=this.config.calcBranchId(t);for(;;){const r=await this._branchHanlder.getDataList(this._store,n);let a=0,i=r.length;if(0!==r.length)for(e===wt.DOWN&&(a=i-1,i=-1);a!==i;){const s=r[a];dt(t,s.insertTime)!==e&&(yield s),a+=e}null!=s||(s=this._branchHanlder.BranchIdWalker(this._store,n,e));const o=await s.next();if(o.done)return;n=o.value}}};var wt,yt,mt,_t,bt,vt;t([x([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",[Object,Object]),s("design:returntype",Promise)],gt.prototype,"addItem",null),t([x([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof(ot="undefined"!=typeof Iterable&&Iterable)?ot:Object,Object]),s("design:returntype",Promise)],gt.prototype,"addManyItem",null),gt=t([e(),s("design:paramtypes",["function"==typeof(ct=void 0!==P&&P)?ct:Object,"function"==typeof(ht=void 0!==Z&&Z)?ht:Object,"function"==typeof(lt=void 0!==A&&A)?lt:Object,ft,pt])],gt),(yt=wt||(wt={}))[yt.UP=1]="UP",yt[yt.DOWN=-1]="DOWN";const It={SYNC_CHANNE:Symbol("syncChannnel")};let Bt=class{constructor(t,e,s,n,r){this.syncChannel=t,this.timelineTree=e,this.dataList=s,this.timeHelper=n,this.msgHelper=r,this.taskSeq=new Ot({}),this.responser=new Mt(this.taskSeq,{executeTask:async({reqId:t,args:e})=>{switch(e.cmd){case Et.GET_BRANCH_ROUTE:{const s=await this.timelineTree.getBranchRoute(e.leafTime);this.syncChannel.postMessage([t,s])}break;case Et.GET_BRANCH_CHILDREN:{const s=await this.timelineTree.getBranchChildren(e.branchId,e.level);this.syncChannel.postMessage([t,s])}break;case Et.DOWNLOAD_BY_BRANCHID:{const s=await this.timelineTree.getBranchData(e.branchId);this.syncChannel.postMessage([t,s])}break;default:console.error("unknown task cmd:",e)}}}),this._reqIdAcc=1,this._reqMap=new Map,t.onMessage((t=>{var e;if(!Array.isArray(t)||2!==t.length)return;const[s,n]=t;if(n&&"cmd"in n){if(n.cmd===Et.ABORT){const t=this.taskSeq.get(n.reqId);return void(t&&(this.taskSeq.delete(n.reqId),null==(e=t.controller)||e.abort()))}if(n.cmd===Et.REFUSE){const t=this._reqMap.get(n.reqId);return void(t&&t.reject(Tt))}!1===this.taskSeq.push(s,{reqId:s,args:n,controller:void 0})&&this.syncChannel.postMessage([0,{cmd:Et.REFUSE,reqId:s}])}else{const t=this._reqMap.get(s);t&&(this._reqMap.delete(s),t.resolve(n))}})),this.responser.startResponse()}requestMessage(t,e){return new Promise(((s,n)=>{const r=null==e?void 0:e.signal;if(r){const t=n;n=e=>{this._reqMap.delete(a),e!==Tt&&this.syncChannel.postMessage([0,{cmd:Et.ABORT,reqId:a}]),t(e)},r.addEventListener("abort",n);const e=s;s=t=>{r.removeEventListener("abort",n),e(t)}}const a=this._reqIdAcc++;this._reqMap.set(a,{resolve:s,reject:n}),this.syncChannel.postMessage([a,t])}))}async doSync(t=this.timeHelper.now()){const{msgHelper:e,timelineTree:s,dataList:n}=this,r=new Dt,a=[],i=await s.getBranchRoute(t),o=await this.requestMessage({cmd:Et.GET_BRANCH_ROUTE,leafTime:t});i.sort(((t,e)=>e.level-t.level)),o.sort(((t,e)=>e.level-t.level));const c=i[0],h=o[0],{branchId:l,level:d,hash:u}=h;if(c.branchId!==l||c.level!==d)throw new Error(`invalid remote branch info: ${d}(level)/${l}/(branchId) when ${new Date(t).toLocaleString()}`);return 0!==u.length&&!e.signIsSign(c.hash,u)&&(await this._syncBranch(e,s,n,l,d,r,a),a.length>0&&(await(async(t,e,s,n)=>{const r=await e.addManyLeaf(n),a=[],i=[];for(const o of r)!1!==o.success?(a.push({sign:t.getSignature(o.leaf),branchId:o.success.branchId}),i.push(!0)):i.push(!1);return await s.addManyItem(a),i})(e,s,n,a.flat()),!0))}async _syncBranch(t,e,s,n,r,a,i){if(a.has(n,r))return!1;if(0===r){const t=await this.requestMessage({cmd:Et.DOWNLOAD_BY_BRANCHID,branchId:n});if(void 0===t)return!1;const s=[...t.mapData.values()],r=await e.hasManyLeaf(s),a=s.filter(((t,e)=>!1===r[e]));return a.length>0&&(i.push(a),!0)}const o=await this.requestMessage({cmd:Et.GET_BRANCH_CHILDREN,branchId:n,level:r}),c=await e.getBranchChildren(n,r),h=[];for(const[d,u]of o){const e=c.get(d);!1===(void 0!==e&&t.signIsSign(u,e))&&h.push(d)}h.sort();let l=!1;for(const d of h){const n=await this._syncBranch(t,e,s,d,r-1,a,i);l||(l=n)}return l}};Bt.ARGS=It,Bt=t([e(),r(0,a(It.SYNC_CHANNE)),s("design:paramtypes",[Object,"function"==typeof(mt=void 0!==U&&U)?mt:Object,"function"==typeof(_t=void 0!==gt&&gt)?_t:Object,"function"==typeof(bt=void 0!==Z&&Z)?bt:Object,"function"==typeof(vt=void 0!==F&&F)?vt:Object])],Bt);class Dt{constructor(){this._s=new Map}add(t,e){let s=this._s.get(e);void 0===s&&this._s.set(e,s=new Set),s.add(t)}has(t,e){const s=this._s.get(e);return void 0!==s&&s.has(t)}}var Et,St;(St=Et||(Et={}))[St.REFUSE=0]="REFUSE",St[St.ABORT=1]="ABORT",St[St.GET_BRANCH_ROUTE=2]="GET_BRANCH_ROUTE",St[St.GET_BRANCH_CHILDREN=3]="GET_BRANCH_CHILDREN",St[St.DOWNLOAD_BY_BRANCHID=4]="DOWNLOAD_BY_BRANCHID";const Tt=Symbol("reason:refuse by remote");class Ot{constructor(t){this.config=t,this._queue=new Map}push(t,e){if(this._waitter)this._waitter.resolve(e),this._waitter=void 0;else{if(this._queue.has(t))return!1;this._queue.set(t,e)}return!0}get(t){return this._queue.get(t)}has(t){return this._queue.has(t)}delete(t){return this._queue.delete(t)}shift(){if(0===this._queue.size)return(this._waitter=new n).promise;for(const[t,e]of this._queue)return this._queue.delete(t),e;throw 1}}class Mt{constructor(t,e){this.taskSeq=t,this.config=e}async*_ResponseQueue(){for(;;){const e=await this.taskSeq.shift();try{await this.config.executeTask(e)}catch(t){console.error("responser execute task error:",e,t)}yield}}startResponse(){if(void 0!==this._looper)return!1;const t=this._looper=this._ResponseQueue();return(async()=>{for await(const e of t);})().catch((t=>{console.info("responser stoped.",t)})),!0}stopResponse(t){return void 0!==this._looper&&(this._looper.throw(t),this._looper=void 0,!0)}}var Lt,jt,Ht,Nt,kt,Rt,At,xt;let Pt=class{constructor(t,e,s,n,r,a,i,o){this.msgHelper=t,this.config=e,this.timeHelper=s,this.timelineTree=n,this.dataList=r,this.assets=a,this.sync=i,this.storage=o}addMsg(t){return(async(t,e,s,n)=>{const r=await e.addLeaf(n);if(!1!==r){const{branchId:e}=r;return await s.addItem({sign:t.getSignature(n),branchId:e}),!0}return!1})(this.msgHelper,this.timelineTree,this.dataList,t)}async getMsgList(t,e={}){const{offset:s=0,limit:n=40,order:r=wt.DOWN}=e,a=[],i=new Map;let o=0;for await(const h of this.dataList.ItemReader(t,r))if(o<s)++o;else{if(a.length>=n)break;a.push(h),!1===i.has(h.data.branchId)&&i.set(h.data.branchId,this.timelineTree.getBranchData(h.data.branchId))}const c=[];for(const h of a){let t=i.get(h.data.branchId);if(t&&"then"in t&&(t=await t,i.set(h.data.branchId,t)),void 0===t)throw new Error("数据发生了残缺丢失的问题，需要对数据重建索引");const e=this.timelineTree.getLeafFromBranchData(t,h.data.sign);if(void 0===e)throw new Error("数据发生了残缺丢失的问题，可能需要同步数据");c.push({receiptTime:h.insertTime,content:e})}return c}};Pt=t([e(),s("design:paramtypes",["function"==typeof(Lt=void 0!==F&&F)?Lt:Object,"function"==typeof(jt=void 0!==P&&P)?jt:Object,"function"==typeof(Ht=void 0!==X&&X)?Ht:Object,"function"==typeof(Nt=void 0!==U&&U)?Nt:Object,"function"==typeof(kt=void 0!==gt&&gt)?kt:Object,"function"==typeof(Rt=void 0!==st&&st)?Rt:Object,"function"==typeof(At=void 0!==Bt&&Bt)?At:Object,"function"==typeof(xt=void 0!==A&&A)?xt:Object])],Pt);class Ft extends X{now(){return performance.now()+performance.timeOrigin}}var Ct=Object.defineProperty,$t=Object.defineProperties,qt=Object.getOwnPropertyDescriptors,Gt=Object.getOwnPropertySymbols,Wt=Object.prototype.hasOwnProperty,Jt=Object.prototype.propertyIsEnumerable,Ut=(t,e,s)=>e in t?Ct(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;"undefined"!=typeof require&&require;let Yt,zt;const Qt=new WeakMap,Kt=new WeakMap,Vt=new WeakMap,Xt=new WeakMap,Zt=new WeakMap;let te={get(t,e,s){if(t instanceof IDBTransaction){if("done"===e)return Kt.get(t);if("objectStoreNames"===e)return t.objectStoreNames||Vt.get(t);if("store"===e)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return ne(t[e])},set:(t,e,s)=>(t[e]=s,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function ee(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(zt||(zt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(re(this),e),ne(Qt.get(this))}:function(...e){return ne(t.apply(re(this),e))}:function(e,...s){const n=t.call(re(this),e,...s);return Vt.set(n,e.sort?e.sort():[e]),ne(n)}}function se(t){return"function"==typeof t?ee(t):(t instanceof IDBTransaction&&function(t){if(Kt.has(t))return;const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",a),t.removeEventListener("abort",a)},r=()=>{e(),n()},a=()=>{s(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",r),t.addEventListener("error",a),t.addEventListener("abort",a)}));Kt.set(t,e)}(t),e=t,(Yt||(Yt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>e instanceof t))?new Proxy(t,te):t);var e}function ne(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("success",r),t.removeEventListener("error",a)},r=()=>{e(ne(t.result)),n()},a=()=>{s(t.error),n()};t.addEventListener("success",r),t.addEventListener("error",a)}));return e.then((e=>{e instanceof IDBCursor&&Qt.set(e,t)})).catch((()=>{})),Zt.set(e,t),e}(t);if(Xt.has(t))return Xt.get(t);const e=se(t);return e!==t&&(Xt.set(t,e),Zt.set(e,t)),e}const re=t=>Zt.get(t);const ae=["get","getKey","getAll","getAllKeys","count"],ie=["put","add","delete","clear"],oe=new Map;function ce(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(oe.get(e))return oe.get(e);const s=e.replace(/FromIndex$/,""),n=e!==s,r=ie.includes(s);if(!(s in(n?IDBIndex:IDBObjectStore).prototype)||!r&&!ae.includes(s))return;const a=async function(t,...e){const a=this.transaction(t,r?"readwrite":"readonly");let i=a.store;return n&&(i=i.index(e.shift())),(await Promise.all([i[s](...e),r&&a.done]))[0]};return oe.set(e,a),a}te=(t=>{return e=((t,e)=>{for(var s in e||(e={}))Wt.call(e,s)&&Ut(t,s,e[s]);if(Gt)for(var s of Gt(e))Jt.call(e,s)&&Ut(t,s,e[s]);return t})({},t),$t(e,qt({get:(e,s,n)=>ce(e,s)||t.get(e,s,n),has:(e,s)=>!!ce(e,s)||t.has(e,s)}));var e})(te);const he=t=>{const e=t.prototype[Symbol.toStringTag];return{kind:"sequence",resolve:t=>null===t||t.length%2==0,construct(e){const s=new t;for(let t=0;t<e.length;t+=2)s.set(e[t],e[t+1]);return s},represent(s){if(!(s instanceof t))throw new TypeError(`no an ${e}`);const n=new Array(2*s.size);let r=0;for(const t of s)n[r++]=t[0],n[r++]=t[1];return n},predicate:s=>s instanceof t&&s[Symbol.toStringTag]===e}},le=i.DEFAULT_SCHEMA.extend([new o("tag:bfchain.org,2021:js/ordermap",he(Y)),new o("tag:bfchain.org,2021:js/map",he(Map)),new o("tag:bfchain.org,2021:js/set",{kind:"sequence",resolve:t=>!0,construct(t){const e=new Set;for(let s=0;s<t.length;++s)e.add(t[s]);return e},represent(t){if(!(t instanceof Set))throw new TypeError("no an set");return[...t]},predicate:t=>t instanceof Set&&"Set"===t[Symbol.toStringTag]})]),de=new TextDecoder,ue=t=>i.load(de.decode(t),{schema:le}),fe=new TextEncoder,pe=t=>fe.encode(i.dump(t,{schema:le}));class ge extends R{constructor(t){super(),this.currentPaths=t,this._memFolder=new Map}setBinary(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{binary:e})}_makeFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let r=s.get(e);if(void 0===r&&s.set(e,r={folder:new Map}),!("folder"in r))throw new Error("no an paths:"+t);s=r.folder}return s}_getFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let r=s.get(e);if(void 0===r)return;if(!("folder"in r))return;s=r.folder}return s}_getFile(t){let e=this._memFolder;for(let n=0,r=t.length-2;n<=r;n++){const s=t[n],r=e.get(s);if(void 0===r||!("folder"in r))return;e=r.folder}const s=e.get(t[t.length-1]);if(void 0!==s&&!("folder"in s))return s}getBinary(t){const e=this._getFile(t);if(void 0!==e)return"binary"in e?e.binary:e.binary=pe(e.jsobj)}getJsObject(t){const e=this._getFile(t);if(void 0!==e)return"jsobj"in e?e.jsobj.value:(e.jsobj={value:ue(e.binary)}).value}setJsObject(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{jsobj:{value:e}})}has(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&e.has(t[t.length-1])}del(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&(e.clear(),!0)}listPaths(t){const e=this._getFolder(t,t.length-2),s={paths:[],files:[]};if(void 0!==e)for(const[n,r]of e)"folder"in r?s.paths.push(n):s.files.push(n);return s}*WalkFiles(t=[],e=this._memFolder){for(const[s,n]of e){const e=[...t,s];"folder"in n?yield*this.WalkFiles(e,n.folder):yield[e,n]}}}class we{constructor(){this._delPathMap=new Map}addDel(t){let e=this._delPathMap;for(const s of t){let t=e.get(s);void 0===t&&(t=new Map,e.set(s,t)),e=t}e.clear()}isDel(t){let e=this._delPathMap;for(const s of t){const t=e.get(s);if(void 0===t)return!1;if(0===t.size)return!0;e=t}return!1}ls(){const t=(e,s)=>{const n=[];0===s.size&&0!==e.length&&n.push(e);for(const[r,a]of s)n.push(...t([...e,r],a));return n};return t([],this._delPathMap)}}var ye,me,_e,be;(me=ye||(ye={})).PATH_SEP="/",me[me.FILE_TYPE_FLAG=1]="FILE_TYPE_FLAG",me[me.DIR_TYPE_FLAG=2]="DIR_TYPE_FLAG",me.ROOT_DIR=":root:";class ve{constructor(t,e){let s=!1;if("string"==typeof t&&(s=t.trimStart().startsWith("/"),t=t.split(ye.PATH_SEP).map((t=>t.trim()))),void 0!==e){if("string"==typeof e&&(e=e.split(ye.PATH_SEP)),e=ve.normal(e.map((t=>t.trim()))),!1===s){const s=e.concat(t);for(let t=0;t>s.length;++t){".."===s[t]&&(s.splice(t-1,2),t-=2)}t=s}if(e.length>t.length)throw new SyntaxError(`'${t}' no belong to ${e}`);for(let s=0;s<e.length;++s)if(e[s]!==t[s])throw new SyntaxError(`'${t}' no belong to ${e}`)}this.paths=ve.normal(t)}static normal(t){return t.filter((t=>""!==t&&!1===t.endsWith(".")))}get dirname(){const t=this.paths.slice(0,-1);return t.length>0?t.join(ye.PATH_SEP):ye.ROOT_DIR}get basename(){return this.paths[this.paths.length-1]}get fullpath(){return this.paths.join(ye.PATH_SEP)}}(be=_e||(_e={})).FILE="file",be.DIR="dir";const Ie=new Map,Be=t=>{let e=Ie.get(t);return void 0===e&&(e=function(t,e,{blocked:s,upgrade:n,blocking:r,terminated:a}={}){const i=indexedDB.open(t,e),o=ne(i);return n&&i.addEventListener("upgradeneeded",(t=>{n(ne(i.result),t.oldVersion,t.newVersion,ne(i.transaction))})),s&&i.addEventListener("blocked",(()=>s())),o.then((t=>{a&&t.addEventListener("close",(()=>a())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),o}(t,1,{upgrade(t,e,s,n){switch(e){case 0:t.createObjectStore(_e.DIR,{autoIncrement:!1,keyPath:null}).put(new Map,ye.ROOT_DIR),t.createObjectStore(_e.FILE,{autoIncrement:!0,keyPath:null})}}}).then((e=>(Ie.set(t,e),e))),Ie.set(t,e)),e};class De{constructor(t){this.dbName=t,this._idb=Be(this.dbName)}async exists(t){const e=await this._idb,{dirname:s,basename:n}=new ve(t),r=await e.get(_e.DIR,s);return void 0!==r&&r.has(n)}async writeFile(t,e){const s=(await this._idb).transaction([_e.FILE,_e.DIR],"readwrite"),n=s.objectStore(_e.DIR),r=s.objectStore(_e.FILE),{dirname:a,basename:i}=new ve(t),o=await n.get(a);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${a}'`);let c=o.get(i);if(void 0!==c){if(c.type!==ye.FILE_TYPE_FLAG)throw new Error(`EISDIR: illegal operation on a directory, open '${i}'`);c.size=e.length,c.fid}else c={type:ye.FILE_TYPE_FLAG,size:e.length,fid:-1},o.set(i,c);const h=await r.add(e);-1!==c.fid&&await r.delete(c.fid),c.fid=h,await n.put(o,a)}async _mkdir(t,e,s){const{dirname:n,basename:r}=new ve(t);let a=await s.get(n);if(void 0===a){if(!1===e)throw new Error(`ENOENT: no such file or directory, mkdir '${t}'`);a=await this._mkdir(n,e,s)}const i=a.get(r);if((null==i?void 0:i.type)===ye.FILE_TYPE_FLAG)throw new Error(`EEXIST: file already exists, mkdir '${t}'`);let o;return void 0!==i&&(o=await s.get(t)),void 0===o&&(o=new Map,await s.put(o,t),a.set(r,{type:ye.DIR_TYPE_FLAG}),await s.put(a,n)),o}async mkdir(t,e={}){const{recursive:s=!1}=e,n=(await this._idb).transaction(_e.DIR,"readwrite").objectStore(_e.DIR);await this._mkdir(new ve(t).fullpath,s,n)}async readFile(t){const e=(await this._idb).transaction([_e.FILE,_e.DIR],"readwrite"),s=e.objectStore(_e.DIR),n=e.objectStore(_e.FILE),{dirname:r,basename:a}=new ve(t),i=await s.get(r);if(void 0===i)throw new Error(`ENOENT: no such file or directory, open '${r}'`);const o=i.get(a);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${t}'`);if(o.type===ye.DIR_TYPE_FLAG)throw new Error("EISDIR: illegal operation on a directory, read");return await n.get(o.fid)}async _recursive_rmdir(t,e,s){const n=await e.get(t);if(void 0!==n){for(const[r,a]of n)a.type===ye.FILE_TYPE_FLAG?await s.delete(a.fid):this._recursive_rmdir(t+ye.PATH_SEP+r,e,s);await e.delete(t)}}async _rm(t,e,s,n,r){const{dirname:a,basename:i}=new ve(t),o=await n.get(a);let c;if(void 0!==o&&(c=o.get(i)),void 0!==c){if(c.type===ye.FILE_TYPE_FLAG)await r.delete(c.fid);else{if(!1===e)throw new Error(`EISDIR: Path is a directory: '${t}'`);await this._recursive_rmdir(t,n,r)}o.delete(i),await n.put(o,a)}else if(!1===s)throw new Error(`ENOENT: no such file or directory, stat '${t}'`)}async rm(t,e={}){const{recursive:s=!1,force:n=!1}=e,r=(await this._idb).transaction([_e.FILE,_e.DIR],"readwrite"),a=r.objectStore(_e.DIR),i=r.objectStore(_e.FILE);await this._rm(t,s,n,a,i)}async readdir(t){const e=(await this._idb).transaction(_e.DIR,"readwrite").objectStore(_e.DIR),s=await e.get(t);if(void 0===s)throw new Error(`ENOENT: no such file or directory, scandir '${t}'`);return s.entries()}}const Ee={IDB_NAME:Symbol("idbName"),TARGET_DIR:Symbol("targetDir")};let Se=class extends R{constructor(t="usr",e="cryptolalia-tree-fs"){super(),this.targetDir=t,this.idbName=e,this.currentPaths=this.targetDir.split(ye.PATH_SEP).map((t=>t.trim())).filter(Boolean),this._fs=new De(this.idbName)}async setBinary(t,e){const{dirname:s,fullpath:n}=new ve(t,this.currentPaths);!1===await this._fs.exists(s)&&await this._fs.mkdir(s,{recursive:!0}),await this._fs.writeFile(n,e)}async getBinary(t){const{fullpath:e}=new ve(t,this.currentPaths);if(await this._fs.exists(e))return this._fs.readFile(e)}async getJsObject(t){const e=await this.getBinary(t);if(e)return ue(e)}setJsObject(t,e){return this.setBinary(t,pe(e))}async has(t){const{fullpath:e}=new ve(t,this.currentPaths);return await this._fs.exists(e)}async del(t){const{fullpath:e}=new ve(t,this.currentPaths);return!!(await this._fs.exists(e))&&(await this._fs.rm(e,{recursive:!0,force:!0}),!0)}async listPaths(t){const{fullpath:e}=new ve(t,this.currentPaths),s=[],n=[];if(await this._fs.exists(e))for(const[r,a]of await this._fs.readdir(e))try{a.type===ye.FILE_TYPE_FLAG?n.push(r):s.push(r)}catch{}return{paths:s,files:n}}};Se.ARGS=Ee,Se=t([r(0,a(Ee.TARGET_DIR,{optional:!0})),r(1,a(Ee.IDB_NAME,{optional:!0})),s("design:paramtypes",[String,String])],Se);class Te extends R{constructor(t,e="cryptolalia-tree-fs"){super(),this.sourceTargetDir=t,this.idbName=e,this._cacheStore=new ge(["transaction"]),this._targetStore=new Se(this.sourceTargetDir),this._del=new we,this.currentPaths=new ve(this.sourceTargetDir).paths}setBinary(t,e){return this._cacheStore.setBinary(t,e)}async getBinary(t){const e=await this._cacheStore.getBinary(t);return void 0!==e?e:this._del.isDel(t)?void 0:await this._targetStore.getBinary(t)}async getJsObject(t){return await this._cacheStore.has(t)?await this._cacheStore.getJsObject(t):this._del.isDel(t)?void 0:await this._targetStore.getJsObject(t)}setJsObject(t,e){return this._cacheStore.setJsObject(t,e)}async has(t){return!!(await this._cacheStore.has(t))||!this._del.isDel(t)&&await this._targetStore.has(t)}async del(t){return(!1!==await this._cacheStore.del(t)||!this._del.isDel(t))&&(this._del.addDel(t),!0)}listPaths(t){throw new Error("Method not implemented.")}}class Oe extends Se{constructor(){super(...arguments),this._transactionMap=new Map}async startTransaction(t){const e=new ve(t,this.targetDir).fullpath;let s=this._transactionMap.get(e);if(s){const t=new n;s.queue.push(t),await t.promise}const r={transaction:new Te(e),finished:new n,queue:(null==s?void 0:s.queue)||[]};return this._transactionMap.set(e,r),r.finished.onSuccess((()=>{var t;const s=null==(t=r.queue.pop())?void 0:t.resolve;void 0===s?this._transactionMap.delete(e):s()})),r.transaction}async finishTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);if(void 0===e||e.transaction!==t)return!1;for(const n of t._del.ls())await t._targetStore.del(n);const s=t._targetStore;for(const[n,r]of t._cacheStore.WalkFiles())await s.setBinary(n,r.binary||pe(r.jsobj.value));return e.finished.resolve(),!0}requestTransaction(t,e){return(async(t,e,s)=>{const n=await t.startTransaction(e);try{const e=await s(n);return await t.finishTransaction(n),e}catch(r){throw await t.stopTransaction(n),r}})(this,t,e)}async stopTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);return void 0!==e&&e.transaction===t&&(e.finished.resolve(),!0)}fork(t){const e=new ve(t,this.targetDir).fullpath;return new Oe(e)}}class Me extends k{async sha256Binary(t){return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}sha256HashBuilder(){return new Le}}class Le extends class{}{constructor(){super(...arguments),this.chunks=[],this.len=0}update(t){return this.chunks.push(t),this.len+=t.length,this}async digest(){const t=new Uint8Array(this.len);let e=0;for(const s of this.chunks)t.set(s,e),e+=s.length;return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}}const je=new c;h(Ft,je);{class t extends P{branchGroupCount=64;timespan=1e4;startTime=+new Date("2021-9-15")}h(t,je)}{const t=new TextEncoder;class e extends F{getSignature(e){const s=t.encode(JSON.stringify(e)),n=new Uint8Array(32);for(let t=0;t<s.length;++t){const e=t%n.length;n[e]+=s[t];for(let s=(e+1)%n.length;s<n.length;++s)n[s]=t*s+n[e]}return n}getCreateTime(t){return t.time}}h(e,je)}h(Me,je);const He={postMessage(t){},onMessage(t){Ne.postMessage=t}},Ne={postMessage(t){},onMessage(t){He.postMessage=t}},ke=new c([[Bt.ARGS.SYNC_CHANNE,He]],je);h(Oe,ke.installMask(new c([[Oe.ARGS.TARGET_DIR,"user1"]])));const Re=new c([[Bt.ARGS.SYNC_CHANNE,Ne]],je);h(Oe,Re.installMask(new c([[Oe.ARGS.TARGET_DIR,"user2"]])));const Ae=h(Pt,ke),xe=h(Pt,Re);function Pe(t,e,s){const n=t.slice();return n[12]=e[s],n}function Fe(t,e){let s,n,r,a,i,o,c,h,l,d,u,I=new Date(e[12].time).toLocaleTimeString()+"",B=e[12].sender+"",D=e[12].content+"";return{key:t,first:null,c(){s=f("li"),n=f("span"),r=p(I),a=g(),i=f("div"),o=f("address"),c=p(B),h=g(),l=f("p"),d=p(D),u=g(),w(n,"class","time-tip svelte-13s7264"),w(o,"class","avator svelte-13s7264"),w(l,"class","message svelte-13s7264"),w(i,"class","content-area svelte-13s7264"),w(s,"class","item svelte-13s7264"),y(s,"self",e[0](e[12].sender)),this.first=s},m(t,e){m(t,s,e),_(s,n),_(n,r),_(s,a),_(s,i),_(i,o),_(o,c),_(i,h),_(i,l),_(l,d),_(s,u)},p(t,n){e=t,2&n&&I!==(I=new Date(e[12].time).toLocaleTimeString()+"")&&b(r,I),2&n&&B!==(B=e[12].sender+"")&&b(c,B),2&n&&D!==(D=e[12].content+"")&&b(d,D),3&n&&y(s,"self",e[0](e[12].sender))},d(t){t&&v(s)}}}function Ce(t){let e,s,n,r,a,i,o,c,h,l,d=[],u=new Map,p=t[1];const b=t=>t[12].time;for(let f=0;f<p.length;f+=1){let e=Pe(t,p,f),s=b(e);u.set(s,d[f]=Fe(s,e))}return{c(){e=f("ul");for(let t=0;t<d.length;t+=1)d[t].c();s=g(),n=f("div"),r=f("input"),a=g(),i=f("button"),i.textContent="发送",o=g(),c=f("button"),c.textContent="同步",w(e,"class","list svelte-13s7264"),w(r,"type","text"),w(r,"class","word-to-send svelte-13s7264"),r.disabled=t[3],w(r,"placeholder","请输入要发送的内容"),w(i,"class","do-send svelte-13s7264"),y(i,"running",t[3]),w(c,"class","do-sync svelte-13s7264"),y(c,"running",t[4]),w(n,"class","controller-panel svelte-13s7264")},m(u,f){m(u,e,f);for(let t=0;t<d.length;t+=1)d[t].m(e,null);m(u,s,f),m(u,n,f),_(n,r),I(r,t[2]),_(n,a),_(n,i),_(n,o),_(n,c),h||(l=[B(r,"input",t[10]),B(i,"click",t[5]),B(c,"click",t[6])],h=!0)},p(t,[s]){3&s&&(p=t[1],d=D(d,s,b,1,t,p,u,e,O,Fe,null,Pe)),8&s&&(r.disabled=t[3]),4&s&&r.value!==t[2]&&I(r,t[2]),8&s&&y(i,"running",t[3]),16&s&&y(c,"running",t[4])},i:E,o:E,d(t){t&&v(e);for(let e=0;e<d.length;e+=1)d[e].d();t&&v(s),t&&v(n),h=!1,S(l)}}}function $e(t,e,s){var n=this&&this.__awaiter||function(t,e,s,n){return new(s||(s=Promise))((function(r,a){function i(t){try{c(n.next(t))}catch(e){a(e)}}function o(t){try{c(n.throw(t))}catch(e){a(e)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(i,o)}c((n=n.apply(t,e||[])).next())}))};let r=[],a="",i=!1;let o=!1;const c=()=>n(void 0,void 0,void 0,(function*(){if(!o){s(4,o=!0);try{yield l(),s(1,r=yield d())}finally{s(4,o=!1)}}}));let{doSend:h=(t=>{})}=e,{doSync:l=(()=>{})}=e,{getList:d=(()=>[])}=e,{isSelf:u=(t=>!1)}=e;return T(c),t.$$set=t=>{"doSend"in t&&s(7,h=t.doSend),"doSync"in t&&s(8,l=t.doSync),"getList"in t&&s(9,d=t.getList),"isSelf"in t&&s(0,u=t.isSelf)},[u,r,a,i,o,()=>n(void 0,void 0,void 0,(function*(){if(i)return;const t=a.trim();if(0!==t.length){s(3,i=!0);try{yield l(),console.log("do send",t),yield h(t),s(2,a=""),s(1,r=yield d())}finally{s(3,i=!1)}}})),c,h,l,d,function(){a=this.value,s(2,a)}]}class qe extends l{constructor(t){super(),d(this,t,$e,Ce,u,{doSend:7,doSync:8,getList:9,isSelf:0})}}function Ge(t){let e,s,n,r,a,i,o;return n=new qe({props:{doSend:t[0],doSync:t[2],getList:t[4],isSelf:t[6]}}),i=new qe({props:{doSend:t[1],doSync:t[3],getList:t[5],isSelf:t[7]}}),{c(){e=f("main"),s=f("section"),M(n.$$.fragment),r=g(),a=f("section"),M(i.$$.fragment),w(s,"class","chat-panel panel-1 svelte-1e9ucnz"),w(a,"class","chat-panel panel-2 svelte-1e9ucnz"),w(e,"class","chat-panels svelte-1e9ucnz")},m(t,c){m(t,e,c),_(e,s),L(n,s,null),_(e,r),_(e,a),L(i,a,null),o=!0},p:E,i(t){o||(j(n.$$.fragment,t),j(i.$$.fragment,t),o=!0)},o(t){H(n.$$.fragment,t),H(i.$$.fragment,t),o=!1},d(t){t&&v(e),N(n),N(i)}}}function We(t){var e=this&&this.__awaiter||function(t,e,s,n){return new(s||(s=Promise))((function(r,a){function i(t){try{c(n.next(t))}catch(e){a(e)}}function o(t){try{c(n.throw(t))}catch(e){a(e)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(i,o)}c((n=n.apply(t,e||[])).next())}))};const s=(t,e)=>s=>e.addMsg({content:s,sender:t,time:Date.now()}),n=t=>()=>e(void 0,void 0,void 0,(function*(){console.group("do sync"),yield t.sync.doSync(),console.groupEnd()})),r=t=>()=>e(void 0,void 0,void 0,(function*(){const e=[];for(const s of yield t.getMsgList(Date.now(),{offset:0,limit:100,order:-1}))e.push(s.content);return e}));return[s("user1",Ae),s("user2",xe),n(Ae),n(xe),r(Ae),r(xe),t=>"user1"===t,t=>"user2"===t]}class Je extends l{constructor(t){super(),d(this,t,We,Ge,u,{})}}function Ue(t){let e,s,n,r,a;return r=new Je({}),{c(){e=f("h1"),e.textContent="Cryptolalia Demo",s=g(),n=f("main"),M(r.$$.fragment),w(e,"class","svelte-2ce7vr"),w(n,"class","svelte-2ce7vr")},m(t,i){m(t,e,i),m(t,s,i),m(t,n,i),L(r,n,null),a=!0},p:E,i(t){a||(j(r.$$.fragment,t),a=!0)},o(t){H(r.$$.fragment,t),a=!1},d(t){t&&v(e),t&&v(s),t&&v(n),N(r)}}}new class extends l{constructor(t){super(),d(this,t,null,Ue,u,{})}}({target:document.getElementById("app")});
