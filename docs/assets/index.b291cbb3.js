import{S as t,i as e,s,e as n,t as i,a as r,b as a,c as o,d as c,f as l,g as h,h as d,j as u,k as p,l as g,m as f,n as y,o as m,p as _,q as w,u as v,r as b,v as I,w as S,x as M,_ as E,y as D,z as B,A as T,B as L,C as $,$ as O,L as C,F as j,D as k,E as N,T as H,G as x,H as A,I as R,J as P,K as F,M as G,N as q,O as U,P as z,Q as J,R as W,U as Y,V as Q,W as K,X as V,Y as X,Z,a0 as tt,a1 as et,a2 as st,a3 as nt,a4 as it}from"./vendor.0ce9b234.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();function rt(t,e,s){const n=t.slice();return n[16]=e[s],n[18]=s,n}function at(t,e){let s,_,w,v,b,I,S,M,E,D,B,T,L,$,O,C=new Date(e[16].time).toLocaleTimeString()+"",j=e[16].sender+"",k=e[16].content+"";return{key:t,first:null,c(){s=n("li"),_=n("span"),w=i(C),v=r(),b=n("div"),I=n("address"),S=i(j),M=r(),E=n("p"),D=i(k),B=r(),a(_,"class","time-tip svelte-ahpgzm"),a(I,"class","avator svelte-ahpgzm"),a(E,"class","message svelte-ahpgzm"),a(b,"class","content-area svelte-ahpgzm"),a(s,"class","item svelte-ahpgzm"),o(s,"self",e[0](e[16].sender)),this.first=s},m(t,n){c(t,s,n),l(s,_),l(_,w),l(s,v),l(s,b),l(b,I),l(I,S),l(b,M),l(b,E),l(E,D),l(s,B),$||(O=h(T=ct.call(null,s,0===e[18]?{introend:e[14]}:{})),$=!0)},p(t,n){e=t,2&n&&C!==(C=new Date(e[16].time).toLocaleTimeString()+"")&&d(w,C),2&n&&j!==(j=e[16].sender+"")&&d(S,j),2&n&&k!==(k=e[16].content+"")&&d(D,k),T&&u(T.update)&&18&n&&T.update.call(null,0===e[18]?{introend:e[14]}:{}),3&n&&o(s,"self",e[0](e[16].sender))},i(t){L||p((()=>{L=g(s,f,{delay:100*Math.log2(e[18]+1),duration:300,y:e[4]?-50:50,opacity:0}),L.start()}))},o:y,d(t){t&&m(s),$=!1,O()}}}function ot(t){let e,s,i,h,d,u,p,g,f,S,E,D,B,T=[],L=new Map,$=t[1];const O=t=>t[16].time;for(let n=0;n<$.length;n+=1){let e=rt(t,$,n),s=O(e);L.set(s,T[n]=at(s,e))}return{c(){e=n("ul");for(let t=0;t<T.length;t+=1)T[t].c();s=r(),i=n("div"),h=n("input"),d=r(),u=n("button"),u.textContent="发送",p=r(),g=n("div"),f=n("button"),f.textContent="同步",S=r(),E=n("button"),E.textContent="清空",a(e,"class","list svelte-ahpgzm"),o(e,"syncing",t[5]),a(h,"type","text"),a(h,"class","word-to-send svelte-ahpgzm"),h.disabled=t[3],a(h,"placeholder","请输入要发送的内容"),a(u,"class","do-send svelte-ahpgzm"),o(u,"activing",t[3]),a(i,"class","msgcontroller-panel svelte-ahpgzm"),a(f,"class","do-sync svelte-ahpgzm"),o(f,"activing",t[5]),a(E,"class","do-sync svelte-ahpgzm"),o(E,"activing",t[5]),a(g,"class","controller-panel svelte-ahpgzm")},m(n,r){c(n,e,r);for(let t=0;t<T.length;t+=1)T[t].m(e,null);c(n,s,r),c(n,i,r),l(i,h),_(h,t[2]),l(i,d),l(i,u),c(n,p,r),c(n,g,r),l(g,f),l(g,S),l(g,E),D||(B=[w(h,"input",t[15]),w(u,"click",t[6]),w(f,"click",t[7]),w(E,"click",t[8])],D=!0)},p(t,[s]){19&s&&($=t[1],T=v(T,s,O,1,t,$,L,e,M,at,null,rt)),32&s&&o(e,"syncing",t[5]),8&s&&(h.disabled=t[3]),4&s&&h.value!==t[2]&&_(h,t[2]),8&s&&o(u,"activing",t[3]),32&s&&o(f,"activing",t[5]),32&s&&o(E,"activing",t[5])},i(t){for(let e=0;e<$.length;e+=1)b(T[e])},o:y,d(t){t&&m(e);for(let e=0;e<T.length;e+=1)T[e].d();t&&m(s),t&&m(i),t&&m(p),t&&m(g),D=!1,I(B)}}}function ct(t,e){const s=Object.entries(e).map((([e,s])=>[e,t.addEventListener(e,s)]));return{destroy(){s.forEach((([e,s])=>{t.removeEventListener(e,s)}))}}}function lt(t,e,s){let n=[],i="",r=!1;let a=!0,o=!1;const c=()=>E(void 0,void 0,void 0,(function*(){if(!o){s(5,o=!0);try{yield h(),s(1,n=yield d())}finally{s(5,o=!1)}}}));let{doSend:l=(t=>{})}=e,{doSync:h=(()=>{})}=e,{getList:d=(()=>[])}=e,{doClear:u=(()=>{})}=e,{isSelf:p=(t=>!1)}=e;S(c);return t.$$set=t=>{"doSend"in t&&s(9,l=t.doSend),"doSync"in t&&s(10,h=t.doSync),"getList"in t&&s(11,d=t.getList),"doClear"in t&&s(12,u=t.doClear),"isSelf"in t&&s(0,p=t.isSelf)},[p,n,i,r,a,o,()=>E(void 0,void 0,void 0,(function*(){if(r)return;const t=i.trim();if(0!==t.length){s(3,r=!0);try{yield h(),console.log("do send",t),yield l(t),s(2,i=""),s(1,n=yield d())}finally{s(3,r=!1)}}})),c,()=>E(void 0,void 0,void 0,(function*(){s(5,o=!0);try{yield u(),s(1,n=yield d())}finally{s(5,o=!1)}})),l,h,d,u,()=>c(),()=>s(4,a=!1),function(){i=this.value,s(2,i)}]}class ht extends t{constructor(t){super(),e(this,t,lt,ot,s,{doSend:9,doSync:10,getList:11,doClear:12,isSelf:0,onListChanged:13})}get onListChanged(){return this.$$.ctx[13]}}let dt=class{};dt=D([B()],dt);let ut=class{};ut=D([B()],ut);class pt extends ut{}const gt=(t,e,s)=>(n,i,r)=>{const a=r.value;if("function"!=typeof a)throw new TypeError;const o=async function(...n){const i=new L;this[s]=i.promise;const r=a.apply(this,n);return this[e].requestTransaction(t,(t=>(i.resolve(t),r)))};return Reflect.set(o,"source",a),r.value=o,r};let ft=class{calcBranchId(t){const e=t-this.startTime;if(e<0)throw new RangeError("invald time: "+t);let s=e/this.timespan;return s%1==0&&(s+=1),Math.ceil(s)}calcNextBranchId(t){let e=t/this.branchGroupCount;return e%1==0&&(e+=1),Math.ceil(e)}calcBranchIdRange(t){const e=(t-1)*this.branchGroupCount;return{start:e+1,end:e+this.branchGroupCount}}};ft=D([B()],ft);let yt=class{msgIsSign(t,e){return this.signIsSign(this.getSignature(t),e)}signIsSign(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0}compareMessage(t,e){const s=this.getCreateTime(t),n=this.getCreateTime(e);if(s<n)return-1;if(s>n)return 1;const i=this.getSignature(t),r=this.getSignature(e);if(i.length<r.length)return-1;if(i.length>r.length)return 1;for(let a=0;a<i.length;++a){const t=i[a],e=r[a];if(t<e)return-1;if(t>e)return 1}return 0}};var mt,_t,wt,vt,bt,It;yt=D([B()],yt);let St=class{constructor(t,e,s,n){this.config=t,this.cryptoHelper=e,this.messageHelper=n,this._store=s.fork(["timeline"])}async addLeaf(t){return this._addLeaf(t,await this._trs)}async hasManyLeaf(t){const e=await this._trs;return this._batchHas(t,e)}async _batchHas(t,e){const{messageHelper:s}=this,n=[],i=new Map;for(const r of t){const t=this.config.calcBranchId(s.getCreateTime(r));let a=i.get(t);if(void 0===a&&(a=await e.getJsObject(["blocks",`block-${t}`])||null,i.set(t,a)),null!==a){const t=s.getSignature(r),e=Bt(t,a.indexedDigit),i=a.mapData.get(e);if(void 0!==i){n.push(s.msgIsSign(i,t));continue}}n.push(!1)}return n}async _addLeaf(t,e){const{messageHelper:s}=this,n=s.getCreateTime(t),i=this.config.calcBranchId(n),r=["blocks",`block-${i}`],a=await e.getJsObject(r)||{indexedDigit:8,mapData:new Mt},o=s.getSignature(t);do{const e=Bt(o,a.indexedDigit),n=a.mapData.get(e);if(void 0===n){a.mapData.set(e,t);break}if(s.msgIsSign(n,o))return!1;if(256===a.indexedDigit)throw console.error("signature should be equal",o,n),new Error("out of indexedDigit");const i=a.indexedDigit=2*a.indexedDigit,r=new Map;for(const t of a.mapData.values())r.set(Bt(s.getSignature(t),i),t);a.mapData=r}while(a.indexedDigit<=256);let c=0,l=0,h=i;const d=[];do{++c,l=this.config.calcNextBranchId(h),d.unshift({paths:["tree-hash",`level-${c}`,`branch-${l}`],dirtyBranchId:h}),h=l}while(1!==l);for(const u of d){let t=await e.getJsObject(u.paths);if(void 0!==t){if(t.subDirty.has(u.dirtyBranchId))continue;t.dirty=!0,t.subDirty.add(u.dirtyBranchId),t.subHash.delete(u.dirtyBranchId)}else t={hash:Tt,dirty:!0,subDirty:new Set([u.dirtyBranchId]),subHash:new Map};await e.setJsObject(u.paths,t)}return await e.setJsObject(r,a),{branchId:i}}async addManyLeaf(t){const e=await this._trs,s=[];for(const n of t)s.push({success:await this._addLeaf(n,e),leaf:n});return s}getLeafFromBranchData(t,e){const s=Bt(e,t.indexedDigit),n=t.mapData.get(s);if(n&&this.messageHelper.msgIsSign(n,e))return n}async getBranchData(t){const e=["blocks",`block-${t}`];return this._store.getJsObject(e)}async _getBlockHash(t){const e=await this._store.getBinary(["blocks",`block-${t}`]);return e?await this.cryptoHelper.sha256Binary(e):Tt}async _getBranchHash(t,e,s){if(0===s){const s=["level-1",`branch-${this.config.calcNextBranchId(e)}`],n=await t.getJsObject(s);if(void 0===n)return Tt;const i=n.subDirty.has(e)||n.subHash.get(e);let r=Tt;return!0===i?(r=await this._getBlockHash(e),0===r.length?n.subHash.delete(e):n.subHash.set(e,r),n.subDirty.delete(e),await t.setJsObject(s,n)):void 0!==i&&(r=i),r}const n=[`level-${s}`,`branch-${e}`],i=await t.getJsObject(n);if(void 0===i)return Tt;if(!1===i.dirty)return i.hash;if(0!==i.subDirty.size){const e=s-1;if(0===e)for(const t of i.subDirty){const e=await this._getBlockHash(t);0===e.length?i.subHash.delete(t):i.subHash.set(t,e)}else for(const s of i.subDirty){const n=await this._getBranchHash(t,s,e);0===n.length?i.subHash.delete(s):i.subHash.set(s,n)}i.subDirty.clear()}const r=[...i.subHash].sort(((t,e)=>t[0]-e[0]));switch(r.length){case 0:i.hash=Tt;break;case 1:i.hash=r[0][1];break;default:const t=this.cryptoHelper.sha256HashBuilder();for(const e of r)t.update(e[1]);i.hash=await t.digest()}return i.dirty=!1,await t.setJsObject(n,i),i.hash}async getBranchRoute(t){const e=await this._trs_th;let s=0,n=this.config.calcBranchId(t);const i=[{level:s,branchId:n,hash:await this._getBranchHash(e,n,s)}];for(;1!==n;)n=this.config.calcNextBranchId(n),s+=1,i.push({level:s,branchId:n,hash:await this._getBranchHash(e,n,s)});return i}async getBranchChildren(t,e){const s=await this._trs_th;if(e<1)throw new RangeError(`invalid branch level: ${e} when get branch(${t})`);const n=await s.getJsObject([`level-${e}`,`branch-${t}`]),i=new Map;if(void 0!==n){const t=e-1;for(const e of[...n.subDirty,...n.subHash.keys()]){const n=await this._getBranchHash(s,e,t);0!==n.length&&i.set(e,n)}}return i}};D([gt([],"_store","_trs"),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",Promise)],St.prototype,"addLeaf",null),D([gt([],"_store","_trs"),T("design:type",Function),T("design:paramtypes",["function"==typeof(mt="undefined"!=typeof Iterable&&Iterable)?mt:Object]),T("design:returntype",Promise)],St.prototype,"hasManyLeaf",null),D([gt([],"_store","_trs"),T("design:type",Function),T("design:paramtypes",["function"==typeof(_t="undefined"!=typeof Iterable&&Iterable)?_t:Object]),T("design:returntype",Promise)],St.prototype,"addManyLeaf",null),D([gt(["tree-hash"],"_store","_trs_th"),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",Promise)],St.prototype,"getBranchRoute",null),D([gt(["tree-hash"],"_store","_trs_th"),T("design:type",Function),T("design:paramtypes",[Number,Number]),T("design:returntype",Promise)],St.prototype,"getBranchChildren",null),St=D([B(),T("design:paramtypes",["function"==typeof(wt=void 0!==ft&&ft)?wt:Object,"function"==typeof(vt=void 0!==dt&&dt)?vt:Object,"function"==typeof(bt=void 0!==pt&&pt)?bt:Object,"function"==typeof(It=void 0!==yt&&yt)?It:Object])],St);class Mt extends Map{constructor(){super(...arguments),this._okl=[]}get[Symbol.toStringTag](){return"OrderMap"}set(t,e){if(Number.isNaN(t))throw new TypeError("order-map's key must be finite number");const s=this.size;return super.set(t,e),this.size!==s&&(this._okl.push(t),this._okl.sort()),this}delete(t){return!!super.delete(t)&&(this._okl.splice(this._okl.indexOf(t)),!0)}keys(){return this._okl[Symbol.iterator]()}*entries(){for(const t of this._okl)yield[t,this.get(t)]}[Symbol.iterator](){return this.entries()}toMap(){return new Map(this)}static fromMap(t){const e=new Mt(t);return e._okl=[...t.keys()].sort(),e}}const Et=(t,e)=>{switch(e){case 8:return t[0]||0;case 16:return((t[0]||0)<<8)+(t[1]||0);case 32:return(Et(t,16)<<16)+Et(t.slice(16),16)}},Dt=(t,e)=>{switch(e){case 64:return(BigInt(Et(t,32))<<32n)+BigInt(Et(t.slice(32),32));case 128:return(BigInt(Dt(t,64))<<64n)+BigInt(Dt(t.slice(64),64));case 256:return(BigInt(Dt(t,128))<<128n)+BigInt(Dt(t.slice(128),128))}},Bt=(t,e)=>e<=32?Et(t,e):Dt(t,e),Tt=new Uint8Array(0);let Lt=class{max(t,e=this.now()){return t>=e?t:e}};Lt=D([B()],Lt);class $t extends Lt{now(){return Date.now()}}const Ot=(t,e,s)=>{const n=t.getJsObject(e);return void 0!==n&&"then"in n?n.then((t=>s(t))):s(n)};var Ct;let jt=class{constructor(t){this.storage=t}addAudio(t){this.storage.setBinary(["assets","audio"],t)}addVideo(t){this.storage.setBinary(["assets","video"],t)}addDocument(t){this.storage.setBinary(["assets","document"],t)}addPicture(t){this.storage.setBinary(["assets","picture"],t)}addCode(t){this.storage.setBinary(["assets","code"],t)}async addFile(t){this.storage.setBinary(["assets",t.type],new Uint8Array(await t.arrayBuffer()))}};var kt,Nt,Ht,xt,At,Rt,Pt,Ft;jt=D([B(),T("design:paramtypes",["function"==typeof(Ct=void 0!==pt&&pt)?Ct:Object])],jt);const Gt=(t,e)=>t<e?-1:t>e?1:0,qt=(t,e)=>t<e?1:t>e?-1:0;let Ut=class{constructor(t,e){this.config=t,this.timeHelper=e,this._cache=new Map}getDataList(t,e){const s=[`receipt-${e}`];let n=this._cache.get(e);if(!n&&(n={lastUpdateTime:this.timeHelper.now(),dataList:Ot(t,s,(t=>t||[]))},this._cache.set(e,n),this._cache.size>3)){const t=this.timeHelper.now();for(const[e,s]of this._cache){if(s.lastUpdateTime+1e4>t)break;void 0===s.writerQueue&&this._cache.delete(e)}}return n.dataList}setDataList(t,e,s){let n=this._cache.get(e);const i=this.timeHelper.now();n?(this._cache.delete(e),n.lastUpdateTime=i,n.dataList=s):n={dataList:s,lastUpdateTime:i},this._cache.set(e,n);let r=n.writerQueue;if(void 0===r){r=n.writerQueue=new L;const s=n,i=r;queueMicrotask((async()=>{const n=[`receipt-${e}`];s.writerQueue=void 0;try{await t.setJsObject(n,s.dataList),i.resolve()}catch(r){i.reject(r)}}))}return r.promise}_getBranchMetaGroup(t,e){var s;if((null==(s=this._metaCache)?void 0:s.groupId)!==e){this._metaCache={groupId:e,cache:void 0};const s=this._metaCache;s.cache=Ot(t,["meta-branch",`group-${e}`],(t=>(s.cache=t,t)))}return this._metaCache.cache}_setBranchMetaGroup(t,e,s){return this._metaCache={groupId:e,cache:s},t.setJsObject(["meta-branch",`group-${e}`],s)}async getBranchMeta(t,e){const s=this.config.calcNextBranchId(e),n=await this._getBranchMetaGroup(t,s);return null==n?void 0:n.map.get(e)}async setBranchMeta(t,e,s){const n=this.config.calcNextBranchId(e),i=await this._getBranchMetaGroup(t,n)||{groupId:n,map:new Map};return i.map.set(e,s),this._setBranchMetaGroup(t,n,i)}async upsertBranchMeta(t,e,s){const n=await this.getBranchMeta(t,e)||{preBranchId:e,nextBranchId:e};return this.setBranchMeta(t,e,Object.assign(n,s))}async*BranchIdWalker(t,e,s=Wt.UP){const n=this.config.calcNextBranchId(e);let i;if(i=await this._getBranchMetaGroup(t,n),void 0===i){const{files:e}=await t.listPaths(["meta-branch"]),r=[];for(const t of e)t.startsWith("group-")&&r.push(+t.slice(6));r.sort(s===Wt.DOWN?qt:Gt);let a=r.findIndex((t=>Gt(n,t)!==s));if(-1===a)return;for(;a<r.length;){const e=r[a];if(i=await this._getBranchMetaGroup(t,e),void 0!==i)break;console.error(new Error(`数据库异常，可能发生数据丢失(${t.currentPaths}, ${["meta-branch",`group-${e}`]})`)),a++}}for(;;){if(void 0===i)return;const n=[...i.map.keys()].sort(s===Wt.DOWN?qt:Gt);if(0===n.length)throw new Error(`数据库异常，可能是数据丢失，索引断链，需要重新整理数据重建索引(${t.currentPaths}, ${i.groupId})`);let r=n.findIndex((t=>qt(e,t)===s));if(-1!==r)do{yield n[r]}while(++r<n.length);const a=i.map.get(n[n.length-1]),o=s===Wt.UP?a.nextBranchId:a.preBranchId,c=this.config.calcNextBranchId(o);if(c===i.groupId)return;i=await this._getBranchMetaGroup(t,c)}}};Ut=D([B(),T("design:paramtypes",["function"==typeof(kt=void 0!==ft&&ft)?kt:Object,"function"==typeof(Nt=void 0!==$t&&$t)?Nt:Object])],Ut);let zt=class{constructor(t,e,s){this.config=t,this.timeHelper=e,this._branchHanlder=s}getMeta(t){return void 0===this._meta&&(this._meta=Ot(t,["meta"],(async e=>(e&&(0!==e.firstBranchId&&0===(await this._branchHanlder.getDataList(t,e.firstBranchId)).length&&(e.firstBranchId=0),e.lastBranchId!==e.secondLastBranchId&&0===(await this._branchHanlder.getDataList(t,e.lastBranchId)).length&&(e.lastBranchId=e.secondLastBranchId)),this._meta=null!=e?e:{firstBranchId:0,lastBranchId:0,secondLastBranchId:0})))),this._meta}setMeta(t,e){return t.setJsObject(["meta"],e)}};zt=D([B(),T("design:paramtypes",["function"==typeof(Ht=void 0!==ft&&ft)?Ht:Object,"function"==typeof(xt=void 0!==$t&&$t)?xt:Object,Ut])],zt);let Jt=class{constructor(t,e,s,n,i){this.config=t,this.timeHelper=e,this._branchHanlder=n,this._metaHanlder=i,this._perNow=0,this._store=s.fork(["datalist"])}async _upsertMetaWhenAddNewItem(t,e){const s=await this._metaHanlder.getMeta(t);let n=0;if(0===s.firstBranchId)s.firstBranchId=e,s.secondLastBranchId=e,s.lastBranchId=e;else{if(!(s.lastBranchId<e)){if(s.lastBranchId===e)return;throw new Error("NOSUPPORT: new-branchId should not less then last-branchId")}n=s.secondLastBranchId=s.lastBranchId,s.lastBranchId=e}await this._metaHanlder.setMeta(t,s),0!==n&&await this._branchHanlder.upsertBranchMeta(t,n,{nextBranchId:e}),await this._branchHanlder.setBranchMeta(t,e,{preBranchId:n,nextBranchId:e})}async addItem(t,e=this.timeHelper.now()){const s=this.timeHelper.max(this._perNow+1,e);this._perNow=s;const n=this.config.calcBranchId(s),i=await this._trs;await this._upsertMetaWhenAddNewItem(i,n);const r=await this._branchHanlder.getDataList(i,n);return r.push({insertTime:s,data:t}),await this._branchHanlder.setDataList(i,n,r),e}async addManyItem(t,e=this.timeHelper.now()){const s=await this._trs;let n,i=0;const r=[];for(const a of t){const t=this.timeHelper.max(this._perNow+1,e);r.push(t),this._perNow=t;const o=this.config.calcBranchId(t);o!==i&&(await this._upsertMetaWhenAddNewItem(s,o),void 0!==n&&(await this._branchHanlder.setDataList(s,i,n),n=void 0),i=o),void 0===n&&(n=await this._branchHanlder.getDataList(s,o)),n.push({insertTime:t,data:a})}return n&&await this._branchHanlder.setDataList(s,i,n),r}async*ItemReader(t,e=Wt.UP){let s,n=this.config.calcBranchId(t);for(;;){const i=await this._branchHanlder.getDataList(this._store,n);let r=0,a=i.length;if(0!==i.length)for(e===Wt.DOWN&&(r=a-1,a=-1);r!==a;){const s=i[r];Gt(t,s.insertTime)!==e&&(yield s),r+=e}null!=s||(s=this._branchHanlder.BranchIdWalker(this._store,n,e));const o=await s.next();if(o.done)return;n=o.value}}};var Wt,Yt,Qt,Kt,Vt,Xt,Zt,te;D([gt([],"_store","_trs"),T("design:type",Function),T("design:paramtypes",[Object,Object]),T("design:returntype",Promise)],Jt.prototype,"addItem",null),D([gt([],"_store","_trs"),T("design:type",Function),T("design:paramtypes",["function"==typeof(At="undefined"!=typeof Iterable&&Iterable)?At:Object,Object]),T("design:returntype",Promise)],Jt.prototype,"addManyItem",null),Jt=D([B(),T("design:paramtypes",["function"==typeof(Rt=void 0!==ft&&ft)?Rt:Object,"function"==typeof(Pt=void 0!==$t&&$t)?Pt:Object,"function"==typeof(Ft=void 0!==pt&&pt)?Ft:Object,Ut,zt])],Jt),(Yt=Wt||(Wt={}))[Yt.UP=1]="UP",Yt[Yt.DOWN=-1]="DOWN";const ee={SYNC_CHANNE:Symbol("syncChannnel")};let se=class{constructor(t,e,s,n,i,r){this.syncChannel=t,this.timelineTree=e,this.dataList=s,this.timeHelper=n,this.msgHelper=i,this.config=r,this.taskSeq=new oe({}),this.responser=new ce(this.taskSeq,{executeTask:async({reqId:t,args:e})=>{switch(e.cmd){case ie.GET_BRANCH_ROUTE:{const s=await this.timelineTree.getBranchRoute(e.leafTime);this.syncChannel.postMessage([t,s])}break;case ie.GET_BRANCH_CHILDREN:{const s=await this.timelineTree.getBranchChildren(e.branchId,e.level);this.syncChannel.postMessage([t,s])}break;case ie.DOWNLOAD_BY_BRANCHID:{const s=await this.timelineTree.getBranchData(e.branchId);this.syncChannel.postMessage([t,s])}break;default:console.error("unknown task cmd:",e)}}}),this._reqIdAcc=1,this._reqMap=new Map,t.onMessage=t=>{var e;if(!Array.isArray(t)||2!==t.length)return;const[s,n]=t;if(n!==ie.ABORT)if(n!==ie.REFUSE)if(n&&"cmd"in n)!1===this.taskSeq.push(s,{reqId:s,args:n,controller:void 0})&&this.syncChannel.postMessage([s,ie.REFUSE]);else{const t=this._reqMap.get(s);t&&(this._reqMap.delete(s),t.resolve(n))}else{const t=this._reqMap.get(s);t&&t.reject(ae)}else{const t=this.taskSeq.get(s);t&&(this.taskSeq.delete(s),null==(e=t.controller)||e.abort())}},this.responser.startResponse()}requestMessage(t,e){return new Promise(((s,n)=>{const i=null==e?void 0:e.signal;if(i){const t=n;n=e=>{this._reqMap.delete(r),e!==ae&&this.syncChannel.postMessage([r,ie.ABORT]),t(e)},i.addEventListener("abort",n);const e=s;s=t=>{i.removeEventListener("abort",n),e(t)}}const r=this._reqIdAcc++;this._reqMap.set(r,{resolve:s,reject:n}),this.syncChannel.postMessage([r,t])}))}async doSync(t=this.timeHelper.now()){const{msgHelper:e,timelineTree:s,dataList:n}=this,i=new ne,r=[],a=await s.getBranchRoute(t),o=await this.requestMessage({cmd:ie.GET_BRANCH_ROUTE,leafTime:t});a.sort(((t,e)=>e.level-t.level)),o.sort(((t,e)=>e.level-t.level));const c=a[0],l=o[0],{branchId:h,level:d,hash:u}=l;if(c.branchId!==h||c.level!==d)throw new Error(`invalid remote branch info: ${d}(level)/${h}/(branchId) when ${new Date(t).toLocaleString()}`);return 0!==u.length&&!e.signIsSign(c.hash,u)&&(await this._syncBranch(e,s,n,h,d,i,r),r.length>0&&(await(async(t,e,s,n)=>{const i=await e.addManyLeaf(n),r=[],a=[];for(const o of i)!1!==o.success?(r.push({sign:t.getSignature(o.leaf),branchId:o.success.branchId}),a.push(!0)):a.push(!1);return await s.addManyItem(r),a})(e,s,n,r.flat()),!0))}async _syncBranch(t,e,s,n,i,r,a){if(r.has(n,i))return!1;if(0===i){const t=await this.requestMessage({cmd:ie.DOWNLOAD_BY_BRANCHID,branchId:n});if(void 0===t)return!1;const s=[...t.mapData.values()],i=await e.hasManyLeaf(s),r=s.filter(((t,e)=>!1===i[e]));return r.length>0&&(a.push(r),!0)}const o=await this.requestMessage({cmd:ie.GET_BRANCH_CHILDREN,branchId:n,level:i}),c=await e.getBranchChildren(n,i),l=[];for(const[d,u]of o){const e=c.get(d);!1===(void 0!==e&&t.signIsSign(u,e))&&l.push(d)}l.sort();let h=!1;for(const d of l){const n=await this._syncBranch(t,e,s,d,i-1,r,a);h||(h=n)}return h}};se.ARGS=ee,se=D([B(),$(0,O(ee.SYNC_CHANNE)),T("design:paramtypes",["function"==typeof(Qt=void 0!==se&&se.Channel)?Qt:Object,"function"==typeof(Kt=void 0!==St&&St)?Kt:Object,"function"==typeof(Vt=void 0!==Jt&&Jt)?Vt:Object,"function"==typeof(Xt=void 0!==$t&&$t)?Xt:Object,"function"==typeof(Zt=void 0!==yt&&yt)?Zt:Object,"function"==typeof(te=void 0!==ft&&ft)?te:Object])],se);class ne{constructor(){this._s=new Map}add(t,e){let s=this._s.get(e);void 0===s&&this._s.set(e,s=new Set),s.add(t)}has(t,e){const s=this._s.get(e);return void 0!==s&&s.has(t)}}var ie,re;(re=ie||(ie={}))[re.REFUSE=0]="REFUSE",re[re.ABORT=1]="ABORT",re[re.GET_BRANCH_ROUTE=2]="GET_BRANCH_ROUTE",re[re.GET_BRANCH_CHILDREN=3]="GET_BRANCH_CHILDREN",re[re.DOWNLOAD_BY_BRANCHID=4]="DOWNLOAD_BY_BRANCHID";const ae=Symbol("reason:refuse by remote");class oe{constructor(t){this.config=t,this._queue=new Map}push(t,e){if(this._waitter)this._waitter.resolve(e),this._waitter=void 0;else{if(this._queue.has(t))return!1;this._queue.set(t,e)}return!0}get(t){return this._queue.get(t)}has(t){return this._queue.has(t)}delete(t){return this._queue.delete(t)}shift(){if(0===this._queue.size)return(this._waitter=new L).promise;for(const[t,e]of this._queue)return this._queue.delete(t),e;throw 1}}class ce{constructor(t,e){this.taskSeq=t,this.config=e}async*_ResponseQueue(){for(;;){const e=await this.taskSeq.shift();try{await this.config.executeTask(e)}catch(t){console.error("responser execute task error:",e,t)}yield}}startResponse(){if(void 0!==this._looper)return!1;const t=this._looper=this._ResponseQueue();return(async()=>{for await(const e of t);})().catch((t=>{console.info("responser stoped.",t)})),!0}stopResponse(t){return void 0!==this._looper&&(this._looper.throw(t),this._looper=void 0,!0)}}var le,he,de,ue,pe,ge,fe,ye;let me=class{constructor(t,e,s,n,i,r,a,o){this.msgHelper=t,this.config=e,this.timeHelper=s,this.timelineTree=n,this.dataList=i,this.assets=r,this.sync=a,this.storage=o}addMsg(t){return(async(t,e,s,n)=>{const i=await e.addLeaf(n);if(!1!==i){const{branchId:e}=i;return await s.addItem({sign:t.getSignature(n),branchId:e}),!0}return!1})(this.msgHelper,this.timelineTree,this.dataList,t)}$getMsgListOptionsToQuery(t={}){const{offset:e=0,limit:s=40,order:n=Wt.DOWN}=t;return{offset:e,limit:s,order:n}}async getMsgList(t,e={}){const{offset:s,limit:n,order:i}=this.$getMsgListOptionsToQuery(e),r=[],a=new Map;let o=0;for await(const l of this.dataList.ItemReader(t,i))if(o<s)++o;else{if(r.length>=n)break;r.push(l),!1===a.has(l.data.branchId)&&a.set(l.data.branchId,this.timelineTree.getBranchData(l.data.branchId))}const c=[];for(const l of r){let t=a.get(l.data.branchId);if(t&&"then"in t&&(t=await t,a.set(l.data.branchId,t)),void 0===t){console.error(new Error("数据发生了残缺丢失的问题，需要对数据重建索引"));continue}const e=this.timelineTree.getLeafFromBranchData(t,l.data.sign);void 0!==e?c.push({receiptTime:l.insertTime,content:e}):console.error(new Error("数据发生了残缺丢失的问题，可能需要同步数据"))}return c}clear(){return this.storage.del([])}};me=D([B(),T("design:paramtypes",["function"==typeof(le=void 0!==yt&&yt)?le:Object,"function"==typeof(he=void 0!==ft&&ft)?he:Object,"function"==typeof(de=void 0!==Lt&&Lt)?de:Object,"function"==typeof(ue=void 0!==St&&St)?ue:Object,"function"==typeof(pe=void 0!==Jt&&Jt)?pe:Object,"function"==typeof(ge=void 0!==jt&&jt)?ge:Object,"function"==typeof(fe=void 0!==se&&se)?fe:Object,"function"==typeof(ye=void 0!==pt&&pt)?ye:Object])],me);let _e=class{};var we,ve,be,Ie,Se,Me;_e=D([B()],_e);const Ee={CHATS_CHANNE:Symbol("chats-channel")},De=t=>{throw new Error("should never happend")};let Be=class{constructor(t,e,s,n,i,r){this.storage=t,this.helper=e,this.config=s,this._timeHelper=n,this._msgHelper=i,this._cryptoHelper=r,this._ready=new L,this._sessionMap=new Map,this._sessionList=[],this._laliaMap=new Map,this._store=t.fork(["chat-app"]),this._initMemory(),this._initMessageListen()}async _initMemory(){const t=await this._trs,{files:e}=await t.listPaths([]);for(const s of e){const e=await t.getJsObject([s]);void 0===e?await t.del([s]):(this._sessionMap.set(s,e),this._sessionList.push(e))}this._sessionList=[...this._sessionMap.values()].sort(((t,e)=>this.helper.compare(t,e))),this._ready.resolve()}async _initMessageListen(){await this._ready.promise,this.helper.onNewMessage=async t=>{var e,s,n,i,r;switch(t[0]){case Te.MSG:{if(void 0===this._sessionMap.get(t[1]))return;const s=this._getCryptolalia(t[1]);!0===await s.cryptolalia.addMsg(t[2])&&await(null==(e=this.onNewMessage)?void 0:e.call(this,[t[1],t[2]]))}break;case Te.SYNC:{const e=this._laliaMap.get(t[1]);void 0!==e&&await(null==(n=(s=e.syncChannel).onMessage)?void 0:n.call(s,t[2]))}break;case Te.SESSION:await(null==(r=(i=this.helper).handshakeSession)?void 0:r.call(i,t[1],t[2]))}};const t=this._sessionList.slice();for(const e of t){const t=this.helper.getSessionId(e);if(this._sessionMap.has(t)){const e=await this._getCryptolalia(t);await e.cryptolalia.sync.doSync()}}}_doSort(){this._sessionList.sort(((t,e)=>this.helper.compare(t,e)))}get _needEmitOrderChange(){return void 0!==this.onOrderChange}_emitOrderChange(t){let e=this._orderChangeEntryCollection;if(void 0===e){e=new Map;const t=e;queueMicrotask((()=>{var e;this._orderChangeEntryCollection=void 0,null==(e=this.onOrderChange)||e.call(this,{entries:t.values()})}))}let s=e.get(t.sessionId);if(void 0!==s)if("insert"===s.type){if("insert"===t.type)throw new TypeError(`duplication insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):De(t.type)}else if("update"===s.type){if("insert"===t.type)throw new TypeError(`invalid insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):De(t.type)}else if("delete"===s.type)if("insert"===t.type)e.set(t.sessionId,t);else{if("update"===t.type)throw new TypeError(`invalid update sessionId: '${t.sessionId}'`);if("delete"===t.type)throw new TypeError(`duplication delete sessionId: '${t.sessionId}'`);De(t.type)}else De(s.type);else e.set(t.sessionId,t)}async addSession(t,e){if(this._ready.is_resolved||await this._ready.promise,this._sessionMap.has(t))return!1;if(this._sessionMap.set(t,e),this._sessionList.unshift(e),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"insert",index:s,sessionId:t})}if(void 0!==this.helper.handshakeSession){const s=await this.helper.handshakeSession(t);void 0!==s&&await this.helper.sendMessage(e,[Te.SESSION,t,s])}return!0}async getSessionInfo(t){return this._ready.is_resolved||await this._ready.promise,this._sessionMap.get(t)}async updateSession(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._sessionList.indexOf(s);if(s!==e&&(this._sessionMap.set(t,e),this._sessionList.splice(n,1,e)),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"update",index:s,oldIndex:n,sessionId:t})}return!0}async getSessionList(t={}){this._ready.is_resolved||await this._ready.promise;const{offset:e=0,limit:s=1/0}=t;return this._sessionList.slice(e,s+e)}_getCryptolalia(t){let e=this._laliaMap.get(t);if(void 0===e){const s={postMessage:e=>{const s=this._sessionMap.get(t);if(void 0!==s)return this.helper.sendMessage(s,[Te.SYNC,t,e])}},n=C(me,new j([[k(pt),this.storage.fork([t])],[se.ARGS.SYNC_CHANNE,s],[k(Lt),this._timeHelper],[k(ft),this.config],[k(yt),this._msgHelper],[k(dt),this._cryptoHelper]]));this._laliaMap.set(t,e={cryptolalia:n,syncChannel:s})}return e}async sendMessage(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._getCryptolalia(t);return!!(await n.cryptolalia.addMsg(e))&&{locale:!0,remote:this.helper.sendMessage(s,[Te.MSG,t,e])}}async getMessageList(t,e){var s;return this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t)?[]:this._getCryptolalia(t).cryptolalia.getMsgList(null!=(s=e.timestamp)?s:this._timeHelper.now(),e)}async doSync(t){return this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t)?[]:this._getCryptolalia(t).cryptolalia.sync.doSync()}};var Te,Le;Be.ARGS=Ee,D([gt(["session"],"_store","_trs"),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",Promise)],Be.prototype,"_initMemory",null),Be=D([B(),T("design:paramtypes",["function"==typeof(we=void 0!==pt&&pt)?we:Object,"function"==typeof(ve=void 0!==_e&&_e)?ve:Object,"function"==typeof(be=void 0!==ft&&ft)?be:Object,"function"==typeof(Ie=void 0!==Lt&&Lt)?Ie:Object,"function"==typeof(Se=void 0!==yt&&yt)?Se:Object,"function"==typeof(Me=void 0!==dt&&dt)?Me:Object])],Be),(Le=Te||(Te={}))[Le.MSG=0]="MSG",Le[Le.SESSION=1]="SESSION",Le[Le.SYNC=2]="SYNC";class $e extends dt{async sha256Binary(t){return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}sha256HashBuilder(){return new Oe}}class Oe extends class{}{constructor(){super(...arguments),this.chunks=[],this.len=0}update(t){return this.chunks.push(t),this.len+=t.length,this}async digest(){const t=new Uint8Array(this.len);let e=0;for(const s of this.chunks)t.set(s,e),e+=s.length;return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}}var Ce=Object.defineProperty,je=Object.defineProperties,ke=Object.getOwnPropertyDescriptors,Ne=Object.getOwnPropertySymbols,He=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable,Ae=(t,e,s)=>e in t?Ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;let Re,Pe;"undefined"!=typeof require&&require;const Fe=new WeakMap,Ge=new WeakMap,qe=new WeakMap,Ue=new WeakMap,ze=new WeakMap;let Je={get(t,e,s){if(t instanceof IDBTransaction){if("done"===e)return Ge.get(t);if("objectStoreNames"===e)return t.objectStoreNames||qe.get(t);if("store"===e)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Ye(t[e])},set:(t,e,s)=>(t[e]=s,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function We(t){return"function"==typeof t?function(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Pe||(Pe=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Qe(this),e),Ye(Fe.get(this))}:function(...e){return Ye(t.apply(Qe(this),e))}:function(e,...s){const n=t.call(Qe(this),e,...s);return qe.set(n,e.sort?e.sort():[e]),Ye(n)}}(t):(t instanceof IDBTransaction&&function(t){if(Ge.has(t))return;const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",r),t.removeEventListener("abort",r)},i=()=>{e(),n()},r=()=>{s(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",i),t.addEventListener("error",r),t.addEventListener("abort",r)}));Ge.set(t,e)}(t),e=t,(Re||(Re=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>e instanceof t))?new Proxy(t,Je):t);var e}function Ye(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("success",i),t.removeEventListener("error",r)},i=()=>{e(Ye(t.result)),n()},r=()=>{s(t.error),n()};t.addEventListener("success",i),t.addEventListener("error",r)}));return e.then((e=>{e instanceof IDBCursor&&Fe.set(e,t)})).catch((()=>{})),ze.set(e,t),e}(t);if(Ue.has(t))return Ue.get(t);const e=We(t);return e!==t&&(Ue.set(t,e),ze.set(e,t)),e}const Qe=t=>ze.get(t);const Ke=["get","getKey","getAll","getAllKeys","count"],Ve=["put","add","delete","clear"],Xe=new Map;function Ze(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(Xe.get(e))return Xe.get(e);const s=e.replace(/FromIndex$/,""),n=e!==s,i=Ve.includes(s);if(!(s in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!Ke.includes(s))return;const r=async function(t,...e){const r=this.transaction(t,i?"readwrite":"readonly");let a=r.store;return n&&(a=a.index(e.shift())),(await Promise.all([a[s](...e),i&&r.done]))[0]};return Xe.set(e,r),r}var ts,es;es=((t,e)=>{for(var s in e||(e={}))He.call(e,s)&&Ae(t,s,e[s]);if(Ne)for(var s of Ne(e))xe.call(e,s)&&Ae(t,s,e[s]);return t})({},ts=Je),Je=je(es,ke({get:(t,e,s)=>Ze(t,e)||ts.get(t,e,s),has:(t,e)=>!!Ze(t,e)||ts.has(t,e)}));const ss=t=>{const e=t.prototype[Symbol.toStringTag];return{kind:"sequence",resolve:t=>null===t||t.length%2==0,construct(e){const s=new t;for(let t=0;t<e.length;t+=2)s.set(e[t],e[t+1]);return s},represent(s){if(!(s instanceof t))throw new TypeError(`no an ${e}`);const n=new Array(2*s.size);let i=0;for(const t of s)n[i++]=t[0],n[i++]=t[1];return n},predicate:s=>s instanceof t&&s[Symbol.toStringTag]===e}},ns=N.DEFAULT_SCHEMA.extend([new H("tag:bfchain.org,2021:js/ordermap",ss(Mt)),new H("tag:bfchain.org,2021:js/map",ss(Map)),new H("tag:bfchain.org,2021:js/set",{kind:"sequence",resolve:t=>!0,construct(t){const e=new Set;for(let s=0;s<t.length;++s)e.add(t[s]);return e},represent(t){if(!(t instanceof Set))throw new TypeError("no an set");return[...t]},predicate:t=>t instanceof Set&&"Set"===t[Symbol.toStringTag]})]),is=new TextDecoder,rs=t=>N.load(is.decode(t),{schema:ns}),as=new TextEncoder,os=t=>as.encode(N.dump(t,{schema:ns}));class cs extends ut{constructor(t){super(),this.currentPaths=t,this._memFolder=new Map}setBinary(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{binary:e})}_makeFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i&&s.set(e,i={folder:new Map}),!("folder"in i))throw new Error("no an paths:"+t);s=i.folder}return s}_getFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i)return;if(!("folder"in i))return;s=i.folder}return s}_getFile(t){let e=this._memFolder;for(let n=0,i=t.length-2;n<=i;n++){const s=t[n],i=e.get(s);if(void 0===i||!("folder"in i))return;e=i.folder}const s=e.get(t[t.length-1]);if(void 0!==s&&!("folder"in s))return s}getBinary(t){const e=this._getFile(t);if(void 0!==e)return"binary"in e?e.binary:e.binary=os(e.jsobj)}getJsObject(t){const e=this._getFile(t);if(void 0!==e)return"jsobj"in e?e.jsobj.value:(e.jsobj={value:rs(e.binary)}).value}setJsObject(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{jsobj:{value:e}})}has(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&e.has(t[t.length-1])}del(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&(e.clear(),!0)}listPaths(t){const e=this._getFolder(t,t.length-2),s={paths:[],files:[]};if(void 0!==e)for(const[n,i]of e)"folder"in i?s.paths.push(n):s.files.push(n);return s}*WalkFiles(t=[],e=this._memFolder){for(const[s,n]of e){const e=[...t,s];"folder"in n?yield*this.WalkFiles(e,n.folder):yield[e,n]}}}class ls{constructor(){this._delPathMap=new Map}addDel(t){let e=this._delPathMap;for(const s of t){let t=e.get(s);void 0===t&&(t=new Map,e.set(s,t)),e=t}e.clear()}isDel(t){let e=this._delPathMap;for(const s of t){const t=e.get(s);if(void 0===t)return!1;if(0===t.size)return!0;e=t}return!1}ls(){const t=(e,s)=>{const n=[];0===s.size&&0!==e.length&&n.push(e);for(const[i,r]of s)n.push(...t([...e,i],r));return n};return t([],this._delPathMap)}}class hs extends ut{constructor(){super(...arguments),this._cacheStore=new cs(["transaction"]),this._del=new ls}setBinary(t,e){return this._cacheStore.setBinary(t,e)}async getBinary(t){const e=await this._cacheStore.getBinary(t);return void 0!==e?e:this._del.isDel(t)?void 0:await this._targetStore.getBinary(t)}async getJsObject(t){return await this._cacheStore.has(t)?await this._cacheStore.getJsObject(t):this._del.isDel(t)?void 0:await this._targetStore.getJsObject(t)}setJsObject(t,e){return this._cacheStore.setJsObject(t,e)}async has(t){return!!(await this._cacheStore.has(t))||!this._del.isDel(t)&&await this._targetStore.has(t)}async del(t){return!(!1===await this._cacheStore.del(t)&&this._del.isDel(t)||(this._del.addDel(t),0))}async listPaths(t){const e=await this._cacheStore.listPaths(t);if(0===e.files.length&&0===e.paths.length&&this._del.isDel(t))return e;const s=await this._targetStore.listPaths(t);return{files:0===e.files.length?s.files:s.files.concat(e.files),paths:0===e.paths.length?s.paths:s.paths.concat(e.paths)}}}var ds,us,ps,gs;(us=ds||(ds={})).PATH_SEP="/",us[us.FILE_TYPE_FLAG=1]="FILE_TYPE_FLAG",us[us.DIR_TYPE_FLAG=2]="DIR_TYPE_FLAG",us.ROOT_DIR=":root:";class fs{constructor(t,e){let s=!1;if("string"==typeof t&&(s=t.trimStart().startsWith("/"),t=t.split(ds.PATH_SEP).map((t=>t.trim()))),void 0!==e){if("string"==typeof e&&(e=e.split(ds.PATH_SEP)),e=fs.normal(e.map((t=>t.trim()))),!1===s){const s=e.concat(t);for(let t=0;t>s.length;++t)".."===s[t]&&(s.splice(t-1,2),t-=2);t=s}if(e.length>t.length)throw new SyntaxError(`'${t}' no belong to ${e}`);for(let s=0;s<e.length;++s)if(e[s]!==t[s])throw new SyntaxError(`'${t}' no belong to ${e}`)}this.paths=fs.normal(t)}static normal(t){return t.filter((t=>""!==t&&!1===t.endsWith(".")))}get dirname(){const t=this.paths.slice(0,-1);return t.length>0?t.join(ds.PATH_SEP):ds.ROOT_DIR}get basename(){return this.paths[this.paths.length-1]}get fullpath(){return this.paths.join(ds.PATH_SEP)}}(gs=ps||(ps={})).FILE="file",gs.DIR="dir";const ys=new Map;class ms{constructor(t){this.dbName=t,this._idb=(t=>{let e=ys.get(t);return void 0===e&&(e=function(t,e,{blocked:s,upgrade:n,blocking:i,terminated:r}={}){const a=indexedDB.open(t,e),o=Ye(a);return n&&a.addEventListener("upgradeneeded",(t=>{n(Ye(a.result),t.oldVersion,t.newVersion,Ye(a.transaction))})),s&&a.addEventListener("blocked",(()=>s())),o.then((t=>{r&&t.addEventListener("close",(()=>r())),i&&t.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),o}(t,1,{upgrade(t,e,s,n){switch(e){case 0:t.createObjectStore(ps.DIR,{autoIncrement:!1,keyPath:null}).put(new Map,ds.ROOT_DIR),t.createObjectStore(ps.FILE,{autoIncrement:!0,keyPath:null})}}}).then((e=>(ys.set(t,e),e))),ys.set(t,e)),e})(this.dbName)}async exists(t){const e=await this._idb,{dirname:s,basename:n}=new fs(t),i=await e.get(ps.DIR,s);return void 0!==i&&i.has(n)}async writeFile(t,e){const s=(await this._idb).transaction([ps.FILE,ps.DIR],"readwrite"),n=s.objectStore(ps.DIR),i=s.objectStore(ps.FILE),{dirname:r,basename:a}=new fs(t),o=await n.get(r);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${r}'`);let c=o.get(a);if(void 0!==c){if(c.type!==ds.FILE_TYPE_FLAG)throw new Error(`EISDIR: illegal operation on a directory, open '${a}'`);c.size=e.length,c.fid}else c={type:ds.FILE_TYPE_FLAG,size:e.length,fid:-1},o.set(a,c);const l=await i.add(e);-1!==c.fid&&await i.delete(c.fid),c.fid=l,await n.put(o,r)}async _mkdir(t,e,s){const{dirname:n,basename:i}=new fs(t);let r=await s.get(n);if(void 0===r){if(!1===e)throw new Error(`ENOENT: no such file or directory, mkdir '${t}'`);r=await this._mkdir(n,e,s)}const a=r.get(i);if((null==a?void 0:a.type)===ds.FILE_TYPE_FLAG)throw new Error(`EEXIST: file already exists, mkdir '${t}'`);let o;return void 0!==a&&(o=await s.get(t)),void 0===o&&(o=new Map,await s.put(o,t),r.set(i,{type:ds.DIR_TYPE_FLAG}),await s.put(r,n)),o}async mkdir(t,e={}){const{recursive:s=!1}=e,n=(await this._idb).transaction(ps.DIR,"readwrite").objectStore(ps.DIR);await this._mkdir(new fs(t).fullpath,s,n)}async readFile(t){const e=(await this._idb).transaction([ps.FILE,ps.DIR],"readwrite"),s=e.objectStore(ps.DIR),n=e.objectStore(ps.FILE),{dirname:i,basename:r}=new fs(t),a=await s.get(i);if(void 0===a)throw new Error(`ENOENT: no such file or directory, open '${i}'`);const o=a.get(r);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${t}'`);if(o.type===ds.DIR_TYPE_FLAG)throw new Error("EISDIR: illegal operation on a directory, read");return await n.get(o.fid)}async _recursive_rmdir(t,e,s){const n=await e.get(t);if(void 0!==n){for(const[i,r]of n)r.type===ds.FILE_TYPE_FLAG?await s.delete(r.fid):this._recursive_rmdir(t+ds.PATH_SEP+i,e,s);await e.delete(t)}}async _rm(t,e,s,n,i){const{dirname:r,basename:a}=new fs(t),o=await n.get(r);let c;if(void 0!==o&&(c=o.get(a)),void 0!==c){if(c.type===ds.FILE_TYPE_FLAG)await i.delete(c.fid);else{if(!1===e)throw new Error(`EISDIR: Path is a directory: '${t}'`);await this._recursive_rmdir(t,n,i)}o.delete(a),await n.put(o,r)}else if(!1===s)throw new Error(`ENOENT: no such file or directory, stat '${t}'`)}async rm(t,e={}){const{recursive:s=!1,force:n=!1}=e,i=(await this._idb).transaction([ps.FILE,ps.DIR],"readwrite"),r=i.objectStore(ps.DIR),a=i.objectStore(ps.FILE);await this._rm(t,s,n,r,a)}async readdir(t){const e=(await this._idb).transaction(ps.DIR,"readwrite").objectStore(ps.DIR),s=await e.get(t);if(void 0===s)throw new Error(`ENOENT: no such file or directory, scandir '${t}'`);return s.entries()}}const _s={IDB_NAME:Symbol("idbName"),TARGET_DIR:Symbol("targetDir")};let ws=class extends ut{constructor(t="usr",e="cryptolalia-tree-fs"){super(),this.targetDir=t,this.idbName=e,this.currentPaths=this.targetDir.split(ds.PATH_SEP).map((t=>t.trim())).filter(Boolean),this._fs=new ms(this.idbName)}async setBinary(t,e){const{dirname:s,fullpath:n}=new fs(t,this.currentPaths);!1===await this._fs.exists(s)&&await this._fs.mkdir(s,{recursive:!0}),await this._fs.writeFile(n,e)}async getBinary(t){const{fullpath:e}=new fs(t,this.currentPaths);if(await this._fs.exists(e))return this._fs.readFile(e)}async getJsObject(t){const e=await this.getBinary(t);if(e)return rs(e)}setJsObject(t,e){return this.setBinary(t,os(e))}async has(t){const{fullpath:e}=new fs(t,this.currentPaths);return await this._fs.exists(e)}async del(t){const{fullpath:e}=new fs(t,this.currentPaths);return!!(await this._fs.exists(e))&&(await this._fs.rm(e,{recursive:!0,force:!0}),!0)}async listPaths(t){const{fullpath:e}=new fs(t,this.currentPaths),s=[],n=[];if(await this._fs.exists(e))for(const[i,r]of await this._fs.readdir(e))try{r.type===ds.FILE_TYPE_FLAG?n.push(i):s.push(i)}catch{}return{paths:s,files:n}}};ws.ARGS=_s,ws=D([$(0,O(_s.TARGET_DIR,{optional:!0})),$(1,O(_s.IDB_NAME,{optional:!0})),T("design:paramtypes",[String,String])],ws);class vs extends hs{constructor(t,e="cryptolalia-tree-fs"){super(),this.sourceTargetDir=t,this.idbName=e,this._targetStore=new ws(this.sourceTargetDir),this.currentPaths=new fs(this.sourceTargetDir).paths}}class bs extends ws{constructor(){super(...arguments),this._transactionMap=new Map}async startTransaction(t){const e=new fs(t,this.targetDir).fullpath;let s=this._transactionMap.get(e);if(s){const t=new L;s.queue.push(t),await t.promise}const n={transaction:new vs(e),finished:new L,queue:(null==s?void 0:s.queue)||[]};return this._transactionMap.set(e,n),n.finished.onSuccess((()=>{var t;const s=null==(t=n.queue.pop())?void 0:t.resolve;void 0===s?this._transactionMap.delete(e):s()})),n.transaction}async finishTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);if(void 0===e||e.transaction!==t)return!1;for(const n of t._del.ls())await t._targetStore.del(n);const s=t._targetStore;for(const[n,i]of t._cacheStore.WalkFiles())await s.setBinary(n,i.binary||os(i.jsobj.value));return e.finished.resolve(),!0}requestTransaction(t,e){return(async(t,e,s)=>{const n=await t.startTransaction(e);try{const e=await s(n);return await t.finishTransaction(n),e}catch(i){throw await t.stopTransaction(n),i}})(this,t,e)}async stopTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);return void 0!==e&&e.transaction===t&&(e.finished.resolve(),!0)}fork(t){const e=new fs(t,this.targetDir).fullpath;return new bs(e)}}var Is,Ss;const Ms=new j;C($t,Ms);const Es={USER_ID:Symbol("user-id")};let Ds=Is=class{constructor(t,e){this.userId=t,this.moduleMap=e,this._startTimesLsKey=`${this.userId}/times`,this._msCache=new Map,this._meta_cl=(()=>{const t=`${this.userId}/metatime`;let e=localStorage.getItem(t);"string"!=typeof e&&(e=Is.DEFAULT_START_TIME,localStorage.setItem(t,e));const s=new Is.SuperConfig(e);return this._createCl(s,`${this.userId}-metadata`,"metadata")})(),this._msg_cl_list=this._getCryptolalias(new Set)}_getStartTimes(){if(void 0===this._startTimes){let t=localStorage.getItem(this._startTimesLsKey);"string"!=typeof t&&(t=Is.DEFAULT_START_TIME,localStorage.setItem(this._startTimesLsKey,t));const e=new Map;for(const s of t.split(",").filter(Boolean)){const t=new Date(s);e.set(t.toISOString(),t)}this._startTimes=e}return this._startTimes}_addStartTime(t){const e=this._getStartTimes(),s=new Date(t);if(t=s.toISOString(),e.has(t))return!1;e.set(t,s);const n=[...e.values()].sort(((t,e)=>t.getTime()-e.getTime()));e.clear();for(const i of n)e.set(i.toISOString(),i);return this._saveStartTimes(e),!0}_saveStartTimes(t){localStorage.setItem(this._startTimesLsKey,[...t.keys()].join(","))}_getCryptolalias(t){const e=[];for(const s of this._getStartTimes().keys()){let n,i=this._msCache.get(s);if(void 0===i){const e=new Is.SuperConfig(s);n={cid:s,cryptolalia:this._createCl(e,`${this.userId}-${s}`,s),syncable:t.has(s)}}else n=i.get(k(ft));e.push(n)}return e}_createCl(t,e,s){const n=new j([[k(ft),t],[se.ARGS.SYNC_CHANNE,Ts.getPort(s,this.userId)],[bs.ARGS.TARGET_DIR,e]],this.moduleMap);return C(bs,n),C(me,n)}get _msg_cl(){return this._msg_cl_list[this._msg_cl_list.length-1]}async getMsgList(t,e){const{limit:s,order:n}=this._meta_cl.$getMsgListOptionsToQuery(e),i=this._msg_cl_list.slice();n===Wt.DOWN&&i.reverse();const r=[];for(const a of i)if(r.push(...await a.cryptolalia.getMsgList(t,e)),r.length>=s)break;return r}async addMsg(t){if(void 0===this._msg_cl){const t=(new Date).toISOString();await this._meta_cl.addMsg({cmd:"list",datetimes:[t],time:Date.now()}),this._addStartTime(t),this._msg_cl_list=this._getCryptolalias(new Set([t]))}return this._msg_cl.cryptolalia.addMsg(t)}async clear(){const t=this._getStartTimes();await this._meta_cl.sync.doSync(),await this._meta_cl.addMsg({cmd:"list",datetimes:[],time:Date.now()}),t.clear(),this._saveStartTimes(t);for(const e of this._msg_cl_list)await e.cryptolalia.clear();this._msg_cl_list.length=0}async doSync(){await this._meta_cl.sync.doSync();for(const t of await this._meta_cl.getMsgList(Date.now(),{limit:1}))if("list"===t.content.cmd){const e=new Set(t.content.datetimes);for(const t of this._msg_cl_list)t.syncable=e.has(t.cid),e.delete(t.cid);if(console.log(this.userId,t.content),e.size>0){for(const t of e)this._addStartTime(t);this._msg_cl_list=this._getCryptolalias(new Set(t.content.datetimes))}break}console.log("doSync meta done");for(const t of this._msg_cl_list)t.syncable&&(await t.cryptolalia.sync.doSync(),console.log("doSync msg done"));console.log("doSync done")}};Ds=Is=x([B(),A(0,O(Es.USER_ID)),R("design:paramtypes",[String,"function"==typeof(Ss=void 0!==j&&j)?Ss:Object])],Ds),function(t){t.ARGS=Es;t.SuperConfig=class extends ft{constructor(t){super(),this._st=t,this.branchGroupCount=64,this.timespan=1e4,this.startTime=+new Date(this._st)}},t.DEFAULT_START_TIME=(new Date).toISOString()}(Ds||(Ds={}));const Bs=new TextEncoder;new TextDecoder;{class t extends yt{getSignature(t){const e=Bs.encode(JSON.stringify(t)),s=new Uint8Array(32);for(let n=0;n<e.length;++n){const t=n%s.length;s[t]+=e[n];for(let e=(t+1)%s.length;e<s.length;++e)s[e]=n*e+s[t]}return s}getCreateTime(t){return t.time}}C(t,Ms)}C($e,Ms);class Ts{constructor(){this.port1=(()=>{const t=this;return{postMessage(t){},get onMessage(){return t.port2.postMessage},set onMessage(e){t.port2.postMessage=e}}})(),this.port2=(()=>{const t=this;return{postMessage(t){},get onMessage(){return t.port1.postMessage},set onMessage(e){t.port1.postMessage=e}}})()}static getPort(t,e){console.log("getport",t);let s=this.cache.get(t);return void 0===s&&(s=new Ts,this.cache.set(t,s)),e===Ls.get(Es.USER_ID)?(console.log("port1 for",t),s.port1):(console.log("port2 for",t),s.port2)}}Ts.cache=new Map;const Ls=new j([[Es.USER_ID,"user1"]],Ms),$s=new j([[Es.USER_ID,"user2"]],Ms),Os=C(Ds,Ls),Cs=C(Ds,$s),js=t=>{var e;const s=new j([],Ms);{const n=Symbol("localId");s.set(n,t);class i extends _e{constructor(){super(...arguments),this.bchanne=new BroadcastChannel("chatsApp"),this.handshakeSession=async(t,e)=>void 0===e?{senderId:this.localId}:void(await this.app.addSession(t,{nickname:e.senderId,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1}))}getSessionId(t){return[this.localId,t.nickname].sort().join("-")}compare(t,e){return t.isCollection&&!e.isCollection?-1:e.isCollection&&!t.isCollection?1:e.lastMsgTime-t.lastMsgTime}sendMessage(t,e){this.bchanne.postMessage(["chatsApp",t.nickname,e])}bfOnInit(){this.bchanne.addEventListener("message",(t=>{if(console.log("event",t.data),void 0===this.onNewMessage)return;const{data:e}=t;Array.isArray(e)&&3===e.length&&"chatsApp"===e[0]&&e[1]===this.localId&&this.onNewMessage(e[2])}))}}x([O(n),R("design:type",String)],i.prototype,"localId",void 0),x([O(Be),R("design:type","function"==typeof(e=void 0!==Be&&Be)?e:Object)],i.prototype,"app",void 0),console.log("MyChatsAppHelper",k(i)),C(i,s)}C(bs,s.installMask(new j([[bs.ARGS.TARGET_DIR,"online-"+t]])));return C(Be,s)};function ks(t){let e,s,i,o,h,d,u,f;return i=new ht({props:{doSend:t[0],doSync:t[2],getList:t[4],isSelf:t[6],doClear:t[8]}}),d=new ht({props:{doSend:t[1],doSync:t[3],getList:t[5],isSelf:t[7],doClear:t[9]}}),{c(){e=n("main"),s=n("section"),P(i.$$.fragment),o=r(),h=n("section"),P(d.$$.fragment),a(s,"class","chat-panel panel-1 svelte-16sysco"),a(h,"class","chat-panel panel-2 svelte-16sysco"),a(e,"class","chat-panels svelte-16sysco")},m(t,n){c(t,e,n),l(e,s),F(i,s,null),l(e,o),l(e,h),F(d,h,null),f=!0},p:y,i(t){f||(b(i.$$.fragment,t),b(d.$$.fragment,t),u||p((()=>{u=g(e,U,{}),u.start()})),f=!0)},o(t){G(i.$$.fragment,t),G(d.$$.fragment,t),f=!1},d(t){t&&m(e),q(i),q(d)}}}function Ns(t){const e=(t,e)=>s=>e.addMsg({content:s,sender:t,time:Date.now()}),s=t=>()=>E(void 0,void 0,void 0,(function*(){console.group("do sync"),yield t.doSync(),console.groupEnd()})),n=t=>()=>E(void 0,void 0,void 0,(function*(){const e=[];for(const s of yield t.getMsgList(Date.now(),{offset:0,limit:100,order:-1}))e.push(s.content);return e}));return[e("user1",Os),e("user2",Cs),s(Os),s(Cs),n(Os),n(Cs),t=>"user1"===t,t=>"user2"===t,()=>Os.clear(),()=>Cs.clear()]}class Hs extends t{constructor(t){super(),e(this,t,Ns,ks,s,{})}}function xs(t,e,s){const n=t.slice();return n[22]=e[s],n}function As(t){let e,s,h,u,p,g,f,y,S,M,E,D,B,T,L=[],$=new Map,O=t[3];const C=t=>t[22].nickname;for(let n=0;n<O.length;n+=1){let e=xs(t,O,n),s=C(e);$.set(s,L[n]=qs(s,e))}return{c(){e=n("section"),s=n("h2"),h=i("Welcome 💜 "),u=i(t[1]),p=r(),g=n("ul"),f=n("li"),y=n("input"),S=r(),M=n("button"),M.textContent="添加好友",E=r();for(let t=0;t<L.length;t+=1)L[t].c();a(y,"type","text"),o(M,"activing",t[5]),a(f,"class","add-friend"),a(g,"class","friend-list svelte-1lrcjcd")},m(n,i){c(n,e,i),l(e,s),l(s,h),l(s,u),l(e,p),l(e,g),l(g,f),l(f,y),_(y,t[4]),l(f,S),l(f,M),l(g,E);for(let t=0;t<L.length;t+=1)L[t].m(g,null);D=!0,B||(T=[w(y,"input",t[17]),w(M,"click",t[9])],B=!0)},p(t,e){(!D||2&e)&&d(u,t[1]),16&e&&y.value!==t[4]&&_(y,t[4]),32&e&&o(M,"activing",t[5]),64712&e&&(O=t[3],z(),L=v(L,e,C,1,t,O,$,g,W,qs,null,xs),J())},i(t){if(!D){for(let t=0;t<O.length;t+=1)b(L[t]);D=!0}},o(t){for(let e=0;e<L.length;e+=1)G(L[e]);D=!1},d(t){t&&m(e);for(let e=0;e<L.length;e+=1)L[e].d();B=!1,I(T)}}}function Rs(t){let e,s,i,h,d,u,p,g,f;return{c(){e=n("session"),s=n("h2"),s.textContent="Hi~ Please Login",i=r(),h=n("div"),d=n("input"),u=r(),p=n("button"),p.textContent="登录",a(d,"placeholder","请输入您的名字"),a(p,"class","login-btn svelte-1lrcjcd"),o(p,"activing",t[2]),a(h,"class","form svelte-1lrcjcd"),a(e,"class","login-panel svelte-1lrcjcd")},m(n,r){c(n,e,r),l(e,s),l(e,i),l(e,h),l(h,d),_(d,t[1]),l(h,u),l(h,p),g||(f=[w(d,"input",t[16]),w(p,"click",t[8])],g=!0)},p(t,e){2&e&&d.value!==t[1]&&_(d,t[1]),4&e&&o(p,"activing",t[2])},i:y,o:y,d(t){t&&m(e),g=!1,I(f)}}}function Ps(t){let e,s,r=t[22].badge+"";return{c(){e=n("sup"),s=i(r),a(e,"title","未读"),a(e,"class","badge svelte-1lrcjcd")},m(t,n){c(t,e,n),l(e,s)},p(t,e){8&e&&r!==(r=t[22].badge+"")&&d(s,r)},d(t){t&&m(e)}}}function Fs(t){let e,s,o,h,u,f,_,w=t[22].lastMsgPreview+"",v=new Date(t[22].lastMsgTime).toLocaleTimeString()+"";return{c(){e=n("div"),s=n("span"),o=i(w),h=r(),u=n("span"),f=i(v),a(s,"class","msg-preview svelte-1lrcjcd"),a(u,"class","msg-time"),a(e,"class","last-msg svelte-1lrcjcd")},m(t,n){c(t,e,n),l(e,s),l(s,o),l(e,h),l(e,u),l(u,f)},p(t,e){8&e&&w!==(w=t[22].lastMsgPreview+"")&&d(o,w),8&e&&v!==(v=new Date(t[22].lastMsgTime).toLocaleTimeString()+"")&&d(f,v)},i(t){_||p((()=>{_=g(e,Y,{duration:300}),_.start()}))},o:y,d(t){t&&m(e)}}}function Gs(t){let e,s,i,r,o;function l(e){t[20](e)}let h={doSend:t[12],doSync:t[13],getList:t[14],isSelf:t[15]};return void 0!==t[7]&&(h.onListChanged=t[7]),s=new ht({props:h}),Q.push((()=>K(s,"onListChanged",l))),{c(){e=n("div"),P(s.$$.fragment),a(e,"class","chat-panel svelte-1lrcjcd")},m(t,n){c(t,e,n),F(s,e,null),o=!0},p(t,e){const n={};!i&&128&e&&(i=!0,n.onListChanged=t[7],V((()=>i=!1))),s.$set(n)},i(t){o||(b(s.$$.fragment,t),r||p((()=>{r=g(e,Y,{duration:300}),r.start()})),o=!0)},o(t){G(s.$$.fragment,t),o=!1},d(t){t&&m(e),q(s)}}}function qs(t,e){let s,o,h,u,p,g,f,y,_,v,S,M,E,D,B,T,L,$=e[22].nickname+"",O=e[22].isCollection?"❤️":"🤍",C=0!==e[22].badge&&Ps(e);function j(){return e[18](e[22])}function k(){return e[19](e[22])}const N=[Gs,Fs],H=[];function x(t,e){return t[6]===t[22]?0:t[22].lastMsgPreview?1:-1}return~(M=x(e))&&(E=H[M]=N[M](e)),{key:t,first:null,c(){s=n("li"),o=n("div"),h=n("span"),u=i($),p=r(),C&&C.c(),g=r(),f=n("span"),y=i(O),_=r(),v=n("button"),v.textContent="💬",S=r(),E&&E.c(),D=r(),a(h,"class","nickname svelte-1lrcjcd"),a(f,"title","收藏"),a(f,"class","collection svelte-1lrcjcd"),a(v,"title","开始聊天"),a(v,"class","start-chat-btn svelte-1lrcjcd"),a(o,"class","base-info svelte-1lrcjcd"),a(s,"class","friend-info svelte-1lrcjcd"),this.first=s},m(t,e){c(t,s,e),l(s,o),l(o,h),l(h,u),l(h,p),C&&C.m(h,null),l(o,g),l(o,f),l(f,y),l(o,_),l(o,v),l(s,S),~M&&H[M].m(s,null),l(s,D),B=!0,T||(L=[w(f,"click",j),w(v,"click",k)],T=!0)},p(t,n){e=t,(!B||8&n)&&$!==($=e[22].nickname+"")&&d(u,$),0!==e[22].badge?C?C.p(e,n):(C=Ps(e),C.c(),C.m(h,null)):C&&(C.d(1),C=null),(!B||8&n)&&O!==(O=e[22].isCollection?"❤️":"🤍")&&d(y,O);let i=M;M=x(e),M===i?~M&&H[M].p(e,n):(E&&(z(),G(H[i],1,1,(()=>{H[i]=null})),J()),~M?(E=H[M],E?E.p(e,n):(E=H[M]=N[M](e),E.c()),b(E,1),E.m(s,D)):E=null)},i(t){B||(b(E),B=!0)},o(t){G(E),B=!1},d(t){t&&m(s),C&&C.d(),~M&&H[M].d(),T=!1,I(L)}}}function Us(t){let e,s,i,r,a;const o=[Rs,As],l=[];function h(t,e){return void 0===t[0]?0:1}return s=h(t),i=l[s]=o[s](t),{c(){e=n("main"),i.c()},m(t,n){c(t,e,n),l[s].m(e,null),a=!0},p(t,[n]){let r=s;s=h(t),s===r?l[s].p(t,n):(z(),G(l[r],1,1,(()=>{l[r]=null})),J(),i=l[s],i?i.p(t,n):(i=l[s]=o[s](t),i.c()),b(i,1),i.m(e,null))},i(t){a||(b(i),r||p((()=>{r=g(e,U,{}),r.start()})),a=!0)},o(t){G(i),a=!1},d(t){t&&m(e),l[s].d()}}}function zs(t,e,s){let n,i="",r=!1;let a=[],o="",c=!1;const l=t=>E(void 0,void 0,void 0,(function*(){t.isCollection=!t.isCollection;const e=n.helper.getSessionId(t);(yield n.updateSession(e,t))&&s(3,a=yield n.getSessionList())}));let h,d="";const u=t=>{s(6,h=h===t?void 0:t),d=h?n.helper.getSessionId(h):""};let p;return[n,i,r,a,o,c,h,p,()=>E(void 0,void 0,void 0,(function*(){s(2,r=!0);try{if(s(1,i=i.trim()),0===i.length)return;s(0,n=js(i)),console.log("chatsApp",n),s(3,a=yield n.getSessionList()),s(0,n.onOrderChange=()=>E(void 0,void 0,void 0,(function*(){s(3,a=yield n.getSessionList())})),n),s(0,n.onNewMessage=([t,e])=>E(void 0,void 0,void 0,(function*(){t===d&&p();const s=yield n.getSessionInfo(t);void 0!==s&&(s.lastMsgPreview=e.content,s.lastMsgTime=Date.now(),t!==d&&(s.badge+=1),yield n.updateSession(t,s))})),n)}finally{s(2,r=!1)}})),()=>E(void 0,void 0,void 0,(function*(){try{if(s(5,c=!0),s(4,o=o.trim()),0===o.length)return;const t={nickname:o,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1},e=n.helper.getSessionId(t);(yield n.addSession(e,t))&&s(3,a=yield n.getSessionList()),s(4,o="")}finally{s(5,c=!1)}})),l,u,t=>n.sendMessage(d,{sender:i,content:t,time:Date.now()}),()=>{if(console.log("no need sync~"),0!==(null==h?void 0:h.badge))return s(6,h.badge=0,h),n.updateSession(d,h)},()=>E(void 0,void 0,void 0,(function*(){return(yield n.getMessageList(d,{limit:100,order:-1})).map((t=>t.content))})),t=>t===i,function(){i=this.value,s(1,i)},function(){o=this.value,s(4,o)},t=>l(t),t=>u(t),function(t){p=t,s(7,p)}]}class Js extends t{constructor(t){super(),e(this,t,zs,Us,s,{})}}function Ws(t){let e;return{c(){e=i("Local Chat Demo")},m(t,s){c(t,e,s)},d(t){t&&m(e)}}}function Ys(t){let e;return{c(){e=i("Chat Online Demo")},m(t,s){c(t,e,s)},d(t){t&&m(e)}}}function Qs(t){let e,s;return e=new Hs({}),{c(){P(e.$$.fragment)},m(t,n){F(e,t,n),s=!0},i(t){s||(b(e.$$.fragment,t),s=!0)},o(t){G(e.$$.fragment,t),s=!1},d(t){q(e,t)}}}function Ks(t){let e,s,o,h,d,u,p,g;return p=new Js({}),{c(){e=n("p"),s=i("提示：该DEMO使用BroadcastChannel模块网络广播，"),o=n("a"),h=i("打开更多同域页面"),d=i("即可多账户登录"),u=r(),P(p.$$.fragment),a(o,"href",location.href),a(o,"target","_blank"),a(e,"class","tip svelte-hzs5f5")},m(t,n){c(t,e,n),l(e,s),l(e,o),l(o,h),l(e,d),c(t,u,n),F(p,t,n),g=!0},p:y,i(t){g||(b(p.$$.fragment,t),g=!0)},o(t){G(p.$$.fragment,t),g=!1},d(t){t&&m(e),t&&m(u),q(p,t)}}}function Vs(t){let e,s,i,o,h,d,u,p,g,f,y,_,w;return h=new et({props:{getProps:Zs,to:"/",$$slots:{default:[Ws]},$$scope:{ctx:t}}}),u=new et({props:{getProps:Zs,to:"/online",$$slots:{default:[Ys]},$$scope:{ctx:t}}}),f=new st({props:{path:"/",$$slots:{default:[Qs]},$$scope:{ctx:t}}}),_=new st({props:{path:"/online",$$slots:{default:[Ks]},$$scope:{ctx:t}}}),{c(){e=n("header"),s=n("h1"),s.textContent="Cryptolalia Demo",i=r(),o=n("nav"),P(h.$$.fragment),d=r(),P(u.$$.fragment),p=r(),g=n("main"),P(f.$$.fragment),y=r(),P(_.$$.fragment),a(s,"class","svelte-hzs5f5"),a(o,"class","svelte-hzs5f5"),a(e,"class","svelte-hzs5f5"),a(g,"class","svelte-hzs5f5")},m(t,n){c(t,e,n),l(e,s),l(e,i),l(e,o),F(h,o,null),l(o,d),F(u,o,null),c(t,p,n),c(t,g,n),F(f,g,null),l(g,y),F(_,g,null),w=!0},p(t,e){const s={};8&e&&(s.$$scope={dirty:e,ctx:t}),h.$set(s);const n={};8&e&&(n.$$scope={dirty:e,ctx:t}),u.$set(n);const i={};8&e&&(i.$$scope={dirty:e,ctx:t}),f.$set(i);const r={};8&e&&(r.$$scope={dirty:e,ctx:t}),_.$set(r)},i(t){w||(b(h.$$.fragment,t),b(u.$$.fragment,t),b(f.$$.fragment,t),b(_.$$.fragment,t),w=!0)},o(t){G(h.$$.fragment,t),G(u.$$.fragment,t),G(f.$$.fragment,t),G(_.$$.fragment,t),w=!1},d(t){t&&m(e),q(h),q(u),t&&m(p),t&&m(g),q(f),q(_)}}}function Xs(t){let e,s;return e=new X({props:{history:t[0],$$slots:{default:[Vs]},$$scope:{ctx:t}}}),{c(){P(e.$$.fragment)},m(t,n){F(e,t,n),s=!0},p(t,[s]){const n={};8&s&&(n.$$scope={dirty:s,ctx:t}),e.$set(n)},i(t){s||(b(e.$$.fragment,t),s=!0)},o(t){G(e.$$.fragment,t),s=!1},d(t){q(e,t)}}}function Zs({location:t,href:e,isPartiallyCurrent:s,isCurrent:n}){return("/"===e?n:s||n)?{class:"nav-item active"}:{class:"nav-item"}}function tn(t,e,s){const n=Z(function(){const t=nt({});let e=[];return t.listen((s=>{"POP"===t.action&&e.forEach((t=>t(s)))})),{get location(){return t.location},addEventListener(t,s){"popstate"===t&&e.push(s)},removeEventListener(t,s){"popstate"===t&&(e=e.filter((t=>t!==s)))},history:{get state(){return t.location.state},pushState(e,s,n){t.push(n,e)},replaceState(e,s,n){t.replace(n,e)},go(e){t.go(e)}}}}());tt((()=>{console.log("destory")}));return[n,()=>{it().$destroy()}]}new class extends t{constructor(t){super(),e(this,t,tn,Xs,s,{destory:1})}get destory(){return this.$$.ctx[1]}}({target:document.getElementById("app")});
