import{S as t,i as e,s,e as n,t as i,a,b as r,c as o,d as c,f as l,g as h,h as d,j as u,k as p,l as g,m as f,n as y,o as m,p as _,q as w,u as v,r as b,v as S,w as I,x as M,_ as T,y as $,z as E,A as D,B,C as L,$ as O,L as C,F as j,D as k,E as N,T as H,G as x,H as R,I as A,J as P,K as F,M as G,N as q,O as U,P as z,Q as J,R as Y,U as W,V as Q,W as K,X as V,Y as X,Z,a0 as tt,a1 as et,a2 as st,a3 as nt,a4 as it,a5 as at,a6 as rt,a7 as ot,a8 as ct,a9 as lt,aa as ht}from"./vendor.91025bec.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();function dt(t,e,s){const n=t.slice();return n[16]=e[s],n[18]=s,n}function ut(t,e){let s,_,w,v,b,S,I,M,T,$,E,D,B,L,O,C=new Date(e[16].time).toLocaleTimeString()+"",j=e[16].sender+"",k=e[16].content+"";return{key:t,first:null,c(){s=n("li"),_=n("span"),w=i(C),v=a(),b=n("div"),S=n("address"),I=i(j),M=a(),T=n("p"),$=i(k),E=a(),r(_,"class","time-tip svelte-ahpgzm"),r(S,"class","avator svelte-ahpgzm"),r(T,"class","message svelte-ahpgzm"),r(b,"class","content-area svelte-ahpgzm"),r(s,"class","item svelte-ahpgzm"),o(s,"self",e[0](e[16].sender)),this.first=s},m(t,n){c(t,s,n),l(s,_),l(_,w),l(s,v),l(s,b),l(b,S),l(S,I),l(b,M),l(b,T),l(T,$),l(s,E),L||(O=h(D=gt.call(null,s,0===e[18]?{introend:e[14]}:{})),L=!0)},p(t,n){e=t,2&n&&C!==(C=new Date(e[16].time).toLocaleTimeString()+"")&&d(w,C),2&n&&j!==(j=e[16].sender+"")&&d(I,j),2&n&&k!==(k=e[16].content+"")&&d($,k),D&&u(D.update)&&18&n&&D.update.call(null,0===e[18]?{introend:e[14]}:{}),3&n&&o(s,"self",e[0](e[16].sender))},i(t){B||p((()=>{B=g(s,f,{delay:100*Math.log2(e[18]+1),duration:300,y:e[4]?-50:50,opacity:0}),B.start()}))},o:y,d(t){t&&m(s),L=!1,O()}}}function pt(t){let e,s,i,h,d,u,p,g,f,I,T,$,E,D=[],B=new Map,L=t[1];const O=t=>t[16].time;for(let n=0;n<L.length;n+=1){let e=dt(t,L,n),s=O(e);B.set(s,D[n]=ut(s,e))}return{c(){e=n("ul");for(let t=0;t<D.length;t+=1)D[t].c();s=a(),i=n("div"),h=n("input"),d=a(),u=n("button"),u.textContent="发送",p=a(),g=n("div"),f=n("button"),f.textContent="同步",I=a(),T=n("button"),T.textContent="清空",r(e,"class","list svelte-ahpgzm"),o(e,"syncing",t[5]),r(h,"type","text"),r(h,"class","word-to-send svelte-ahpgzm"),h.disabled=t[3],r(h,"placeholder","请输入要发送的内容"),r(u,"class","do-send svelte-ahpgzm"),o(u,"activing",t[3]),r(i,"class","msgcontroller-panel svelte-ahpgzm"),r(f,"class","do-sync svelte-ahpgzm"),o(f,"activing",t[5]),r(T,"class","do-sync svelte-ahpgzm"),o(T,"activing",t[5]),r(g,"class","controller-panel svelte-ahpgzm")},m(n,a){c(n,e,a);for(let t=0;t<D.length;t+=1)D[t].m(e,null);c(n,s,a),c(n,i,a),l(i,h),_(h,t[2]),l(i,d),l(i,u),c(n,p,a),c(n,g,a),l(g,f),l(g,I),l(g,T),$||(E=[w(h,"input",t[15]),w(u,"click",t[6]),w(f,"click",t[7]),w(T,"click",t[8])],$=!0)},p(t,[s]){19&s&&(L=t[1],D=v(D,s,O,1,t,L,B,e,M,ut,null,dt)),32&s&&o(e,"syncing",t[5]),8&s&&(h.disabled=t[3]),4&s&&h.value!==t[2]&&_(h,t[2]),8&s&&o(u,"activing",t[3]),32&s&&o(f,"activing",t[5]),32&s&&o(T,"activing",t[5])},i(t){for(let e=0;e<L.length;e+=1)b(D[e])},o:y,d(t){t&&m(e);for(let e=0;e<D.length;e+=1)D[e].d();t&&m(s),t&&m(i),t&&m(p),t&&m(g),$=!1,S(E)}}}function gt(t,e){const s=Object.entries(e).map((([e,s])=>[e,t.addEventListener(e,s)]));return{destroy(){s.forEach((([e,s])=>{t.removeEventListener(e,s)}))}}}function ft(t,e,s){let n=[],i="",a=!1;let r=!0,o=!1;const c=()=>T(void 0,void 0,void 0,(function*(){if(!o){s(5,o=!0);try{yield h(),s(1,n=yield d())}finally{s(5,o=!1)}}}));let{doSend:l=(t=>{})}=e,{doSync:h=(()=>{})}=e,{getList:d=(()=>[])}=e,{doClear:u=(()=>{})}=e,{isSelf:p=(t=>!1)}=e;I(c);return t.$$set=t=>{"doSend"in t&&s(9,l=t.doSend),"doSync"in t&&s(10,h=t.doSync),"getList"in t&&s(11,d=t.getList),"doClear"in t&&s(12,u=t.doClear),"isSelf"in t&&s(0,p=t.isSelf)},[p,n,i,a,r,o,()=>T(void 0,void 0,void 0,(function*(){if(a)return;const t=i.trim();if(0!==t.length){s(3,a=!0);try{yield h(),console.log("do send",t),yield l(t),s(2,i=""),s(1,n=yield d())}finally{s(3,a=!1)}}})),c,()=>T(void 0,void 0,void 0,(function*(){s(5,o=!0);try{yield u(),s(1,n=yield d())}finally{s(5,o=!1)}})),l,h,d,u,()=>c(),()=>s(4,r=!1),function(){i=this.value,s(2,i)}]}class yt extends t{constructor(t){super(),e(this,t,ft,pt,s,{doSend:9,doSync:10,getList:11,doClear:12,isSelf:0,onListChanged:13})}get onListChanged(){return this.$$.ctx[13]}}let mt=class{};mt=$([E()],mt);let _t=class{};_t=$([E()],_t);class wt extends _t{}const vt=(t,e,s)=>(n,i,a)=>{const r=a.value;if("function"!=typeof r)throw new TypeError;const o=async function(...n){const i=new B;this[s]=i.promise;const a=r.apply(this,n);return this[e].requestTransaction(t,(t=>(i.resolve(t),a)))};return Reflect.set(o,"source",r),a.value=o,a};let bt=class{calcBranchId(t){const e=t-this.startTime;if(e<0)throw new RangeError("invald time: "+t);let s=e/this.timespan;return s%1==0&&(s+=1),Math.ceil(s)}calcNextBranchId(t){let e=t/this.branchGroupCount;return e%1==0&&(e+=1),Math.ceil(e)}calcBranchIdRange(t){const e=(t-1)*this.branchGroupCount;return{start:e+1,end:e+this.branchGroupCount}}};bt=$([E()],bt);let St=class{msgIsSign(t,e){return this.signIsSign(this.getSignature(t),e)}signIsSign(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0}compareMessage(t,e){const s=this.getCreateTime(t),n=this.getCreateTime(e);if(s<n)return-1;if(s>n)return 1;const i=this.getSignature(t),a=this.getSignature(e);if(i.length<a.length)return-1;if(i.length>a.length)return 1;for(let r=0;r<i.length;++r){const t=i[r],e=a[r];if(t<e)return-1;if(t>e)return 1}return 0}};var It,Mt,Tt,$t,Et,Dt;St=$([E()],St);let Bt=class{constructor(t,e,s,n){this.config=t,this.cryptoHelper=e,this.messageHelper=n,this._store=s.fork(["timeline"])}async addLeaf(t){return this._addLeaf(t,await this._trs)}async hasManyLeaf(t){const e=await this._trs;return this._batchHas(t,e)}async _batchHas(t,e){const{messageHelper:s}=this,n=[],i=new Map;for(const a of t){const t=this.config.calcBranchId(s.getCreateTime(a));let r=i.get(t);if(void 0===r&&(r=await e.getJsObject(["blocks",`block-${t}`])||null,i.set(t,r)),null!==r){const t=s.getSignature(a),e=jt(t,r.indexedDigit),i=r.mapData.get(e);if(void 0!==i){n.push(s.msgIsSign(i,t));continue}}n.push(!1)}return n}async _addLeaf(t,e){const{messageHelper:s}=this,n=s.getCreateTime(t),i=this.config.calcBranchId(n),a=["blocks",`block-${i}`],r=await e.getJsObject(a)||{indexedDigit:8,mapData:new Lt},o=s.getSignature(t);do{const e=jt(o,r.indexedDigit),n=r.mapData.get(e);if(void 0===n){r.mapData.set(e,t);break}if(s.msgIsSign(n,o))return!1;if(256===r.indexedDigit)throw console.error("signature should be equal",o,n),new Error("out of indexedDigit");const i=r.indexedDigit=2*r.indexedDigit,a=new Map;for(const t of r.mapData.values())a.set(jt(s.getSignature(t),i),t);r.mapData=a}while(r.indexedDigit<=256);let c=0,l=0,h=i;const d=[];do{++c,l=this.config.calcNextBranchId(h),d.unshift({paths:["tree-hash",`level-${c}`,`branch-${l}`],dirtyBranchId:h}),h=l}while(1!==l);for(const u of d){let t=await e.getJsObject(u.paths);if(void 0!==t){if(t.subDirty.has(u.dirtyBranchId))continue;t.dirty=!0,t.subDirty.add(u.dirtyBranchId),t.subHash.delete(u.dirtyBranchId)}else t={hash:kt,dirty:!0,subDirty:new Set([u.dirtyBranchId]),subHash:new Map};await e.setJsObject(u.paths,t)}return await e.setJsObject(a,r),{branchId:i}}async addManyLeaf(t){const e=await this._trs,s=[];for(const n of t)s.push({success:await this._addLeaf(n,e),leaf:n});return s}getLeafFromBranchData(t,e){const s=jt(e,t.indexedDigit),n=t.mapData.get(s);if(n&&this.messageHelper.msgIsSign(n,e))return n}async getBranchData(t){const e=["blocks",`block-${t}`];return this._store.getJsObject(e)}async _getBlockHash(t){const e=await this._store.getBinary(["blocks",`block-${t}`]);return e?await this.cryptoHelper.sha256Binary(e):kt}async _getBranchHash(t,e,s){if(0===s){const s=["level-1",`branch-${this.config.calcNextBranchId(e)}`],n=await t.getJsObject(s);if(void 0===n)return kt;const i=n.subDirty.has(e)||n.subHash.get(e);let a=kt;return!0===i?(a=await this._getBlockHash(e),0===a.length?n.subHash.delete(e):n.subHash.set(e,a),n.subDirty.delete(e),await t.setJsObject(s,n)):void 0!==i&&(a=i),a}const n=[`level-${s}`,`branch-${e}`],i=await t.getJsObject(n);if(void 0===i)return kt;if(!1===i.dirty)return i.hash;if(0!==i.subDirty.size){const e=s-1;if(0===e)for(const t of i.subDirty){const e=await this._getBlockHash(t);0===e.length?i.subHash.delete(t):i.subHash.set(t,e)}else for(const s of i.subDirty){const n=await this._getBranchHash(t,s,e);0===n.length?i.subHash.delete(s):i.subHash.set(s,n)}i.subDirty.clear()}const a=[...i.subHash].sort(((t,e)=>t[0]-e[0]));switch(a.length){case 0:i.hash=kt;break;case 1:i.hash=a[0][1];break;default:const t=this.cryptoHelper.sha256HashBuilder();for(const e of a)t.update(e[1]);i.hash=await t.digest()}return i.dirty=!1,await t.setJsObject(n,i),i.hash}async getBranchRoute(t){const e=await this._trs_th;let s=0,n=this.config.calcBranchId(t);const i=[{level:s,branchId:n,hash:await this._getBranchHash(e,n,s)}];for(;1!==n;)n=this.config.calcNextBranchId(n),s+=1,i.push({level:s,branchId:n,hash:await this._getBranchHash(e,n,s)});return i}async getBranchChildren(t,e){const s=await this._trs_th;if(e<1)throw new RangeError(`invalid branch level: ${e} when get branch(${t})`);const n=await s.getJsObject([`level-${e}`,`branch-${t}`]),i=new Map;if(void 0!==n){const t=e-1;for(const e of[...n.subDirty,...n.subHash.keys()]){const n=await this._getBranchHash(s,e,t);0!==n.length&&i.set(e,n)}}return i}};$([vt([],"_store","_trs"),D("design:type",Function),D("design:paramtypes",[Object]),D("design:returntype",Promise)],Bt.prototype,"addLeaf",null),$([vt([],"_store","_trs"),D("design:type",Function),D("design:paramtypes",["function"==typeof(It="undefined"!=typeof Iterable&&Iterable)?It:Object]),D("design:returntype",Promise)],Bt.prototype,"hasManyLeaf",null),$([vt([],"_store","_trs"),D("design:type",Function),D("design:paramtypes",["function"==typeof(Mt="undefined"!=typeof Iterable&&Iterable)?Mt:Object]),D("design:returntype",Promise)],Bt.prototype,"addManyLeaf",null),$([vt(["tree-hash"],"_store","_trs_th"),D("design:type",Function),D("design:paramtypes",[Number]),D("design:returntype",Promise)],Bt.prototype,"getBranchRoute",null),$([vt(["tree-hash"],"_store","_trs_th"),D("design:type",Function),D("design:paramtypes",[Number,Number]),D("design:returntype",Promise)],Bt.prototype,"getBranchChildren",null),Bt=$([E(),D("design:paramtypes",["function"==typeof(Tt=void 0!==bt&&bt)?Tt:Object,"function"==typeof($t=void 0!==mt&&mt)?$t:Object,"function"==typeof(Et=void 0!==wt&&wt)?Et:Object,"function"==typeof(Dt=void 0!==St&&St)?Dt:Object])],Bt);class Lt extends Map{constructor(){super(...arguments),this._okl=[]}get[Symbol.toStringTag](){return"OrderMap"}set(t,e){if(Number.isNaN(t))throw new TypeError("order-map's key must be finite number");const s=this.size;return super.set(t,e),this.size!==s&&(this._okl.push(t),this._okl.sort()),this}delete(t){return!!super.delete(t)&&(this._okl.splice(this._okl.indexOf(t)),!0)}keys(){return this._okl[Symbol.iterator]()}*entries(){for(const t of this._okl)yield[t,this.get(t)]}[Symbol.iterator](){return this.entries()}toMap(){return new Map(this)}static fromMap(t){const e=new Lt(t);return e._okl=[...t.keys()].sort(),e}}const Ot=(t,e)=>{switch(e){case 8:return t[0]||0;case 16:return((t[0]||0)<<8)+(t[1]||0);case 32:return(Ot(t,16)<<16)+Ot(t.slice(16),16)}},Ct=(t,e)=>{switch(e){case 64:return(BigInt(Ot(t,32))<<32n)+BigInt(Ot(t.slice(32),32));case 128:return(BigInt(Ct(t,64))<<64n)+BigInt(Ct(t.slice(64),64));case 256:return(BigInt(Ct(t,128))<<128n)+BigInt(Ct(t.slice(128),128))}},jt=(t,e)=>e<=32?Ot(t,e):Ct(t,e),kt=new Uint8Array(0);let Nt=class{max(t,e=this.now()){return t>=e?t:e}};Nt=$([E()],Nt);const Ht=(t,e,s)=>{const n=t.getJsObject(e);return void 0!==n&&"then"in n?n.then((t=>s(t))):s(n)};var xt;let Rt=class{constructor(t){this.storage=t}addAudio(t){this.storage.setBinary(["assets","audio"],t)}addVideo(t){this.storage.setBinary(["assets","video"],t)}addDocument(t){this.storage.setBinary(["assets","document"],t)}addPicture(t){this.storage.setBinary(["assets","picture"],t)}addCode(t){this.storage.setBinary(["assets","code"],t)}async addFile(t){this.storage.setBinary(["assets",t.type],new Uint8Array(await t.arrayBuffer()))}};Rt=$([E(),D("design:paramtypes",["function"==typeof(xt=void 0!==wt&&wt)?xt:Object])],Rt);class At extends Nt{now(){return Date.now()}}var Pt,Ft,Gt,qt,Ut,zt,Jt,Yt;const Wt=(t,e)=>t<e?-1:t>e?1:0,Qt=(t,e)=>t<e?1:t>e?-1:0;let Kt=class{constructor(t,e){this.config=t,this.timeHelper=e,this._cache=new Map}getDataList(t,e){const s=[`receipt-${e}`];let n=this._cache.get(e);if(!n&&(n={lastUpdateTime:this.timeHelper.now(),dataList:Ht(t,s,(t=>t||[]))},this._cache.set(e,n),this._cache.size>3)){const t=this.timeHelper.now();for(const[e,s]of this._cache){if(s.lastUpdateTime+1e4>t)break;void 0===s.writerQueue&&this._cache.delete(e)}}return n.dataList}setDataList(t,e,s){let n=this._cache.get(e);const i=this.timeHelper.now();n?(this._cache.delete(e),n.lastUpdateTime=i,n.dataList=s):n={dataList:s,lastUpdateTime:i},this._cache.set(e,n);let a=n.writerQueue;if(void 0===a){a=n.writerQueue=new B;const s=n,i=a;queueMicrotask((async()=>{const n=[`receipt-${e}`];s.writerQueue=void 0;try{await t.setJsObject(n,s.dataList),i.resolve()}catch(a){i.reject(a)}}))}return a.promise}_getBranchMetaGroup(t,e){var s;if((null==(s=this._metaCache)?void 0:s.groupId)!==e){this._metaCache={groupId:e,cache:void 0};const s=this._metaCache;s.cache=Ht(t,["meta-branch",`group-${e}`],(t=>(s.cache=t,t)))}return this._metaCache.cache}_setBranchMetaGroup(t,e,s){return this._metaCache={groupId:e,cache:s},t.setJsObject(["meta-branch",`group-${e}`],s)}async getBranchMeta(t,e){const s=this.config.calcNextBranchId(e),n=await this._getBranchMetaGroup(t,s);return null==n?void 0:n.map.get(e)}async setBranchMeta(t,e,s){const n=this.config.calcNextBranchId(e),i=await this._getBranchMetaGroup(t,n)||{groupId:n,map:new Map};return i.map.set(e,s),this._setBranchMetaGroup(t,n,i)}async upsertBranchMeta(t,e,s){const n=await this.getBranchMeta(t,e)||{preBranchId:e,nextBranchId:e};return this.setBranchMeta(t,e,Object.assign(n,s))}async*BranchIdWalker(t,e,s=Zt.UP){const n=this.config.calcNextBranchId(e);let i;if(i=await this._getBranchMetaGroup(t,n),void 0===i){const{files:e}=await t.listPaths(["meta-branch"]),a=[];for(const t of e)t.startsWith("group-")&&a.push(+t.slice(6));a.sort(s===Zt.DOWN?Qt:Wt);let r=a.findIndex((t=>Wt(n,t)!==s));if(-1===r)return;for(;r<a.length;){const e=a[r];if(i=await this._getBranchMetaGroup(t,e),void 0!==i)break;console.error(new Error(`数据库异常，可能发生数据丢失(${t.currentPaths}, ${["meta-branch",`group-${e}`]})`)),r++}}for(;;){if(void 0===i)return;const n=[...i.map.keys()].sort(s===Zt.DOWN?Qt:Wt);if(0===n.length)throw new Error(`数据库异常，可能是数据丢失，索引断链，需要重新整理数据重建索引(${t.currentPaths}, ${i.groupId})`);let a=n.findIndex((t=>Qt(e,t)===s));if(-1!==a)do{yield n[a]}while(++a<n.length);const r=i.map.get(n[n.length-1]),o=s===Zt.UP?r.nextBranchId:r.preBranchId,c=this.config.calcNextBranchId(o);if(c===i.groupId)return;i=await this._getBranchMetaGroup(t,c)}}};Kt=$([E(),D("design:paramtypes",["function"==typeof(Pt=void 0!==bt&&bt)?Pt:Object,"function"==typeof(Ft=void 0!==At&&At)?Ft:Object])],Kt);let Vt=class{constructor(t,e,s){this.config=t,this.timeHelper=e,this._branchHanlder=s}getMeta(t){return void 0===this._meta&&(this._meta=Ht(t,["meta"],(async e=>{if(e){if(0!==e.firstBranchId){0===(await this._branchHanlder.getDataList(t,e.firstBranchId)).length&&(e.firstBranchId=0)}if(e.lastBranchId!==e.secondLastBranchId){0===(await this._branchHanlder.getDataList(t,e.lastBranchId)).length&&(e.lastBranchId=e.secondLastBranchId)}}return this._meta=null!=e?e:{firstBranchId:0,lastBranchId:0,secondLastBranchId:0}}))),this._meta}setMeta(t,e){return t.setJsObject(["meta"],e)}};Vt=$([E(),D("design:paramtypes",["function"==typeof(Gt=void 0!==bt&&bt)?Gt:Object,"function"==typeof(qt=void 0!==At&&At)?qt:Object,Kt])],Vt);let Xt=class{constructor(t,e,s,n,i){this.config=t,this.timeHelper=e,this._branchHanlder=n,this._metaHanlder=i,this._perNow=0,this._store=s.fork(["datalist"])}async _upsertMetaWhenAddNewItem(t,e){const s=await this._metaHanlder.getMeta(t);let n=0;if(0===s.firstBranchId)s.firstBranchId=e,s.secondLastBranchId=e,s.lastBranchId=e;else{if(!(s.lastBranchId<e)){if(s.lastBranchId===e)return;throw new Error("NOSUPPORT: new-branchId should not less then last-branchId")}n=s.secondLastBranchId=s.lastBranchId,s.lastBranchId=e}await this._metaHanlder.setMeta(t,s),0!==n&&await this._branchHanlder.upsertBranchMeta(t,n,{nextBranchId:e}),await this._branchHanlder.setBranchMeta(t,e,{preBranchId:n,nextBranchId:e})}async addItem(t,e=this.timeHelper.now()){const s=this.timeHelper.max(this._perNow+1,e);this._perNow=s;const n=this.config.calcBranchId(s),i=await this._trs;await this._upsertMetaWhenAddNewItem(i,n);const a=await this._branchHanlder.getDataList(i,n);return a.push({insertTime:s,data:t}),await this._branchHanlder.setDataList(i,n,a),e}async addManyItem(t,e=this.timeHelper.now()){const s=await this._trs;let n,i=0;const a=[];for(const r of t){const t=this.timeHelper.max(this._perNow+1,e);a.push(t),this._perNow=t;const o=this.config.calcBranchId(t);o!==i&&(await this._upsertMetaWhenAddNewItem(s,o),void 0!==n&&(await this._branchHanlder.setDataList(s,i,n),n=void 0),i=o),void 0===n&&(n=await this._branchHanlder.getDataList(s,o)),n.push({insertTime:t,data:r})}return n&&await this._branchHanlder.setDataList(s,i,n),a}async*ItemReader(t,e=Zt.UP){let s,n=this.config.calcBranchId(t);for(;;){const i=await this._branchHanlder.getDataList(this._store,n);let a=0,r=i.length;if(0!==i.length)for(e===Zt.DOWN&&(a=r-1,r=-1);a!==r;){const s=i[a];Wt(t,s.insertTime)!==e&&(yield s),a+=e}null!=s||(s=this._branchHanlder.BranchIdWalker(this._store,n,e));const o=await s.next();if(o.done)return;n=o.value}}};var Zt,te,ee,se,ne,ie,ae,re;$([vt([],"_store","_trs"),D("design:type",Function),D("design:paramtypes",[Object,Object]),D("design:returntype",Promise)],Xt.prototype,"addItem",null),$([vt([],"_store","_trs"),D("design:type",Function),D("design:paramtypes",["function"==typeof(Ut="undefined"!=typeof Iterable&&Iterable)?Ut:Object,Object]),D("design:returntype",Promise)],Xt.prototype,"addManyItem",null),Xt=$([E(),D("design:paramtypes",["function"==typeof(zt=void 0!==bt&&bt)?zt:Object,"function"==typeof(Jt=void 0!==At&&At)?Jt:Object,"function"==typeof(Yt=void 0!==wt&&wt)?Yt:Object,Kt,Vt])],Xt),(te=Zt||(Zt={}))[te.UP=1]="UP",te[te.DOWN=-1]="DOWN";const oe={SYNC_CHANNE:Symbol("syncChannnel")};let ce=class{constructor(t,e,s,n,i,a){this.syncChannel=t,this.timelineTree=e,this.dataList=s,this.timeHelper=n,this.msgHelper=i,this.config=a,this.taskSeq=new pe({}),this.responser=new ge(this.taskSeq,{executeTask:async({reqId:t,args:e})=>{switch(e.cmd){case he.GET_BRANCH_ROUTE:{const s=await this.timelineTree.getBranchRoute(e.leafTime);this.syncChannel.postMessage([t,s])}break;case he.GET_BRANCH_CHILDREN:{const s=await this.timelineTree.getBranchChildren(e.branchId,e.level);this.syncChannel.postMessage([t,s])}break;case he.DOWNLOAD_BY_BRANCHID:{const s=await this.timelineTree.getBranchData(e.branchId);this.syncChannel.postMessage([t,s])}break;default:console.error("unknown task cmd:",e)}}}),this._reqIdAcc=1,this._reqMap=new Map,t.onMessage=t=>{var e;if(!Array.isArray(t)||2!==t.length)return;const[s,n]=t;if(n!==he.ABORT)if(n!==he.REFUSE)if(n&&"cmd"in n)!1===this.taskSeq.push(s,{reqId:s,args:n,controller:void 0})&&this.syncChannel.postMessage([s,he.REFUSE]);else{const t=this._reqMap.get(s);t&&(this._reqMap.delete(s),t.resolve(n))}else{const t=this._reqMap.get(s);t&&t.reject(ue)}else{const t=this.taskSeq.get(s);t&&(this.taskSeq.delete(s),null==(e=t.controller)||e.abort())}},this.responser.startResponse()}requestMessage(t,e){return new Promise(((s,n)=>{const i=null==e?void 0:e.signal;if(i){const t=n;n=e=>{this._reqMap.delete(a),e!==ue&&this.syncChannel.postMessage([a,he.ABORT]),t(e)},i.addEventListener("abort",n);const e=s;s=t=>{i.removeEventListener("abort",n),e(t)}}const a=this._reqIdAcc++;this._reqMap.set(a,{resolve:s,reject:n}),this.syncChannel.postMessage([a,t])}))}async doSync(t=this.timeHelper.now()){const{msgHelper:e,timelineTree:s,dataList:n}=this,i=new le,a=[],r=await s.getBranchRoute(t),o=await this.requestMessage({cmd:he.GET_BRANCH_ROUTE,leafTime:t});r.sort(((t,e)=>e.level-t.level)),o.sort(((t,e)=>e.level-t.level));const c=r[0],l=o[0],{branchId:h,level:d,hash:u}=l;if(c.branchId!==h||c.level!==d)throw new Error(`invalid remote branch info: ${d}(level)/${h}/(branchId) when ${new Date(t).toLocaleString()}`);return 0!==u.length&&!e.signIsSign(c.hash,u)&&(await this._syncBranch(e,s,n,h,d,i,a),a.length>0&&(await(async(t,e,s,n)=>{const i=await e.addManyLeaf(n),a=[],r=[];for(const o of i)!1!==o.success?(a.push({sign:t.getSignature(o.leaf),branchId:o.success.branchId}),r.push(!0)):r.push(!1);return await s.addManyItem(a),r})(e,s,n,a.flat()),!0))}async _syncBranch(t,e,s,n,i,a,r){if(a.has(n,i))return!1;if(0===i){const t=await this.requestMessage({cmd:he.DOWNLOAD_BY_BRANCHID,branchId:n});if(void 0===t)return!1;const s=[...t.mapData.values()],i=await e.hasManyLeaf(s),a=s.filter(((t,e)=>!1===i[e]));return a.length>0&&(r.push(a),!0)}const o=await this.requestMessage({cmd:he.GET_BRANCH_CHILDREN,branchId:n,level:i}),c=await e.getBranchChildren(n,i),l=[];for(const[d,u]of o){const e=c.get(d);!1===(void 0!==e&&t.signIsSign(u,e))&&l.push(d)}l.sort();let h=!1;for(const d of l){const n=await this._syncBranch(t,e,s,d,i-1,a,r);h||(h=n)}return h}};ce.ARGS=oe,ce=$([E(),L(0,O(oe.SYNC_CHANNE)),D("design:paramtypes",["function"==typeof(ee=void 0!==ce&&ce.Channel)?ee:Object,"function"==typeof(se=void 0!==Bt&&Bt)?se:Object,"function"==typeof(ne=void 0!==Xt&&Xt)?ne:Object,"function"==typeof(ie=void 0!==At&&At)?ie:Object,"function"==typeof(ae=void 0!==St&&St)?ae:Object,"function"==typeof(re=void 0!==bt&&bt)?re:Object])],ce);class le{constructor(){this._s=new Map}add(t,e){let s=this._s.get(e);void 0===s&&this._s.set(e,s=new Set),s.add(t)}has(t,e){const s=this._s.get(e);return void 0!==s&&s.has(t)}}var he,de;(de=he||(he={}))[de.REFUSE=0]="REFUSE",de[de.ABORT=1]="ABORT",de[de.GET_BRANCH_ROUTE=2]="GET_BRANCH_ROUTE",de[de.GET_BRANCH_CHILDREN=3]="GET_BRANCH_CHILDREN",de[de.DOWNLOAD_BY_BRANCHID=4]="DOWNLOAD_BY_BRANCHID";const ue=Symbol("reason:refuse by remote");class pe{constructor(t){this.config=t,this._queue=new Map}push(t,e){if(this._waitter)this._waitter.resolve(e),this._waitter=void 0;else{if(this._queue.has(t))return!1;this._queue.set(t,e)}return!0}get(t){return this._queue.get(t)}has(t){return this._queue.has(t)}delete(t){return this._queue.delete(t)}shift(){if(0===this._queue.size)return(this._waitter=new B).promise;for(const[t,e]of this._queue)return this._queue.delete(t),e;throw 1}}class ge{constructor(t,e){this.taskSeq=t,this.config=e}async*_ResponseQueue(){for(;;){const e=await this.taskSeq.shift();try{await this.config.executeTask(e)}catch(t){console.error("responser execute task error:",e,t)}yield}}startResponse(){if(void 0!==this._looper)return!1;const t=this._looper=this._ResponseQueue();return(async()=>{for await(const e of t);})().catch((t=>{console.info("responser stoped.",t)})),!0}stopResponse(t){return void 0!==this._looper&&(this._looper.throw(t),this._looper=void 0,!0)}}var fe,ye,me,_e,we,ve,be,Se;let Ie=class{constructor(t,e,s,n,i,a,r,o){this.msgHelper=t,this.config=e,this.timeHelper=s,this.timelineTree=n,this.dataList=i,this.assets=a,this.sync=r,this.storage=o}addMsg(t){return(async(t,e,s,n)=>{const i=await e.addLeaf(n);if(!1!==i){const{branchId:e}=i;return await s.addItem({sign:t.getSignature(n),branchId:e}),!0}return!1})(this.msgHelper,this.timelineTree,this.dataList,t)}$getMsgListOptionsToQuery(t={}){const{offset:e=0,limit:s=40,order:n=Zt.DOWN}=t;return{offset:e,limit:s,order:n}}async getMsgList(t,e={}){const{offset:s,limit:n,order:i}=this.$getMsgListOptionsToQuery(e),a=[],r=new Map;let o=0;for await(const l of this.dataList.ItemReader(t,i))if(o<s)++o;else{if(a.length>=n)break;a.push(l),!1===r.has(l.data.branchId)&&r.set(l.data.branchId,this.timelineTree.getBranchData(l.data.branchId))}const c=[];for(const l of a){let t=r.get(l.data.branchId);if(t&&"then"in t&&(t=await t,r.set(l.data.branchId,t)),void 0===t){console.error(new Error("数据发生了残缺丢失的问题，需要对数据重建索引"));continue}const e=this.timelineTree.getLeafFromBranchData(t,l.data.sign);void 0!==e?c.push({receiptTime:l.insertTime,content:e}):console.error(new Error("数据发生了残缺丢失的问题，可能需要同步数据"))}return c}clear(){return this.storage.del([])}};Ie=$([E(),D("design:paramtypes",["function"==typeof(fe=void 0!==St&&St)?fe:Object,"function"==typeof(ye=void 0!==bt&&bt)?ye:Object,"function"==typeof(me=void 0!==Nt&&Nt)?me:Object,"function"==typeof(_e=void 0!==Bt&&Bt)?_e:Object,"function"==typeof(we=void 0!==Xt&&Xt)?we:Object,"function"==typeof(ve=void 0!==Rt&&Rt)?ve:Object,"function"==typeof(be=void 0!==ce&&ce)?be:Object,"function"==typeof(Se=void 0!==wt&&wt)?Se:Object])],Ie);let Me=class{};var Te,$e,Ee,De,Be,Le;Me=$([E()],Me);const Oe={CHATS_CHANNE:Symbol("chats-channel")},Ce=t=>{throw new Error("should never happend")};let je=class{constructor(t,e,s,n,i,a){this.storage=t,this.helper=e,this.config=s,this._timeHelper=n,this._msgHelper=i,this._cryptoHelper=a,this._ready=new B,this._sessionMap=new Map,this._sessionList=[],this._laliaMap=new Map,this._store=t.fork(["chat-app"]),this._initMemory(),this._initMessageListen()}async _initMemory(){const t=await this._trs,{files:e}=await t.listPaths([]);for(const s of e){const e=await t.getJsObject([s]);void 0===e?await t.del([s]):(this._sessionMap.set(s,e),this._sessionList.push(e))}this._sessionList=[...this._sessionMap.values()].sort(((t,e)=>this.helper.compare(t,e))),this._ready.resolve()}async _initMessageListen(){await this._ready.promise,this.helper.onNewMessage=async t=>{var e,s,n,i,a;switch(t[0]){case ke.MSG:{if(void 0===this._sessionMap.get(t[1]))return;const s=this._getCryptolalia(t[1]);!0===await s.cryptolalia.addMsg(t[2])&&await(null==(e=this.onNewMessage)?void 0:e.call(this,[t[1],t[2]]))}break;case ke.SYNC:{const e=this._laliaMap.get(t[1]);void 0!==e&&await(null==(n=(s=e.syncChannel).onMessage)?void 0:n.call(s,t[2]))}break;case ke.SESSION:await(null==(a=(i=this.helper).handshakeSession)?void 0:a.call(i,t[1],t[2]))}};const t=this._sessionList.slice();for(const e of t){const t=this.helper.getSessionId(e);if(this._sessionMap.has(t)){const e=await this._getCryptolalia(t);await e.cryptolalia.sync.doSync()}}}_doSort(){this._sessionList.sort(((t,e)=>this.helper.compare(t,e)))}get _needEmitOrderChange(){return void 0!==this.onOrderChange}_emitOrderChange(t){let e=this._orderChangeEntryCollection;if(void 0===e){e=new Map;const t=e;queueMicrotask((()=>{var e;this._orderChangeEntryCollection=void 0,null==(e=this.onOrderChange)||e.call(this,{entries:t.values()})}))}let s=e.get(t.sessionId);if(void 0!==s)if("insert"===s.type){if("insert"===t.type)throw new TypeError(`duplication insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):Ce(t.type)}else if("update"===s.type){if("insert"===t.type)throw new TypeError(`invalid insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):Ce(t.type)}else if("delete"===s.type)if("insert"===t.type)e.set(t.sessionId,t);else{if("update"===t.type)throw new TypeError(`invalid update sessionId: '${t.sessionId}'`);if("delete"===t.type)throw new TypeError(`duplication delete sessionId: '${t.sessionId}'`);Ce(t.type)}else Ce(s.type);else e.set(t.sessionId,t)}async addSession(t,e){if(this._ready.is_resolved||await this._ready.promise,this._sessionMap.has(t))return!1;if(this._sessionMap.set(t,e),this._sessionList.unshift(e),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"insert",index:s,sessionId:t})}if(void 0!==this.helper.handshakeSession){const s=await this.helper.handshakeSession(t);void 0!==s&&await this.helper.sendMessage(e,[ke.SESSION,t,s])}return!0}async getSessionInfo(t){return this._ready.is_resolved||await this._ready.promise,this._sessionMap.get(t)}async updateSession(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._sessionList.indexOf(s);if(s!==e&&(this._sessionMap.set(t,e),this._sessionList.splice(n,1,e)),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"update",index:s,oldIndex:n,sessionId:t})}return!0}async getSessionList(t={}){this._ready.is_resolved||await this._ready.promise;const{offset:e=0,limit:s=1/0}=t;return this._sessionList.slice(e,s+e)}_getCryptolalia(t){let e=this._laliaMap.get(t);if(void 0===e){const s={postMessage:e=>{const s=this._sessionMap.get(t);if(void 0!==s)return this.helper.sendMessage(s,[ke.SYNC,t,e])}},n=C(Ie,new j([[k(wt),this.storage.fork([t])],[ce.ARGS.SYNC_CHANNE,s],[k(Nt),this._timeHelper],[k(bt),this.config],[k(St),this._msgHelper],[k(mt),this._cryptoHelper]]));this._laliaMap.set(t,e={cryptolalia:n,syncChannel:s})}return e}async sendMessage(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._getCryptolalia(t);if(await n.cryptolalia.addMsg(e)){return{locale:!0,remote:this.helper.sendMessage(s,[ke.MSG,t,e])}}return!1}async getMessageList(t,e){var s;if(this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t))return[];return this._getCryptolalia(t).cryptolalia.getMsgList(null!=(s=e.timestamp)?s:this._timeHelper.now(),e)}async doSync(t){if(this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t))return[];return this._getCryptolalia(t).cryptolalia.sync.doSync()}};var ke,Ne;je.ARGS=Oe,$([vt(["session"],"_store","_trs"),D("design:type",Function),D("design:paramtypes",[]),D("design:returntype",Promise)],je.prototype,"_initMemory",null),je=$([E(),D("design:paramtypes",["function"==typeof(Te=void 0!==wt&&wt)?Te:Object,"function"==typeof($e=void 0!==Me&&Me)?$e:Object,"function"==typeof(Ee=void 0!==bt&&bt)?Ee:Object,"function"==typeof(De=void 0!==Nt&&Nt)?De:Object,"function"==typeof(Be=void 0!==St&&St)?Be:Object,"function"==typeof(Le=void 0!==mt&&mt)?Le:Object])],je),(Ne=ke||(ke={}))[Ne.MSG=0]="MSG",Ne[Ne.SESSION=1]="SESSION",Ne[Ne.SYNC=2]="SYNC";class He extends mt{async sha256Binary(t){return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}sha256HashBuilder(){return new xe}}class xe extends class{}{constructor(){super(...arguments),this.chunks=[],this.len=0}update(t){return this.chunks.push(t),this.len+=t.length,this}async digest(){const t=new Uint8Array(this.len);let e=0;for(const s of this.chunks)t.set(s,e),e+=s.length;return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}}const Re=t=>{const e=t.prototype[Symbol.toStringTag];return{kind:"sequence",resolve:t=>null===t||t.length%2==0,construct(e){const s=new t;for(let t=0;t<e.length;t+=2)s.set(e[t],e[t+1]);return s},represent(s){if(!(s instanceof t))throw new TypeError(`no an ${e}`);const n=new Array(2*s.size);let i=0;for(const t of s)n[i++]=t[0],n[i++]=t[1];return n},predicate:s=>s instanceof t&&s[Symbol.toStringTag]===e}},Ae=N.DEFAULT_SCHEMA.extend([new H("tag:bfchain.org,2021:js/ordermap",Re(Lt)),new H("tag:bfchain.org,2021:js/map",Re(Map)),new H("tag:bfchain.org,2021:js/set",{kind:"sequence",resolve:t=>!0,construct(t){const e=new Set;for(let s=0;s<t.length;++s)e.add(t[s]);return e},represent(t){if(!(t instanceof Set))throw new TypeError("no an set");return[...t]},predicate:t=>t instanceof Set&&"Set"===t[Symbol.toStringTag]})]),Pe=new TextDecoder,Fe=t=>N.load(Pe.decode(t),{schema:Ae}),Ge=new TextEncoder,qe=t=>Ge.encode(N.dump(t,{schema:Ae}));class Ue extends _t{constructor(t){super(),this.currentPaths=t,this._memFolder=new Map}setBinary(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{binary:e})}_makeFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i&&s.set(e,i={folder:new Map}),!("folder"in i))throw new Error("no an paths:"+t);s=i.folder}return s}_getFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i)return;if(!("folder"in i))return;s=i.folder}return s}_getFile(t){let e=this._memFolder;for(let n=0,i=t.length-2;n<=i;n++){const s=t[n],i=e.get(s);if(void 0===i||!("folder"in i))return;e=i.folder}const s=e.get(t[t.length-1]);if(void 0!==s&&!("folder"in s))return s}getBinary(t){const e=this._getFile(t);if(void 0!==e)return"binary"in e?e.binary:e.binary=qe(e.jsobj)}getJsObject(t){const e=this._getFile(t);if(void 0!==e)return"jsobj"in e?e.jsobj.value:(e.jsobj={value:Fe(e.binary)}).value}setJsObject(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{jsobj:{value:e}})}has(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&e.has(t[t.length-1])}del(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&(e.clear(),!0)}listPaths(t){const e=this._getFolder(t,t.length-2),s={paths:[],files:[]};if(void 0!==e)for(const[n,i]of e)"folder"in i?s.paths.push(n):s.files.push(n);return s}*WalkFiles(t=[],e=this._memFolder){for(const[s,n]of e){const e=[...t,s];"folder"in n?yield*this.WalkFiles(e,n.folder):yield[e,n]}}}class ze{constructor(){this._delPathMap=new Map}addDel(t){let e=this._delPathMap;for(const s of t){let t=e.get(s);void 0===t&&(t=new Map,e.set(s,t)),e=t}e.clear()}isDel(t){let e=this._delPathMap;for(const s of t){const t=e.get(s);if(void 0===t)return!1;if(0===t.size)return!0;e=t}return!1}ls(){const t=(e,s)=>{const n=[];0===s.size&&0!==e.length&&n.push(e);for(const[i,a]of s)n.push(...t([...e,i],a));return n};return t([],this._delPathMap)}}class Je extends _t{constructor(){super(...arguments),this._cacheStore=new Ue(["transaction"]),this._del=new ze}setBinary(t,e){return this._cacheStore.setBinary(t,e)}async getBinary(t){const e=await this._cacheStore.getBinary(t);return void 0!==e?e:this._del.isDel(t)?void 0:await this._targetStore.getBinary(t)}async getJsObject(t){return await this._cacheStore.has(t)?await this._cacheStore.getJsObject(t):this._del.isDel(t)?void 0:await this._targetStore.getJsObject(t)}setJsObject(t,e){return this._cacheStore.setJsObject(t,e)}async has(t){return!!(await this._cacheStore.has(t))||!this._del.isDel(t)&&await this._targetStore.has(t)}async del(t){return(!1!==await this._cacheStore.del(t)||!this._del.isDel(t))&&(this._del.addDel(t),!0)}async listPaths(t){const e=await this._cacheStore.listPaths(t);if(0===e.files.length&&0===e.paths.length&&this._del.isDel(t))return e;const s=await this._targetStore.listPaths(t);return{files:0===e.files.length?s.files:s.files.concat(e.files),paths:0===e.paths.length?s.paths:s.paths.concat(e.paths)}}}var Ye,We,Qe=(t=>(t.PATH_SEP="/",t[t.FILE_TYPE_FLAG=1]="FILE_TYPE_FLAG",t[t.DIR_TYPE_FLAG=2]="DIR_TYPE_FLAG",t.ROOT_DIR=":root:",t))(Qe||{});class Ke{constructor(t,e){let s=!1;if("string"==typeof t&&(s=t.trimStart().startsWith("/"),t=t.split("/").map((t=>t.trim()))),void 0!==e){if("string"==typeof e&&(e=e.split("/")),e=Ke.normal(e.map((t=>t.trim()))),!1===s){const s=e.concat(t);for(let t=0;t>s.length;++t){".."===s[t]&&(s.splice(t-1,2),t-=2)}t=s}if(e.length>t.length)throw new SyntaxError(`'${t}' no belong to ${e}`);for(let s=0;s<e.length;++s)if(e[s]!==t[s])throw new SyntaxError(`'${t}' no belong to ${e}`)}this.paths=Ke.normal(t)}static normal(t){return t.filter((t=>""!==t&&!1===t.endsWith(".")))}get dirname(){const t=this.paths.slice(0,-1);return t.length>0?t.join("/"):":root:"}get basename(){return this.paths[this.paths.length-1]}get fullpath(){return this.paths.join("/")}}(We=Ye||(Ye={})).FILE="file",We.DIR="dir";const Ve=new Map;class Xe{constructor(t){this.dbName=t,this._idb=(t=>{let e=Ve.get(t);return void 0===e&&(e=x(t,1,{upgrade(t,e,s,n){switch(e){case 0:t.createObjectStore(Ye.DIR,{autoIncrement:!1,keyPath:null}).put(new Map,Qe.ROOT_DIR),t.createObjectStore(Ye.FILE,{autoIncrement:!0,keyPath:null})}}}).then((e=>(Ve.set(t,e),e))),Ve.set(t,e)),e})(this.dbName)}async exists(t){const e=await this._idb,{dirname:s,basename:n}=new Ke(t),i=await e.get(Ye.DIR,s);return void 0!==i&&i.has(n)}async writeFile(t,e){const s=(await this._idb).transaction([Ye.FILE,Ye.DIR],"readwrite"),n=s.objectStore(Ye.DIR),i=s.objectStore(Ye.FILE),{dirname:a,basename:r}=new Ke(t),o=await n.get(a);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${a}'`);let c=o.get(r);if(void 0!==c){if(c.type!==Qe.FILE_TYPE_FLAG)throw new Error(`EISDIR: illegal operation on a directory, open '${r}'`);c.size=e.length,c.fid}else c={type:Qe.FILE_TYPE_FLAG,size:e.length,fid:-1},o.set(r,c);const l=await i.add(e);-1!==c.fid&&await i.delete(c.fid),c.fid=l,await n.put(o,a)}async _mkdir(t,e,s){const{dirname:n,basename:i}=new Ke(t);let a=await s.get(n);if(void 0===a){if(!1===e)throw new Error(`ENOENT: no such file or directory, mkdir '${t}'`);a=await this._mkdir(n,e,s)}const r=a.get(i);if((null==r?void 0:r.type)===Qe.FILE_TYPE_FLAG)throw new Error(`EEXIST: file already exists, mkdir '${t}'`);let o;return void 0!==r&&(o=await s.get(t)),void 0===o&&(o=new Map,await s.put(o,t),a.set(i,{type:Qe.DIR_TYPE_FLAG}),await s.put(a,n)),o}async mkdir(t,e={}){const{recursive:s=!1}=e,n=(await this._idb).transaction(Ye.DIR,"readwrite").objectStore(Ye.DIR);await this._mkdir(new Ke(t).fullpath,s,n)}async readFile(t){const e=(await this._idb).transaction([Ye.FILE,Ye.DIR],"readwrite"),s=e.objectStore(Ye.DIR),n=e.objectStore(Ye.FILE),{dirname:i,basename:a}=new Ke(t),r=await s.get(i);if(void 0===r)throw new Error(`ENOENT: no such file or directory, open '${i}'`);const o=r.get(a);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${t}'`);if(o.type===Qe.DIR_TYPE_FLAG)throw new Error("EISDIR: illegal operation on a directory, read");return await n.get(o.fid)}async _recursive_rmdir(t,e,s){const n=await e.get(t);if(void 0!==n){for(const[i,a]of n)a.type===Qe.FILE_TYPE_FLAG?await s.delete(a.fid):this._recursive_rmdir(t+Qe.PATH_SEP+i,e,s);await e.delete(t)}}async _rm(t,e,s,n,i){const{dirname:a,basename:r}=new Ke(t),o=await n.get(a);let c;if(void 0!==o&&(c=o.get(r)),void 0!==c){if(c.type===Qe.FILE_TYPE_FLAG)await i.delete(c.fid);else{if(!1===e)throw new Error(`EISDIR: Path is a directory: '${t}'`);await this._recursive_rmdir(t,n,i)}o.delete(r),await n.put(o,a)}else if(!1===s)throw new Error(`ENOENT: no such file or directory, stat '${t}'`)}async rm(t,e={}){const{recursive:s=!1,force:n=!1}=e,i=(await this._idb).transaction([Ye.FILE,Ye.DIR],"readwrite"),a=i.objectStore(Ye.DIR),r=i.objectStore(Ye.FILE);await this._rm(t,s,n,a,r)}async readdir(t){const e=(await this._idb).transaction(Ye.DIR,"readwrite").objectStore(Ye.DIR),s=await e.get(t);if(void 0===s)throw new Error(`ENOENT: no such file or directory, scandir '${t}'`);return s.entries()}}const Ze={IDB_NAME:Symbol("idbName"),TARGET_DIR:Symbol("targetDir")};let ts=class extends _t{constructor(t="usr",e="cryptolalia-tree-fs"){super(),this.targetDir=t,this.idbName=e,this.currentPaths=this.targetDir.split(Qe.PATH_SEP).map((t=>t.trim())).filter(Boolean),this._fs=new Xe(this.idbName)}async setBinary(t,e){const{dirname:s,fullpath:n}=new Ke(t,this.currentPaths);!1===await this._fs.exists(s)&&await this._fs.mkdir(s,{recursive:!0}),await this._fs.writeFile(n,e)}async getBinary(t){const{fullpath:e}=new Ke(t,this.currentPaths);if(await this._fs.exists(e))return this._fs.readFile(e)}async getJsObject(t){const e=await this.getBinary(t);if(e)return Fe(e)}setJsObject(t,e){return this.setBinary(t,qe(e))}async has(t){const{fullpath:e}=new Ke(t,this.currentPaths);return await this._fs.exists(e)}async del(t){const{fullpath:e}=new Ke(t,this.currentPaths);return!!(await this._fs.exists(e))&&(await this._fs.rm(e,{recursive:!0,force:!0}),!0)}async listPaths(t){const{fullpath:e}=new Ke(t,this.currentPaths),s=[],n=[];if(await this._fs.exists(e))for(const[i,a]of await this._fs.readdir(e))try{a.type===Qe.FILE_TYPE_FLAG?n.push(i):s.push(i)}catch{}return{paths:s,files:n}}};ts.ARGS=Ze,ts=$([L(0,O(Ze.TARGET_DIR,{optional:!0})),L(1,O(Ze.IDB_NAME,{optional:!0})),D("design:paramtypes",[String,String])],ts);class es extends Je{constructor(t,e="cryptolalia-tree-fs"){super(),this.sourceTargetDir=t,this.idbName=e,this._targetStore=new ts(this.sourceTargetDir),this.currentPaths=new Ke(this.sourceTargetDir).paths}}class ss extends ts{constructor(){super(...arguments),this._transactionMap=new Map}async startTransaction(t){const e=new Ke(t,this.targetDir).fullpath;let s=this._transactionMap.get(e);if(s){const t=new B;s.queue.push(t),await t.promise}const n={transaction:new es(e),finished:new B,queue:(null==s?void 0:s.queue)||[]};return this._transactionMap.set(e,n),n.finished.onSuccess((()=>{var t;const s=null==(t=n.queue.pop())?void 0:t.resolve;void 0===s?this._transactionMap.delete(e):s()})),n.transaction}async finishTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);if(void 0===e||e.transaction!==t)return!1;for(const n of t._del.ls())await t._targetStore.del(n);const s=t._targetStore;for(const[n,i]of t._cacheStore.WalkFiles())await s.setBinary(n,i.binary||qe(i.jsobj.value));return e.finished.resolve(),!0}requestTransaction(t,e){return(async(t,e,s)=>{const n=await t.startTransaction(e);try{const e=await s(n);return await t.finishTransaction(n),e}catch(i){throw await t.stopTransaction(n),i}})(this,t,e)}async stopTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);return void 0!==e&&e.transaction===t&&(e.finished.resolve(),!0)}fork(t){const e=new Ke(t,this.targetDir).fullpath;return new ss(e)}}class ns extends Nt{now(){return Date.now()}}var is,as;const rs=new R;A(ns,rs);const os={USER_ID:Symbol("user-id")};let cs=is=class{constructor(t,e){this.userId=t,this.moduleMap=e,this._startTimesLsKey=`${this.userId}/times`,this._msCache=new Map,this._meta_cl=(()=>{const t=`${this.userId}/metatime`;let e=localStorage.getItem(t);"string"!=typeof e&&(e=is.DEFAULT_START_TIME,localStorage.setItem(t,e));const s=new is.SuperConfig(e);return this._createCl(s,`${this.userId}-metadata`,"metadata")})(),this._msg_cl_list=this._getCryptolalias(new Set)}_getStartTimes(){if(void 0===this._startTimes){let t=localStorage.getItem(this._startTimesLsKey);"string"!=typeof t&&(t=is.DEFAULT_START_TIME,localStorage.setItem(this._startTimesLsKey,t));const e=new Map;for(const s of t.split(",").filter(Boolean)){const t=new Date(s);e.set(t.toISOString(),t)}this._startTimes=e}return this._startTimes}_addStartTime(t){const e=this._getStartTimes(),s=new Date(t);if(t=s.toISOString(),e.has(t))return!1;e.set(t,s);const n=[...e.values()].sort(((t,e)=>t.getTime()-e.getTime()));e.clear();for(const i of n)e.set(i.toISOString(),i);return this._saveStartTimes(e),!0}_saveStartTimes(t){localStorage.setItem(this._startTimesLsKey,[...t.keys()].join(","))}_getCryptolalias(t){const e=[];for(const s of this._getStartTimes().keys()){let n,i=this._msCache.get(s);if(void 0===i){const e=new is.SuperConfig(s);n={cid:s,cryptolalia:this._createCl(e,`${this.userId}-${s}`,s),syncable:t.has(s)}}else n=i.get(U(bt));e.push(n)}return e}_createCl(t,e,s){const n=new R([[U(bt),t],[ce.ARGS.SYNC_CHANNE,hs.getPort(s,this.userId)],[ss.ARGS.TARGET_DIR,e]],this.moduleMap);return A(ss,n),A(Ie,n)}get _msg_cl(){return this._msg_cl_list[this._msg_cl_list.length-1]}async getMsgList(t,e){const{limit:s,order:n}=this._meta_cl.$getMsgListOptionsToQuery(e),i=this._msg_cl_list.slice();n===Zt.DOWN&&i.reverse();const a=[];for(const r of i)if(a.push(...await r.cryptolalia.getMsgList(t,e)),a.length>=s)break;return a}async addMsg(t){if(void 0===this._msg_cl){const t=(new Date).toISOString();await this._meta_cl.addMsg({cmd:"list",datetimes:[t],time:Date.now()}),this._addStartTime(t),this._msg_cl_list=this._getCryptolalias(new Set([t]))}return this._msg_cl.cryptolalia.addMsg(t)}async clear(){const t=this._getStartTimes();await this._meta_cl.sync.doSync(),await this._meta_cl.addMsg({cmd:"list",datetimes:[],time:Date.now()}),t.clear(),this._saveStartTimes(t);for(const e of this._msg_cl_list)await e.cryptolalia.clear();this._msg_cl_list.length=0}async doSync(){await this._meta_cl.sync.doSync();for(const t of await this._meta_cl.getMsgList(Date.now(),{limit:1}))if("list"===t.content.cmd){const e=new Set(t.content.datetimes);for(const t of this._msg_cl_list)t.syncable=e.has(t.cid),e.delete(t.cid);if(console.log(this.userId,t.content),e.size>0){for(const t of e)this._addStartTime(t);this._msg_cl_list=this._getCryptolalias(new Set(t.content.datetimes))}break}console.log("doSync meta done");for(const t of this._msg_cl_list)t.syncable&&(await t.cryptolalia.sync.doSync(),console.log("doSync msg done"));console.log("doSync done")}};cs=is=P([F(),G(0,z(os.USER_ID)),q("design:paramtypes",[String,"function"==typeof(as=void 0!==R&&R)?as:Object])],cs),function(t){t.ARGS=os;t.SuperConfig=class extends bt{constructor(t){super(),this._st=t,this.branchGroupCount=64,this.timespan=1e4,this.startTime=+new Date(this._st)}},t.DEFAULT_START_TIME=(new Date).toISOString()}(cs||(cs={}));const ls=new TextEncoder;new TextDecoder;{class t extends St{getSignature(t){const e=ls.encode(JSON.stringify(t)),s=new Uint8Array(32);for(let n=0;n<e.length;++n){const t=n%s.length;s[t]+=e[n];for(let e=(t+1)%s.length;e<s.length;++e)s[e]=n*e+s[t]}return s}getCreateTime(t){return t.time}}A(t,rs)}A(He,rs);class hs{constructor(){this.port1=(()=>{const t=this;return{postMessage(t){},get onMessage(){return t.port2.postMessage},set onMessage(e){t.port2.postMessage=e}}})(),this.port2=(()=>{const t=this;return{postMessage(t){},get onMessage(){return t.port1.postMessage},set onMessage(e){t.port1.postMessage=e}}})()}static getPort(t,e){console.log("getport",t);let s=this.cache.get(t);return void 0===s&&(s=new hs,this.cache.set(t,s)),e===ds.get(os.USER_ID)?(console.log("port1 for",t),s.port1):(console.log("port2 for",t),s.port2)}}hs.cache=new Map;const ds=new R([[os.USER_ID,"user1"]],rs),us=new R([[os.USER_ID,"user2"]],rs),ps=A(cs,ds),gs=A(cs,us),fs=t=>{var e;const s=new R([],rs);{const n=Symbol("localId");s.set(n,t);class i extends Me{constructor(){super(...arguments),this.bchanne=new BroadcastChannel("chatsApp"),this.handshakeSession=async(t,e)=>void 0===e?{senderId:this.localId}:void(await this.app.addSession(t,{nickname:e.senderId,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1}))}getSessionId(t){return[this.localId,t.nickname].sort().join("-")}compare(t,e){return t.isCollection&&!e.isCollection?-1:e.isCollection&&!t.isCollection?1:e.lastMsgTime-t.lastMsgTime}sendMessage(t,e){this.bchanne.postMessage(["chatsApp",t.nickname,e])}bfOnInit(){this.bchanne.addEventListener("message",(t=>{if(console.log("event",t.data),void 0===this.onNewMessage)return;const{data:e}=t;Array.isArray(e)&&3===e.length&&"chatsApp"===e[0]&&e[1]===this.localId&&this.onNewMessage(e[2])}))}}P([z(n),q("design:type",String)],i.prototype,"localId",void 0),P([z(je),q("design:type","function"==typeof(e=void 0!==je&&je)?e:Object)],i.prototype,"app",void 0),console.log("MyChatsAppHelper",U(i)),A(i,s)}A(ss,s.installMask(new R([[ss.ARGS.TARGET_DIR,"online-"+t]])));return A(je,s)};function ys(t){let e,s,i,o,h,d,u,f;return i=new yt({props:{doSend:t[0],doSync:t[2],getList:t[4],isSelf:t[6],doClear:t[8]}}),d=new yt({props:{doSend:t[1],doSync:t[3],getList:t[5],isSelf:t[7],doClear:t[9]}}),{c(){e=n("main"),s=n("section"),J(i.$$.fragment),o=a(),h=n("section"),J(d.$$.fragment),r(s,"class","chat-panel panel-1 svelte-16sysco"),r(h,"class","chat-panel panel-2 svelte-16sysco"),r(e,"class","chat-panels svelte-16sysco")},m(t,n){c(t,e,n),l(e,s),Y(i,s,null),l(e,o),l(e,h),Y(d,h,null),f=!0},p:y,i(t){f||(b(i.$$.fragment,t),b(d.$$.fragment,t),u||p((()=>{u=g(e,K,{}),u.start()})),f=!0)},o(t){W(i.$$.fragment,t),W(d.$$.fragment,t),f=!1},d(t){t&&m(e),Q(i),Q(d)}}}function ms(t){const e=(t,e)=>s=>e.addMsg({content:s,sender:t,time:Date.now()}),s=t=>()=>T(void 0,void 0,void 0,(function*(){console.group("do sync"),yield t.doSync(),console.groupEnd()})),n=t=>()=>T(void 0,void 0,void 0,(function*(){const e=[];for(const s of yield t.getMsgList(Date.now(),{offset:0,limit:100,order:-1}))e.push(s.content);return e}));return[e("user1",ps),e("user2",gs),s(ps),s(gs),n(ps),n(gs),t=>"user1"===t,t=>"user2"===t,()=>ps.clear(),()=>gs.clear()]}class _s extends t{constructor(t){super(),e(this,t,ms,ys,s,{})}}function ws(t,e,s){const n=t.slice();return n[22]=e[s],n}function vs(t){let e,s,h,u,p,g,f,y,I,M,T,$,E,D,B=[],L=new Map,O=t[3];const C=t=>t[22].nickname;for(let n=0;n<O.length;n+=1){let e=ws(t,O,n),s=C(e);L.set(s,B[n]=Ts(s,e))}return{c(){e=n("section"),s=n("h2"),h=i("Welcome 💜 "),u=i(t[1]),p=a(),g=n("ul"),f=n("li"),y=n("input"),I=a(),M=n("button"),M.textContent="添加好友",T=a();for(let t=0;t<B.length;t+=1)B[t].c();r(y,"type","text"),o(M,"activing",t[5]),r(f,"class","add-friend"),r(g,"class","friend-list svelte-1lrcjcd")},m(n,i){c(n,e,i),l(e,s),l(s,h),l(s,u),l(e,p),l(e,g),l(g,f),l(f,y),_(y,t[4]),l(f,I),l(f,M),l(g,T);for(let t=0;t<B.length;t+=1)B[t].m(g,null);$=!0,E||(D=[w(y,"input",t[17]),w(M,"click",t[9])],E=!0)},p(t,e){(!$||2&e)&&d(u,t[1]),16&e&&y.value!==t[4]&&_(y,t[4]),32&e&&o(M,"activing",t[5]),64712&e&&(O=t[3],V(),B=v(B,e,C,1,t,O,L,g,Z,Ts,null,ws),X())},i(t){if(!$){for(let t=0;t<O.length;t+=1)b(B[t]);$=!0}},o(t){for(let e=0;e<B.length;e+=1)W(B[e]);$=!1},d(t){t&&m(e);for(let e=0;e<B.length;e+=1)B[e].d();E=!1,S(D)}}}function bs(t){let e,s,i,h,d,u,p,g,f;return{c(){e=n("session"),s=n("h2"),s.textContent="Hi~ Please Login",i=a(),h=n("div"),d=n("input"),u=a(),p=n("button"),p.textContent="登录",r(d,"placeholder","请输入您的名字"),r(p,"class","login-btn svelte-1lrcjcd"),o(p,"activing",t[2]),r(h,"class","form svelte-1lrcjcd"),r(e,"class","login-panel svelte-1lrcjcd")},m(n,a){c(n,e,a),l(e,s),l(e,i),l(e,h),l(h,d),_(d,t[1]),l(h,u),l(h,p),g||(f=[w(d,"input",t[16]),w(p,"click",t[8])],g=!0)},p(t,e){2&e&&d.value!==t[1]&&_(d,t[1]),4&e&&o(p,"activing",t[2])},i:y,o:y,d(t){t&&m(e),g=!1,S(f)}}}function Ss(t){let e,s,a=t[22].badge+"";return{c(){e=n("sup"),s=i(a),r(e,"title","未读"),r(e,"class","badge svelte-1lrcjcd")},m(t,n){c(t,e,n),l(e,s)},p(t,e){8&e&&a!==(a=t[22].badge+"")&&d(s,a)},d(t){t&&m(e)}}}function Is(t){let e,s,o,h,u,f,_,w=t[22].lastMsgPreview+"",v=new Date(t[22].lastMsgTime).toLocaleTimeString()+"";return{c(){e=n("div"),s=n("span"),o=i(w),h=a(),u=n("span"),f=i(v),r(s,"class","msg-preview svelte-1lrcjcd"),r(u,"class","msg-time"),r(e,"class","last-msg svelte-1lrcjcd")},m(t,n){c(t,e,n),l(e,s),l(s,o),l(e,h),l(e,u),l(u,f)},p(t,e){8&e&&w!==(w=t[22].lastMsgPreview+"")&&d(o,w),8&e&&v!==(v=new Date(t[22].lastMsgTime).toLocaleTimeString()+"")&&d(f,v)},i(t){_||p((()=>{_=g(e,tt,{duration:300}),_.start()}))},o:y,d(t){t&&m(e)}}}function Ms(t){let e,s,i,a,o;function l(e){t[20](e)}let h={doSend:t[12],doSync:t[13],getList:t[14],isSelf:t[15]};return void 0!==t[7]&&(h.onListChanged=t[7]),s=new yt({props:h}),et.push((()=>st(s,"onListChanged",l))),{c(){e=n("div"),J(s.$$.fragment),r(e,"class","chat-panel svelte-1lrcjcd")},m(t,n){c(t,e,n),Y(s,e,null),o=!0},p(t,e){const n={};!i&&128&e&&(i=!0,n.onListChanged=t[7],nt((()=>i=!1))),s.$set(n)},i(t){o||(b(s.$$.fragment,t),a||p((()=>{a=g(e,tt,{duration:300}),a.start()})),o=!0)},o(t){W(s.$$.fragment,t),o=!1},d(t){t&&m(e),Q(s)}}}function Ts(t,e){let s,o,h,u,p,g,f,y,_,v,I,M,T,$,E,D,B,L=e[22].nickname+"",O=e[22].isCollection?"❤️":"🤍",C=0!==e[22].badge&&Ss(e);function j(){return e[18](e[22])}function k(){return e[19](e[22])}const N=[Ms,Is],H=[];function x(t,e){return t[6]===t[22]?0:t[22].lastMsgPreview?1:-1}return~(M=x(e))&&(T=H[M]=N[M](e)),{key:t,first:null,c(){s=n("li"),o=n("div"),h=n("span"),u=i(L),p=a(),C&&C.c(),g=a(),f=n("span"),y=i(O),_=a(),v=n("button"),v.textContent="💬",I=a(),T&&T.c(),$=a(),r(h,"class","nickname svelte-1lrcjcd"),r(f,"title","收藏"),r(f,"class","collection svelte-1lrcjcd"),r(v,"title","开始聊天"),r(v,"class","start-chat-btn svelte-1lrcjcd"),r(o,"class","base-info svelte-1lrcjcd"),r(s,"class","friend-info svelte-1lrcjcd"),this.first=s},m(t,e){c(t,s,e),l(s,o),l(o,h),l(h,u),l(h,p),C&&C.m(h,null),l(o,g),l(o,f),l(f,y),l(o,_),l(o,v),l(s,I),~M&&H[M].m(s,null),l(s,$),E=!0,D||(B=[w(f,"click",j),w(v,"click",k)],D=!0)},p(t,n){e=t,(!E||8&n)&&L!==(L=e[22].nickname+"")&&d(u,L),0!==e[22].badge?C?C.p(e,n):(C=Ss(e),C.c(),C.m(h,null)):C&&(C.d(1),C=null),(!E||8&n)&&O!==(O=e[22].isCollection?"❤️":"🤍")&&d(y,O);let i=M;M=x(e),M===i?~M&&H[M].p(e,n):(T&&(V(),W(H[i],1,1,(()=>{H[i]=null})),X()),~M?(T=H[M],T?T.p(e,n):(T=H[M]=N[M](e),T.c()),b(T,1),T.m(s,$)):T=null)},i(t){E||(b(T),E=!0)},o(t){W(T),E=!1},d(t){t&&m(s),C&&C.d(),~M&&H[M].d(),D=!1,S(B)}}}function $s(t){let e,s,i,a,r;const o=[bs,vs],l=[];function h(t,e){return void 0===t[0]?0:1}return s=h(t),i=l[s]=o[s](t),{c(){e=n("main"),i.c()},m(t,n){c(t,e,n),l[s].m(e,null),r=!0},p(t,[n]){let a=s;s=h(t),s===a?l[s].p(t,n):(V(),W(l[a],1,1,(()=>{l[a]=null})),X(),i=l[s],i?i.p(t,n):(i=l[s]=o[s](t),i.c()),b(i,1),i.m(e,null))},i(t){r||(b(i),a||p((()=>{a=g(e,K,{}),a.start()})),r=!0)},o(t){W(i),r=!1},d(t){t&&m(e),l[s].d()}}}function Es(t,e,s){let n,i="",a=!1;let r=[],o="",c=!1;const l=t=>T(void 0,void 0,void 0,(function*(){t.isCollection=!t.isCollection;const e=n.helper.getSessionId(t);(yield n.updateSession(e,t))&&s(3,r=yield n.getSessionList())}));let h,d="";const u=t=>{s(6,h=h===t?void 0:t),d=h?n.helper.getSessionId(h):""};let p;return[n,i,a,r,o,c,h,p,()=>T(void 0,void 0,void 0,(function*(){s(2,a=!0);try{if(s(1,i=i.trim()),0===i.length)return;s(0,n=fs(i)),console.log("chatsApp",n),s(3,r=yield n.getSessionList()),s(0,n.onOrderChange=()=>T(void 0,void 0,void 0,(function*(){s(3,r=yield n.getSessionList())})),n),s(0,n.onNewMessage=([t,e])=>T(void 0,void 0,void 0,(function*(){t===d&&p();const s=yield n.getSessionInfo(t);void 0!==s&&(s.lastMsgPreview=e.content,s.lastMsgTime=Date.now(),t!==d&&(s.badge+=1),yield n.updateSession(t,s))})),n)}finally{s(2,a=!1)}})),()=>T(void 0,void 0,void 0,(function*(){try{if(s(5,c=!0),s(4,o=o.trim()),0===o.length)return;const t={nickname:o,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1},e=n.helper.getSessionId(t);(yield n.addSession(e,t))&&s(3,r=yield n.getSessionList()),s(4,o="")}finally{s(5,c=!1)}})),l,u,t=>n.sendMessage(d,{sender:i,content:t,time:Date.now()}),()=>{if(console.log("no need sync~"),0!==(null==h?void 0:h.badge))return s(6,h.badge=0,h),n.updateSession(d,h)},()=>T(void 0,void 0,void 0,(function*(){return(yield n.getMessageList(d,{limit:100,order:-1})).map((t=>t.content))})),t=>t===i,function(){i=this.value,s(1,i)},function(){o=this.value,s(4,o)},t=>l(t),t=>u(t),function(t){p=t,s(7,p)}]}class Ds extends t{constructor(t){super(),e(this,t,Es,$s,s,{})}}function Bs(t){let e;return{c(){e=i("Local Chat Demo")},m(t,s){c(t,e,s)},d(t){t&&m(e)}}}function Ls(t){let e;return{c(){e=i("Chat Online Demo")},m(t,s){c(t,e,s)},d(t){t&&m(e)}}}function Os(t){let e,s;return e=new _s({}),{c(){J(e.$$.fragment)},m(t,n){Y(e,t,n),s=!0},i(t){s||(b(e.$$.fragment,t),s=!0)},o(t){W(e.$$.fragment,t),s=!1},d(t){Q(e,t)}}}function Cs(t){let e,s,o,h,d,u,p,g;return p=new Ds({}),{c(){e=n("p"),s=i("提示：该DEMO使用BroadcastChannel模块网络广播，"),o=n("a"),h=i("打开更多同域页面"),d=i("即可多账户登录"),u=a(),J(p.$$.fragment),r(o,"href",location.href),r(o,"target","_blank"),r(e,"class","tip svelte-hzs5f5")},m(t,n){c(t,e,n),l(e,s),l(e,o),l(o,h),l(e,d),c(t,u,n),Y(p,t,n),g=!0},p:y,i(t){g||(b(p.$$.fragment,t),g=!0)},o(t){W(p.$$.fragment,t),g=!1},d(t){t&&m(e),t&&m(u),Q(p,t)}}}function js(t){let e,s,i,o,h,d,u,p,g,f,y,_,w;return h=new ot({props:{getProps:Ns,to:"/",$$slots:{default:[Bs]},$$scope:{ctx:t}}}),u=new ot({props:{getProps:Ns,to:"/online",$$slots:{default:[Ls]},$$scope:{ctx:t}}}),f=new ct({props:{path:"/",$$slots:{default:[Os]},$$scope:{ctx:t}}}),_=new ct({props:{path:"/online",$$slots:{default:[Cs]},$$scope:{ctx:t}}}),{c(){e=n("header"),s=n("h1"),s.textContent="Cryptolalia Demo",i=a(),o=n("nav"),J(h.$$.fragment),d=a(),J(u.$$.fragment),p=a(),g=n("main"),J(f.$$.fragment),y=a(),J(_.$$.fragment),r(s,"class","svelte-hzs5f5"),r(o,"class","svelte-hzs5f5"),r(e,"class","svelte-hzs5f5"),r(g,"class","svelte-hzs5f5")},m(t,n){c(t,e,n),l(e,s),l(e,i),l(e,o),Y(h,o,null),l(o,d),Y(u,o,null),c(t,p,n),c(t,g,n),Y(f,g,null),l(g,y),Y(_,g,null),w=!0},p(t,e){const s={};8&e&&(s.$$scope={dirty:e,ctx:t}),h.$set(s);const n={};8&e&&(n.$$scope={dirty:e,ctx:t}),u.$set(n);const i={};8&e&&(i.$$scope={dirty:e,ctx:t}),f.$set(i);const a={};8&e&&(a.$$scope={dirty:e,ctx:t}),_.$set(a)},i(t){w||(b(h.$$.fragment,t),b(u.$$.fragment,t),b(f.$$.fragment,t),b(_.$$.fragment,t),w=!0)},o(t){W(h.$$.fragment,t),W(u.$$.fragment,t),W(f.$$.fragment,t),W(_.$$.fragment,t),w=!1},d(t){t&&m(e),Q(h),Q(u),t&&m(p),t&&m(g),Q(f),Q(_)}}}function ks(t){let e,s;return e=new it({props:{history:t[0],$$slots:{default:[js]},$$scope:{ctx:t}}}),{c(){J(e.$$.fragment)},m(t,n){Y(e,t,n),s=!0},p(t,[s]){const n={};8&s&&(n.$$scope={dirty:s,ctx:t}),e.$set(n)},i(t){s||(b(e.$$.fragment,t),s=!0)},o(t){W(e.$$.fragment,t),s=!1},d(t){Q(e,t)}}}function Ns({location:t,href:e,isPartiallyCurrent:s,isCurrent:n}){return("/"===e?n:s||n)?{class:"nav-item active"}:{class:"nav-item"}}function Hs(t,e,s){const n=at(function(){const t=lt({});let e=[];return t.listen((s=>{"POP"===t.action&&e.forEach((t=>t(s)))})),{get location(){return t.location},addEventListener(t,s){"popstate"===t&&e.push(s)},removeEventListener(t,s){"popstate"===t&&(e=e.filter((t=>t!==s)))},history:{get state(){return t.location.state},pushState(e,s,n){t.push(n,e)},replaceState(e,s,n){t.replace(n,e)},go(e){t.go(e)}}}}());rt((()=>{console.log("destory")}));return[n,()=>{ht().$destroy()}]}new class extends t{constructor(t){super(),e(this,t,Hs,ks,s,{destory:1})}get destory(){return this.$$.ctx[1]}}({target:document.getElementById("app")});
