import{_ as t,e,a as s,r as n,b as i,$ as r,j as a,T as o,L as c,F as l,z as h,c as d,d as u,S as p,i as f,s as g,f as y,t as w,g as m,h as _,k as v,l as b,m as I,n as S,o as M,p as B,q as E,u as D,v as $,w as L,x as O,y as T,A as j,B as C,C as k,D as N,E as H,G as x,H as A,I as R,J as P,K as F,M as G,N as q,O as J,P as W,Q as U,R as Y,U as z,V as Q,W as K,X as V,Y as X,Z,a0 as tt,a1 as et}from"./vendor.bc1f075a.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();let st=class{};st=t([e()],st);let nt=class{};nt=t([e()],nt);class it extends nt{}const rt=(t,e,s)=>(i,r,a)=>{const o=a.value;if("function"!=typeof o)throw new TypeError;const c=async function(...i){const r=new n;this[s]=r.promise;const a=o.apply(this,i);return this[e].requestTransaction(t,(t=>(r.resolve(t),a)))};return Reflect.set(c,"source",o),a.value=c,a};let at=class{calcBranchId(t){const e=t-this.startTime;if(e<0)throw new RangeError("invald time: "+t);let s=e/this.timespan;return s%1==0&&(s+=1),Math.ceil(s)}calcNextBranchId(t){let e=t/this.branchGroupCount;return e%1==0&&(e+=1),Math.ceil(e)}calcBranchIdRange(t){const e=(t-1)*this.branchGroupCount;return{start:e+1,end:e+this.branchGroupCount}}};at=t([e()],at);let ot=class{msgIsSign(t,e){return this.signIsSign(this.getSignature(t),e)}signIsSign(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0}compareMessage(t,e){const s=this.getCreateTime(t),n=this.getCreateTime(e);if(s<n)return-1;if(s>n)return 1;const i=this.getSignature(t),r=this.getSignature(e);if(i.length<r.length)return-1;if(i.length>r.length)return 1;for(let a=0;a<i.length;++a){const t=i[a],e=r[a];if(t<e)return-1;if(t>e)return 1}return 0}};var ct,lt,ht,dt,ut,pt;ot=t([e()],ot);let ft=class{constructor(t,e,s,n){this.config=t,this.cryptoHelper=e,this.messageHelper=n,this._store=s.fork(["timeline"])}addLeaf(t){return this._addLeaf(t,this._store)}async hasManyLeaf(t){const e=await this._trs;return this._batchHas(t,e)}async _batchHas(t,e){const{messageHelper:s}=this,n=[],i=new Map;for(const r of t){const t=this.config.calcBranchId(s.getCreateTime(r));let a=i.get(t);if(void 0===a&&(a=await e.getJsObject(["blocks",`block-${t}`])||null,i.set(t,a)),null!==a){const t=s.getSignature(r),e=mt(t,a.indexedDigit),i=a.mapData.get(e);if(void 0!==i){n.push(s.msgIsSign(i,t));continue}}n.push(!1)}return n}async _addLeaf(t,e){const{messageHelper:s}=this,n=s.getCreateTime(t),i=this.config.calcBranchId(n),r=["blocks",`block-${i}`],a=await e.getJsObject(r)||{indexedDigit:8,mapData:new gt},o=s.getSignature(t);do{const e=mt(o,a.indexedDigit),n=a.mapData.get(e);if(void 0===n){a.mapData.set(e,t);break}if(s.msgIsSign(n,o))return!1;if(256===a.indexedDigit)throw console.error("signature should be equal",o,n),new Error("out of indexedDigit");const i=a.indexedDigit=2*a.indexedDigit,r=new Map;for(const t of a.mapData.values())r.set(mt(s.getSignature(t),i),t);a.mapData=r}while(a.indexedDigit<=256);let c=0,l=0,h=i;const d=[];do{++c,l=this.config.calcNextBranchId(h),d.unshift({paths:["tree-hash",`level-${c}`,`branch-${l}`],dirtyBranchId:h}),h=l}while(1!==l);for(const u of d){let t=await e.getJsObject(u.paths);if(void 0!==t){if(t.subDirty.has(u.dirtyBranchId))continue;t.dirty=!0,t.subDirty.add(u.dirtyBranchId),t.subHash.delete(u.dirtyBranchId)}else t={hash:_t,dirty:!0,subDirty:new Set([u.dirtyBranchId]),subHash:new Map};await e.setJsObject(u.paths,t)}return await e.setJsObject(r,a),{branchId:i}}async addManyLeaf(t){const e=await this._trs,s=[];for(const n of t)s.push({success:await this._addLeaf(n,e),leaf:n});return s}getLeafFromBranchData(t,e){const s=mt(e,t.indexedDigit),n=t.mapData.get(s);if(n&&this.messageHelper.msgIsSign(n,e))return n}async getBranchData(t){const e=["blocks",`block-${t}`];return this._store.getJsObject(e)}async _getBlockHash(t){const e=await this._store.getBinary(["blocks",`block-${t}`]);return e?await this.cryptoHelper.sha256Binary(e):_t}async _getBranchHash(t,e,s){if(0===s){const s=["level-1",`branch-${this.config.calcNextBranchId(e)}`],n=await t.getJsObject(s);if(void 0===n)return _t;const i=n.subDirty.has(e)||n.subHash.get(e);let r=_t;return!0===i?(r=await this._getBlockHash(e),0===r.length?n.subHash.delete(e):n.subHash.set(e,r),n.subDirty.delete(e),await t.setJsObject(s,n)):void 0!==i&&(r=i),r}const n=[`level-${s}`,`branch-${e}`],i=await t.getJsObject(n);if(void 0===i)return _t;if(!1===i.dirty)return i.hash;if(0!==i.subDirty.size){const e=s-1;if(0===e)for(const t of i.subDirty){const e=await this._getBlockHash(t);0===e.length?i.subHash.delete(t):i.subHash.set(t,e)}else for(const s of i.subDirty){const n=await this._getBranchHash(t,s,e);0===n.length?i.subHash.delete(s):i.subHash.set(s,n)}i.subDirty.clear()}const r=[...i.subHash].sort(((t,e)=>t[0]-e[0]));switch(r.length){case 0:i.hash=_t;break;case 1:i.hash=r[0][1];break;default:const t=this.cryptoHelper.sha256HashBuilder();for(const e of r)t.update(e[1]);i.hash=await t.digest()}return i.dirty=!1,await t.setJsObject(n,i),i.hash}async getBranchRoute(t){const e=await this._trs_th;let s=0,n=this.config.calcBranchId(t);const i=[{level:s,branchId:n,hash:await this._getBranchHash(e,n,s)}];for(;1!==n;)n=this.config.calcNextBranchId(n),s+=1,i.push({level:s,branchId:n,hash:await this._getBranchHash(e,n,s)});return i}async getBranchChildren(t,e){const s=await this._trs_th;if(e<1)throw new RangeError(`invalid branch level: ${e} when get branch(${t})`);const n=await s.getJsObject([`level-${e}`,`branch-${t}`]),i=new Map;if(void 0!==n){const t=e-1;for(const e of[...n.subDirty,...n.subHash.keys()]){const n=await this._getBranchHash(s,e,t);0!==n.length&&i.set(e,n)}}return i}};t([rt([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof(ct="undefined"!=typeof Iterable&&Iterable)?ct:Object]),s("design:returntype",Promise)],ft.prototype,"hasManyLeaf",null),t([rt([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof(lt="undefined"!=typeof Iterable&&Iterable)?lt:Object]),s("design:returntype",Promise)],ft.prototype,"addManyLeaf",null),t([rt(["tree-hash"],"_store","_trs_th"),s("design:type",Function),s("design:paramtypes",[Number]),s("design:returntype",Promise)],ft.prototype,"getBranchRoute",null),t([rt(["tree-hash"],"_store","_trs_th"),s("design:type",Function),s("design:paramtypes",[Number,Number]),s("design:returntype",Promise)],ft.prototype,"getBranchChildren",null),ft=t([e(),s("design:paramtypes",["function"==typeof(ht=void 0!==at&&at)?ht:Object,"function"==typeof(dt=void 0!==st&&st)?dt:Object,"function"==typeof(ut=void 0!==it&&it)?ut:Object,"function"==typeof(pt=void 0!==ot&&ot)?pt:Object])],ft);class gt extends Map{constructor(){super(...arguments),this._okl=[]}get[Symbol.toStringTag](){return"OrderMap"}set(t,e){if(Number.isNaN(t))throw new TypeError("order-map's key must be finite number");const s=this.size;return super.set(t,e),this.size!==s&&(this._okl.push(t),this._okl.sort()),this}delete(t){return!!super.delete(t)&&(this._okl.splice(this._okl.indexOf(t)),!0)}keys(){return this._okl[Symbol.iterator]()}*entries(){for(const t of this._okl)yield[t,this.get(t)]}[Symbol.iterator](){return this.entries()}toMap(){return new Map(this)}static fromMap(t){const e=new gt(t);return e._okl=[...t.keys()].sort(),e}}const yt=(t,e)=>{switch(e){case 8:return t[0]||0;case 16:return((t[0]||0)<<8)+(t[1]||0);case 32:return(yt(t,16)<<16)+yt(t.slice(16),16)}},wt=(t,e)=>{switch(e){case 64:return(BigInt(yt(t,32))<<32n)+BigInt(yt(t.slice(32),32));case 128:return(BigInt(wt(t,64))<<64n)+BigInt(wt(t.slice(64),64));case 256:return(BigInt(wt(t,128))<<128n)+BigInt(wt(t.slice(128),128))}},mt=(t,e)=>e<=32?yt(t,e):wt(t,e),_t=new Uint8Array(0);let vt=class{max(t,e=this.now()){return t>=e?t:e}};vt=t([e()],vt);class bt extends vt{now(){return Date.now()}}const It=(t,e,s)=>{const n=t.getJsObject(e);return void 0!==n&&"then"in n?n.then((t=>s(t))):s(n)};var St;let Mt=class{constructor(t){this.storage=t}addAudio(t){this.storage.setBinary(["assets","audio"],t)}addVideo(t){this.storage.setBinary(["assets","video"],t)}addDocument(t){this.storage.setBinary(["assets","document"],t)}addPicture(t){this.storage.setBinary(["assets","picture"],t)}addCode(t){this.storage.setBinary(["assets","code"],t)}async addFile(t){this.storage.setBinary(["assets",t.type],new Uint8Array(await t.arrayBuffer()))}};var Bt,Et,Dt,$t,Lt,Ot,Tt,jt;Mt=t([e(),s("design:paramtypes",["function"==typeof(St=void 0!==it&&it)?St:Object])],Mt);const Ct=(t,e)=>t<e?-1:t>e?1:0,kt=(t,e)=>t<e?1:t>e?-1:0;let Nt=class{constructor(t,e){this.config=t,this.timeHelper=e,this._cache=new Map}getDataList(t,e){const s=[`receipt-${e}`];let n=this._cache.get(e);if(!n&&(n={lastUpdateTime:this.timeHelper.now(),dataList:It(t,s,(t=>t||[]))},this._cache.set(e,n),this._cache.size>3)){const t=this.timeHelper.now();for(const[e,s]of this._cache){if(s.lastUpdateTime+1e4>t)break;void 0===s.writerQueue&&this._cache.delete(e)}}return n.dataList}setDataList(t,e,s){let i=this._cache.get(e);const r=this.timeHelper.now();i?(this._cache.delete(e),i.lastUpdateTime=r,i.dataList=s):i={dataList:s,lastUpdateTime:r},this._cache.set(e,i);let a=i.writerQueue;if(void 0===a){a=i.writerQueue=new n;const s=i,r=a;queueMicrotask((async()=>{const n=[`receipt-${e}`];s.writerQueue=void 0;try{await t.setJsObject(n,s.dataList),r.resolve()}catch(i){r.reject(i)}}))}return a.promise}_getBranchMetaGroup(t,e){var s;if((null==(s=this._metaCache)?void 0:s.groupId)!==e){this._metaCache={groupId:e,cache:void 0};const s=this._metaCache;s.cache=It(t,["meta-branch",`group-${e}`],(t=>(s.cache=t,t)))}return this._metaCache.cache}_setBranchMetaGroup(t,e,s){return this._metaCache={groupId:e,cache:s},t.setJsObject(["meta-branch",`group-${e}`],s)}async getBranchMeta(t,e){const s=this.config.calcNextBranchId(e),n=await this._getBranchMetaGroup(t,s);return null==n?void 0:n.map.get(e)}async setBranchMeta(t,e,s){const n=this.config.calcNextBranchId(e),i=await this._getBranchMetaGroup(t,n)||{groupId:n,map:new Map};return i.map.set(e,s),this._setBranchMetaGroup(t,n,i)}async upsertBranchMeta(t,e,s){const n=await this.getBranchMeta(t,e)||{preBranchId:e,nextBranchId:e};return this.setBranchMeta(t,e,Object.assign(n,s))}async*BranchIdWalker(t,e,s=At.UP){const n=this.config.calcNextBranchId(e);let i;if(i=await this._getBranchMetaGroup(t,n),void 0===i){const{files:e}=await t.listPaths(["meta-branch"]),r=[];for(const t of e)t.startsWith("group-")&&r.push(+t.slice(6));r.sort(s===At.DOWN?kt:Ct);let a=r.findIndex((t=>Ct(n,t)!==s));if(-1===a)return;for(;a<r.length;){const e=r[a];if(i=await this._getBranchMetaGroup(t,e),void 0!==i)break;console.error(new Error(`数据库异常，可能发生数据丢失(${t.currentPaths}, ${["meta-branch",`group-${e}`]})`)),a++}}for(;;){if(void 0===i)return;const n=[...i.map.keys()].sort(s===At.DOWN?kt:Ct);if(0===n.length)throw new Error(`数据库异常，可能是数据丢失，索引断链，需要重新整理数据重建索引(${t.currentPaths}, ${i.groupId})`);let r=n.findIndex((t=>kt(e,t)===s));if(-1!==r)do{yield n[r]}while(++r<n.length);const a=i.map.get(n[n.length-1]),o=s===At.UP?a.nextBranchId:a.preBranchId,c=this.config.calcNextBranchId(o);if(c===i.groupId)return;i=await this._getBranchMetaGroup(t,c)}}};Nt=t([e(),s("design:paramtypes",["function"==typeof(Bt=void 0!==at&&at)?Bt:Object,"function"==typeof(Et=void 0!==bt&&bt)?Et:Object])],Nt);let Ht=class{constructor(t,e,s){this.config=t,this.timeHelper=e,this._branchHanlder=s}getMeta(t){return void 0===this._meta&&(this._meta=It(t,["meta"],(async e=>(e&&(0!==e.firstBranchId&&0===(await this._branchHanlder.getDataList(t,e.firstBranchId)).length&&(e.firstBranchId=0),e.lastBranchId!==e.secondLastBranchId&&0===(await this._branchHanlder.getDataList(t,e.lastBranchId)).length&&(e.lastBranchId=e.secondLastBranchId)),this._meta=null!=e?e:{firstBranchId:0,lastBranchId:0,secondLastBranchId:0})))),this._meta}setMeta(t,e){return t.setJsObject(["meta"],e)}};Ht=t([e(),s("design:paramtypes",["function"==typeof(Dt=void 0!==at&&at)?Dt:Object,"function"==typeof($t=void 0!==bt&&bt)?$t:Object,Nt])],Ht);let xt=class{constructor(t,e,s,n,i){this.config=t,this.timeHelper=e,this._branchHanlder=n,this._metaHanlder=i,this._perNow=0,this._store=s.fork(["datalist"])}async _upsertMetaWhenAddNewItem(t,e){const s=await this._metaHanlder.getMeta(t);let n=0;if(0===s.firstBranchId)s.firstBranchId=e,s.secondLastBranchId=e,s.lastBranchId=e;else{if(!(s.lastBranchId<e)){if(s.lastBranchId===e)return;throw new Error("NOSUPPORT: new-branchId should not less then last-branchId")}n=s.secondLastBranchId=s.lastBranchId,s.lastBranchId=e}await this._metaHanlder.setMeta(t,s),0!==n&&await this._branchHanlder.upsertBranchMeta(t,n,{nextBranchId:e}),await this._branchHanlder.setBranchMeta(t,e,{preBranchId:n,nextBranchId:e})}async addItem(t,e=this.timeHelper.now()){const s=this.timeHelper.max(this._perNow+1,e);this._perNow=s;const n=this.config.calcBranchId(s),i=await this._trs;await this._upsertMetaWhenAddNewItem(i,n);const r=await this._branchHanlder.getDataList(i,n);return r.push({insertTime:s,data:t}),await this._branchHanlder.setDataList(i,n,r),e}async addManyItem(t,e=this.timeHelper.now()){const s=await this._trs;let n,i=0;const r=[];for(const a of t){const t=this.timeHelper.max(this._perNow+1,e);r.push(t),this._perNow=t;const o=this.config.calcBranchId(t);o!==i&&(await this._upsertMetaWhenAddNewItem(s,o),void 0!==n&&(await this._branchHanlder.setDataList(s,i,n),n=void 0),i=o),void 0===n&&(n=await this._branchHanlder.getDataList(s,o)),n.push({insertTime:t,data:a})}return n&&await this._branchHanlder.setDataList(s,i,n),r}async*ItemReader(t,e=At.UP){let s,n=this.config.calcBranchId(t);for(;;){const i=await this._branchHanlder.getDataList(this._store,n);let r=0,a=i.length;if(0!==i.length)for(e===At.DOWN&&(r=a-1,a=-1);r!==a;){const s=i[r];Ct(t,s.insertTime)!==e&&(yield s),r+=e}null!=s||(s=this._branchHanlder.BranchIdWalker(this._store,n,e));const o=await s.next();if(o.done)return;n=o.value}}};var At,Rt,Pt,Ft,Gt,qt,Jt;t([rt([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",[Object,Object]),s("design:returntype",Promise)],xt.prototype,"addItem",null),t([rt([],"_store","_trs"),s("design:type",Function),s("design:paramtypes",["function"==typeof(Lt="undefined"!=typeof Iterable&&Iterable)?Lt:Object,Object]),s("design:returntype",Promise)],xt.prototype,"addManyItem",null),xt=t([e(),s("design:paramtypes",["function"==typeof(Ot=void 0!==at&&at)?Ot:Object,"function"==typeof(Tt=void 0!==bt&&bt)?Tt:Object,"function"==typeof(jt=void 0!==it&&it)?jt:Object,Nt,Ht])],xt),(Rt=At||(At={}))[Rt.UP=1]="UP",Rt[Rt.DOWN=-1]="DOWN";const Wt={SYNC_CHANNE:Symbol("syncChannnel")};let Ut=class{constructor(t,e,s,n,i){this.syncChannel=t,this.timelineTree=e,this.dataList=s,this.timeHelper=n,this.msgHelper=i,this.taskSeq=new Vt({}),this.responser=new Xt(this.taskSeq,{executeTask:async({reqId:t,args:e})=>{switch(e.cmd){case zt.GET_BRANCH_ROUTE:{const s=await this.timelineTree.getBranchRoute(e.leafTime);this.syncChannel.postMessage([t,s])}break;case zt.GET_BRANCH_CHILDREN:{const s=await this.timelineTree.getBranchChildren(e.branchId,e.level);this.syncChannel.postMessage([t,s])}break;case zt.DOWNLOAD_BY_BRANCHID:{const s=await this.timelineTree.getBranchData(e.branchId);this.syncChannel.postMessage([t,s])}break;default:console.error("unknown task cmd:",e)}}}),this._reqIdAcc=1,this._reqMap=new Map,t.onMessage=t=>{var e;if(!Array.isArray(t)||2!==t.length)return;const[s,n]=t;if(n!==zt.ABORT)if(n!==zt.REFUSE)if(n&&"cmd"in n)!1===this.taskSeq.push(s,{reqId:s,args:n,controller:void 0})&&this.syncChannel.postMessage([s,zt.REFUSE]);else{const t=this._reqMap.get(s);t&&(this._reqMap.delete(s),t.resolve(n))}else{const t=this._reqMap.get(s);t&&t.reject(Kt)}else{const t=this.taskSeq.get(s);t&&(this.taskSeq.delete(s),null==(e=t.controller)||e.abort())}},this.responser.startResponse()}requestMessage(t,e){return new Promise(((s,n)=>{const i=null==e?void 0:e.signal;if(i){const t=n;n=e=>{this._reqMap.delete(r),e!==Kt&&this.syncChannel.postMessage([r,zt.ABORT]),t(e)},i.addEventListener("abort",n);const e=s;s=t=>{i.removeEventListener("abort",n),e(t)}}const r=this._reqIdAcc++;this._reqMap.set(r,{resolve:s,reject:n}),this.syncChannel.postMessage([r,t])}))}async doSync(t=this.timeHelper.now()){const{msgHelper:e,timelineTree:s,dataList:n}=this,i=new Yt,r=[],a=await s.getBranchRoute(t),o=await this.requestMessage({cmd:zt.GET_BRANCH_ROUTE,leafTime:t});a.sort(((t,e)=>e.level-t.level)),o.sort(((t,e)=>e.level-t.level));const c=a[0],l=o[0],{branchId:h,level:d,hash:u}=l;if(c.branchId!==h||c.level!==d)throw new Error(`invalid remote branch info: ${d}(level)/${h}/(branchId) when ${new Date(t).toLocaleString()}`);return 0!==u.length&&!e.signIsSign(c.hash,u)&&(await this._syncBranch(e,s,n,h,d,i,r),r.length>0&&(await(async(t,e,s,n)=>{const i=await e.addManyLeaf(n),r=[],a=[];for(const o of i)!1!==o.success?(r.push({sign:t.getSignature(o.leaf),branchId:o.success.branchId}),a.push(!0)):a.push(!1);return await s.addManyItem(r),a})(e,s,n,r.flat()),!0))}async _syncBranch(t,e,s,n,i,r,a){if(r.has(n,i))return!1;if(0===i){const t=await this.requestMessage({cmd:zt.DOWNLOAD_BY_BRANCHID,branchId:n});if(void 0===t)return!1;const s=[...t.mapData.values()],i=await e.hasManyLeaf(s),r=s.filter(((t,e)=>!1===i[e]));return r.length>0&&(a.push(r),!0)}const o=await this.requestMessage({cmd:zt.GET_BRANCH_CHILDREN,branchId:n,level:i}),c=await e.getBranchChildren(n,i),l=[];for(const[d,u]of o){const e=c.get(d);!1===(void 0!==e&&t.signIsSign(u,e))&&l.push(d)}l.sort();let h=!1;for(const d of l){const n=await this._syncBranch(t,e,s,d,i-1,r,a);h||(h=n)}return h}};Ut.ARGS=Wt,Ut=t([e(),i(0,r(Wt.SYNC_CHANNE)),s("design:paramtypes",["function"==typeof(Pt=void 0!==Ut&&Ut.Channel)?Pt:Object,"function"==typeof(Ft=void 0!==ft&&ft)?Ft:Object,"function"==typeof(Gt=void 0!==xt&&xt)?Gt:Object,"function"==typeof(qt=void 0!==bt&&bt)?qt:Object,"function"==typeof(Jt=void 0!==ot&&ot)?Jt:Object])],Ut);class Yt{constructor(){this._s=new Map}add(t,e){let s=this._s.get(e);void 0===s&&this._s.set(e,s=new Set),s.add(t)}has(t,e){const s=this._s.get(e);return void 0!==s&&s.has(t)}}var zt,Qt;(Qt=zt||(zt={}))[Qt.REFUSE=0]="REFUSE",Qt[Qt.ABORT=1]="ABORT",Qt[Qt.GET_BRANCH_ROUTE=2]="GET_BRANCH_ROUTE",Qt[Qt.GET_BRANCH_CHILDREN=3]="GET_BRANCH_CHILDREN",Qt[Qt.DOWNLOAD_BY_BRANCHID=4]="DOWNLOAD_BY_BRANCHID";const Kt=Symbol("reason:refuse by remote");class Vt{constructor(t){this.config=t,this._queue=new Map}push(t,e){if(this._waitter)this._waitter.resolve(e),this._waitter=void 0;else{if(this._queue.has(t))return!1;this._queue.set(t,e)}return!0}get(t){return this._queue.get(t)}has(t){return this._queue.has(t)}delete(t){return this._queue.delete(t)}shift(){if(0===this._queue.size)return(this._waitter=new n).promise;for(const[t,e]of this._queue)return this._queue.delete(t),e;throw 1}}class Xt{constructor(t,e){this.taskSeq=t,this.config=e}async*_ResponseQueue(){for(;;){const e=await this.taskSeq.shift();try{await this.config.executeTask(e)}catch(t){console.error("responser execute task error:",e,t)}yield}}startResponse(){if(void 0!==this._looper)return!1;const t=this._looper=this._ResponseQueue();return(async()=>{for await(const e of t);})().catch((t=>{console.info("responser stoped.",t)})),!0}stopResponse(t){return void 0!==this._looper&&(this._looper.throw(t),this._looper=void 0,!0)}}var Zt,te,ee,se,ne,ie,re,ae;let oe=class{constructor(t,e,s,n,i,r,a,o){this.msgHelper=t,this.config=e,this.timeHelper=s,this.timelineTree=n,this.dataList=i,this.assets=r,this.sync=a,this.storage=o}addMsg(t){return(async(t,e,s,n)=>{const i=await e.addLeaf(n);if(!1!==i){const{branchId:e}=i;return await s.addItem({sign:t.getSignature(n),branchId:e}),!0}return!1})(this.msgHelper,this.timelineTree,this.dataList,t)}async getMsgList(t,e={}){const{offset:s=0,limit:n=40,order:i=At.DOWN}=e,r=[],a=new Map;let o=0;for await(const l of this.dataList.ItemReader(t,i))if(o<s)++o;else{if(r.length>=n)break;r.push(l),!1===a.has(l.data.branchId)&&a.set(l.data.branchId,this.timelineTree.getBranchData(l.data.branchId))}const c=[];for(const l of r){let t=a.get(l.data.branchId);if(t&&"then"in t&&(t=await t,a.set(l.data.branchId,t)),void 0===t)throw new Error("数据发生了残缺丢失的问题，需要对数据重建索引");const e=this.timelineTree.getLeafFromBranchData(t,l.data.sign);if(void 0===e)throw new Error("数据发生了残缺丢失的问题，可能需要同步数据");c.push({receiptTime:l.insertTime,content:e})}return c}};oe=t([e(),s("design:paramtypes",["function"==typeof(Zt=void 0!==ot&&ot)?Zt:Object,"function"==typeof(te=void 0!==at&&at)?te:Object,"function"==typeof(ee=void 0!==vt&&vt)?ee:Object,"function"==typeof(se=void 0!==ft&&ft)?se:Object,"function"==typeof(ne=void 0!==xt&&xt)?ne:Object,"function"==typeof(ie=void 0!==Mt&&Mt)?ie:Object,"function"==typeof(re=void 0!==Ut&&Ut)?re:Object,"function"==typeof(ae=void 0!==it&&it)?ae:Object])],oe);class ce extends vt{now(){return Date.now()}}var le=Object.defineProperty,he=Object.defineProperties,de=Object.getOwnPropertyDescriptors,ue=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,fe=Object.prototype.propertyIsEnumerable,ge=(t,e,s)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;let ye,we;"undefined"!=typeof require&&require;const me=new WeakMap,_e=new WeakMap,ve=new WeakMap,be=new WeakMap,Ie=new WeakMap;let Se={get(t,e,s){if(t instanceof IDBTransaction){if("done"===e)return _e.get(t);if("objectStoreNames"===e)return t.objectStoreNames||ve.get(t);if("store"===e)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Be(t[e])},set:(t,e,s)=>(t[e]=s,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function Me(t){return"function"==typeof t?function(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(we||(we=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Ee(this),e),Be(me.get(this))}:function(...e){return Be(t.apply(Ee(this),e))}:function(e,...s){const n=t.call(Ee(this),e,...s);return ve.set(n,e.sort?e.sort():[e]),Be(n)}}(t):(t instanceof IDBTransaction&&function(t){if(_e.has(t))return;const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",r),t.removeEventListener("abort",r)},i=()=>{e(),n()},r=()=>{s(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",i),t.addEventListener("error",r),t.addEventListener("abort",r)}));_e.set(t,e)}(t),e=t,(ye||(ye=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((t=>e instanceof t))?new Proxy(t,Se):t);var e}function Be(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,s)=>{const n=()=>{t.removeEventListener("success",i),t.removeEventListener("error",r)},i=()=>{e(Be(t.result)),n()},r=()=>{s(t.error),n()};t.addEventListener("success",i),t.addEventListener("error",r)}));return e.then((e=>{e instanceof IDBCursor&&me.set(e,t)})).catch((()=>{})),Ie.set(e,t),e}(t);if(be.has(t))return be.get(t);const e=Me(t);return e!==t&&(be.set(t,e),Ie.set(e,t)),e}const Ee=t=>Ie.get(t);const De=["get","getKey","getAll","getAllKeys","count"],$e=["put","add","delete","clear"],Le=new Map;function Oe(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(Le.get(e))return Le.get(e);const s=e.replace(/FromIndex$/,""),n=e!==s,i=$e.includes(s);if(!(s in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!De.includes(s))return;const r=async function(t,...e){const r=this.transaction(t,i?"readwrite":"readonly");let a=r.store;return n&&(a=a.index(e.shift())),(await Promise.all([a[s](...e),i&&r.done]))[0]};return Le.set(e,r),r}var Te,je;je=((t,e)=>{for(var s in e||(e={}))pe.call(e,s)&&ge(t,s,e[s]);if(ue)for(var s of ue(e))fe.call(e,s)&&ge(t,s,e[s]);return t})({},Te=Se),Se=he(je,de({get:(t,e,s)=>Oe(t,e)||Te.get(t,e,s),has:(t,e)=>!!Oe(t,e)||Te.has(t,e)}));const Ce=t=>{const e=t.prototype[Symbol.toStringTag];return{kind:"sequence",resolve:t=>null===t||t.length%2==0,construct(e){const s=new t;for(let t=0;t<e.length;t+=2)s.set(e[t],e[t+1]);return s},represent(s){if(!(s instanceof t))throw new TypeError(`no an ${e}`);const n=new Array(2*s.size);let i=0;for(const t of s)n[i++]=t[0],n[i++]=t[1];return n},predicate:s=>s instanceof t&&s[Symbol.toStringTag]===e}},ke=a.DEFAULT_SCHEMA.extend([new o("tag:bfchain.org,2021:js/ordermap",Ce(gt)),new o("tag:bfchain.org,2021:js/map",Ce(Map)),new o("tag:bfchain.org,2021:js/set",{kind:"sequence",resolve:t=>!0,construct(t){const e=new Set;for(let s=0;s<t.length;++s)e.add(t[s]);return e},represent(t){if(!(t instanceof Set))throw new TypeError("no an set");return[...t]},predicate:t=>t instanceof Set&&"Set"===t[Symbol.toStringTag]})]),Ne=new TextDecoder,He=t=>a.load(Ne.decode(t),{schema:ke}),xe=new TextEncoder,Ae=t=>xe.encode(a.dump(t,{schema:ke}));class Re extends nt{constructor(t){super(),this.currentPaths=t,this._memFolder=new Map}setBinary(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{binary:e})}_makeFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i&&s.set(e,i={folder:new Map}),!("folder"in i))throw new Error("no an paths:"+t);s=i.folder}return s}_getFolder(t,e=t.length-1){let s=this._memFolder;for(let n=0;n<=e;n++){const e=t[n];let i=s.get(e);if(void 0===i)return;if(!("folder"in i))return;s=i.folder}return s}_getFile(t){let e=this._memFolder;for(let n=0,i=t.length-2;n<=i;n++){const s=t[n],i=e.get(s);if(void 0===i||!("folder"in i))return;e=i.folder}const s=e.get(t[t.length-1]);if(void 0!==s&&!("folder"in s))return s}getBinary(t){const e=this._getFile(t);if(void 0!==e)return"binary"in e?e.binary:e.binary=Ae(e.jsobj)}getJsObject(t){const e=this._getFile(t);if(void 0!==e)return"jsobj"in e?e.jsobj.value:(e.jsobj={value:He(e.binary)}).value}setJsObject(t,e){this._makeFolder(t,t.length-2).set(t[t.length-1],{jsobj:{value:e}})}has(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&e.has(t[t.length-1])}del(t){const e=this._getFolder(t,t.length-2);return void 0!==e&&(e.clear(),!0)}listPaths(t){const e=this._getFolder(t,t.length-2),s={paths:[],files:[]};if(void 0!==e)for(const[n,i]of e)"folder"in i?s.paths.push(n):s.files.push(n);return s}*WalkFiles(t=[],e=this._memFolder){for(const[s,n]of e){const e=[...t,s];"folder"in n?yield*this.WalkFiles(e,n.folder):yield[e,n]}}}class Pe{constructor(){this._delPathMap=new Map}addDel(t){let e=this._delPathMap;for(const s of t){let t=e.get(s);void 0===t&&(t=new Map,e.set(s,t)),e=t}e.clear()}isDel(t){let e=this._delPathMap;for(const s of t){const t=e.get(s);if(void 0===t)return!1;if(0===t.size)return!0;e=t}return!1}ls(){const t=(e,s)=>{const n=[];0===s.size&&0!==e.length&&n.push(e);for(const[i,r]of s)n.push(...t([...e,i],r));return n};return t([],this._delPathMap)}}class Fe extends nt{constructor(){super(...arguments),this._cacheStore=new Re(["transaction"]),this._del=new Pe}setBinary(t,e){return this._cacheStore.setBinary(t,e)}async getBinary(t){const e=await this._cacheStore.getBinary(t);return void 0!==e?e:this._del.isDel(t)?void 0:await this._targetStore.getBinary(t)}async getJsObject(t){return await this._cacheStore.has(t)?await this._cacheStore.getJsObject(t):this._del.isDel(t)?void 0:await this._targetStore.getJsObject(t)}setJsObject(t,e){return this._cacheStore.setJsObject(t,e)}async has(t){return!!(await this._cacheStore.has(t))||!this._del.isDel(t)&&await this._targetStore.has(t)}async del(t){return!(!1===await this._cacheStore.del(t)&&this._del.isDel(t)||(this._del.addDel(t),0))}async listPaths(t){const e=await this._cacheStore.listPaths(t);if(0===e.files.length&&0===e.paths.length&&this._del.isDel(t))return e;const s=await this._targetStore.listPaths(t);return{files:0===e.files.length?s.files:s.files.concat(e.files),paths:0===e.paths.length?s.paths:s.paths.concat(e.paths)}}}var Ge,qe,Je,We;(qe=Ge||(Ge={})).PATH_SEP="/",qe[qe.FILE_TYPE_FLAG=1]="FILE_TYPE_FLAG",qe[qe.DIR_TYPE_FLAG=2]="DIR_TYPE_FLAG",qe.ROOT_DIR=":root:";class Ue{constructor(t,e){let s=!1;if("string"==typeof t&&(s=t.trimStart().startsWith("/"),t=t.split(Ge.PATH_SEP).map((t=>t.trim()))),void 0!==e){if("string"==typeof e&&(e=e.split(Ge.PATH_SEP)),e=Ue.normal(e.map((t=>t.trim()))),!1===s){const s=e.concat(t);for(let t=0;t>s.length;++t)".."===s[t]&&(s.splice(t-1,2),t-=2);t=s}if(e.length>t.length)throw new SyntaxError(`'${t}' no belong to ${e}`);for(let s=0;s<e.length;++s)if(e[s]!==t[s])throw new SyntaxError(`'${t}' no belong to ${e}`)}this.paths=Ue.normal(t)}static normal(t){return t.filter((t=>""!==t&&!1===t.endsWith(".")))}get dirname(){const t=this.paths.slice(0,-1);return t.length>0?t.join(Ge.PATH_SEP):Ge.ROOT_DIR}get basename(){return this.paths[this.paths.length-1]}get fullpath(){return this.paths.join(Ge.PATH_SEP)}}(We=Je||(Je={})).FILE="file",We.DIR="dir";const Ye=new Map;class ze{constructor(t){this.dbName=t,this._idb=(t=>{let e=Ye.get(t);return void 0===e&&(e=function(t,e,{blocked:s,upgrade:n,blocking:i,terminated:r}={}){const a=indexedDB.open(t,e),o=Be(a);return n&&a.addEventListener("upgradeneeded",(t=>{n(Be(a.result),t.oldVersion,t.newVersion,Be(a.transaction))})),s&&a.addEventListener("blocked",(()=>s())),o.then((t=>{r&&t.addEventListener("close",(()=>r())),i&&t.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),o}(t,1,{upgrade(t,e,s,n){switch(e){case 0:t.createObjectStore(Je.DIR,{autoIncrement:!1,keyPath:null}).put(new Map,Ge.ROOT_DIR),t.createObjectStore(Je.FILE,{autoIncrement:!0,keyPath:null})}}}).then((e=>(Ye.set(t,e),e))),Ye.set(t,e)),e})(this.dbName)}async exists(t){const e=await this._idb,{dirname:s,basename:n}=new Ue(t),i=await e.get(Je.DIR,s);return void 0!==i&&i.has(n)}async writeFile(t,e){const s=(await this._idb).transaction([Je.FILE,Je.DIR],"readwrite"),n=s.objectStore(Je.DIR),i=s.objectStore(Je.FILE),{dirname:r,basename:a}=new Ue(t),o=await n.get(r);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${r}'`);let c=o.get(a);if(void 0!==c){if(c.type!==Ge.FILE_TYPE_FLAG)throw new Error(`EISDIR: illegal operation on a directory, open '${a}'`);c.size=e.length,c.fid}else c={type:Ge.FILE_TYPE_FLAG,size:e.length,fid:-1},o.set(a,c);const l=await i.add(e);-1!==c.fid&&await i.delete(c.fid),c.fid=l,await n.put(o,r)}async _mkdir(t,e,s){const{dirname:n,basename:i}=new Ue(t);let r=await s.get(n);if(void 0===r){if(!1===e)throw new Error(`ENOENT: no such file or directory, mkdir '${t}'`);r=await this._mkdir(n,e,s)}const a=r.get(i);if((null==a?void 0:a.type)===Ge.FILE_TYPE_FLAG)throw new Error(`EEXIST: file already exists, mkdir '${t}'`);let o;return void 0!==a&&(o=await s.get(t)),void 0===o&&(o=new Map,await s.put(o,t),r.set(i,{type:Ge.DIR_TYPE_FLAG}),await s.put(r,n)),o}async mkdir(t,e={}){const{recursive:s=!1}=e,n=(await this._idb).transaction(Je.DIR,"readwrite").objectStore(Je.DIR);await this._mkdir(new Ue(t).fullpath,s,n)}async readFile(t){const e=(await this._idb).transaction([Je.FILE,Je.DIR],"readwrite"),s=e.objectStore(Je.DIR),n=e.objectStore(Je.FILE),{dirname:i,basename:r}=new Ue(t),a=await s.get(i);if(void 0===a)throw new Error(`ENOENT: no such file or directory, open '${i}'`);const o=a.get(r);if(void 0===o)throw new Error(`ENOENT: no such file or directory, open '${t}'`);if(o.type===Ge.DIR_TYPE_FLAG)throw new Error("EISDIR: illegal operation on a directory, read");return await n.get(o.fid)}async _recursive_rmdir(t,e,s){const n=await e.get(t);if(void 0!==n){for(const[i,r]of n)r.type===Ge.FILE_TYPE_FLAG?await s.delete(r.fid):this._recursive_rmdir(t+Ge.PATH_SEP+i,e,s);await e.delete(t)}}async _rm(t,e,s,n,i){const{dirname:r,basename:a}=new Ue(t),o=await n.get(r);let c;if(void 0!==o&&(c=o.get(a)),void 0!==c){if(c.type===Ge.FILE_TYPE_FLAG)await i.delete(c.fid);else{if(!1===e)throw new Error(`EISDIR: Path is a directory: '${t}'`);await this._recursive_rmdir(t,n,i)}o.delete(a),await n.put(o,r)}else if(!1===s)throw new Error(`ENOENT: no such file or directory, stat '${t}'`)}async rm(t,e={}){const{recursive:s=!1,force:n=!1}=e,i=(await this._idb).transaction([Je.FILE,Je.DIR],"readwrite"),r=i.objectStore(Je.DIR),a=i.objectStore(Je.FILE);await this._rm(t,s,n,r,a)}async readdir(t){const e=(await this._idb).transaction(Je.DIR,"readwrite").objectStore(Je.DIR),s=await e.get(t);if(void 0===s)throw new Error(`ENOENT: no such file or directory, scandir '${t}'`);return s.entries()}}const Qe={IDB_NAME:Symbol("idbName"),TARGET_DIR:Symbol("targetDir")};let Ke=class extends nt{constructor(t="usr",e="cryptolalia-tree-fs"){super(),this.targetDir=t,this.idbName=e,this.currentPaths=this.targetDir.split(Ge.PATH_SEP).map((t=>t.trim())).filter(Boolean),this._fs=new ze(this.idbName)}async setBinary(t,e){const{dirname:s,fullpath:n}=new Ue(t,this.currentPaths);!1===await this._fs.exists(s)&&await this._fs.mkdir(s,{recursive:!0}),await this._fs.writeFile(n,e)}async getBinary(t){const{fullpath:e}=new Ue(t,this.currentPaths);if(await this._fs.exists(e))return this._fs.readFile(e)}async getJsObject(t){const e=await this.getBinary(t);if(e)return He(e)}setJsObject(t,e){return this.setBinary(t,Ae(e))}async has(t){const{fullpath:e}=new Ue(t,this.currentPaths);return await this._fs.exists(e)}async del(t){const{fullpath:e}=new Ue(t,this.currentPaths);return!!(await this._fs.exists(e))&&(await this._fs.rm(e,{recursive:!0,force:!0}),!0)}async listPaths(t){const{fullpath:e}=new Ue(t,this.currentPaths),s=[],n=[];if(await this._fs.exists(e))for(const[i,r]of await this._fs.readdir(e))try{r.type===Ge.FILE_TYPE_FLAG?n.push(i):s.push(i)}catch{}return{paths:s,files:n}}};Ke.ARGS=Qe,Ke=t([i(0,r(Qe.TARGET_DIR,{optional:!0})),i(1,r(Qe.IDB_NAME,{optional:!0})),s("design:paramtypes",[String,String])],Ke);class Ve extends Fe{constructor(t,e="cryptolalia-tree-fs"){super(),this.sourceTargetDir=t,this.idbName=e,this._targetStore=new Ke(this.sourceTargetDir),this.currentPaths=new Ue(this.sourceTargetDir).paths}}class Xe extends Ke{constructor(){super(...arguments),this._transactionMap=new Map}async startTransaction(t){const e=new Ue(t,this.targetDir).fullpath;let s=this._transactionMap.get(e);if(s){const t=new n;s.queue.push(t),await t.promise}const i={transaction:new Ve(e),finished:new n,queue:(null==s?void 0:s.queue)||[]};return this._transactionMap.set(e,i),i.finished.onSuccess((()=>{var t;const s=null==(t=i.queue.pop())?void 0:t.resolve;void 0===s?this._transactionMap.delete(e):s()})),i.transaction}async finishTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);if(void 0===e||e.transaction!==t)return!1;for(const n of t._del.ls())await t._targetStore.del(n);const s=t._targetStore;for(const[n,i]of t._cacheStore.WalkFiles())await s.setBinary(n,i.binary||Ae(i.jsobj.value));return e.finished.resolve(),!0}requestTransaction(t,e){return(async(t,e,s)=>{const n=await t.startTransaction(e);try{const e=await s(n);return await t.finishTransaction(n),e}catch(i){throw await t.stopTransaction(n),i}})(this,t,e)}async stopTransaction(t){const e=this._transactionMap.get(t.sourceTargetDir);return void 0!==e&&e.transaction===t&&(e.finished.resolve(),!0)}fork(t){const e=new Ue(t,this.targetDir).fullpath;return new Xe(e)}}let Ze=class{};var ts,es,ss,ns,is,rs;Ze=t([e()],Ze);const as={CHATS_CHANNE:Symbol("chats-channel")},os=t=>{throw new Error("should never happend")};let cs=class{constructor(t,e,s,i,r,a){this.storage=t,this.helper=e,this.config=s,this._timeHelper=i,this._msgHelper=r,this._cryptoHelper=a,this._ready=new n,this._sessionMap=new Map,this._sessionList=[],this._laliaMap=new Map,this._store=t.fork(["chat-app"]),this._initMemory(),this._initMessageListen()}async _initMemory(){const t=await this._trs,{files:e}=await t.listPaths([]);for(const s of e){const e=await t.getJsObject([s]);void 0===e?await t.del([s]):(this._sessionMap.set(s,e),this._sessionList.push(e))}this._sessionList=[...this._sessionMap.values()].sort(((t,e)=>this.helper.compare(t,e))),this._ready.resolve()}async _initMessageListen(){await this._ready.promise,this.helper.onNewMessage=async t=>{var e,s,n,i,r;switch(t[0]){case ls.MSG:{if(void 0===this._sessionMap.get(t[1]))return;const s=this._laliaMap.get(t[1]);void 0!==s&&!0===await s.cryptolalia.addMsg(t[2])&&await(null==(e=this.onNewMessage)?void 0:e.call(this,[t[1],t[2]]))}break;case ls.SYNC:{const e=this._laliaMap.get(t[1]);void 0!==e&&await(null==(n=(s=e.syncChannel).onMessage)?void 0:n.call(s,t[2]))}break;case ls.SESSION:await(null==(r=(i=this.helper).handshakeSession)?void 0:r.call(i,t[1],t[2]))}};const t=this._sessionList.slice();for(const e of t){const t=this.helper.getSessionId(e);if(this._sessionMap.has(t)){const e=await this._getCryptolalia(t);await e.cryptolalia.sync.doSync()}}}_doSort(){this._sessionList.sort(((t,e)=>this.helper.compare(t,e)))}get _needEmitOrderChange(){return void 0!==this.onOrderChange}_emitOrderChange(t){let e=this._orderChangeEntryCollection;if(void 0===e){e=new Map;const t=e;queueMicrotask((()=>{var e;this._orderChangeEntryCollection=void 0,null==(e=this.onOrderChange)||e.call(this,{entries:t.values()})}))}let s=e.get(t.sessionId);if(void 0!==s)if("insert"===s.type){if("insert"===t.type)throw new TypeError(`duplication insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):os(t.type)}else if("update"===s.type){if("insert"===t.type)throw new TypeError(`invalid insert sessionId: '${t.sessionId}'`);"update"===t.type?s.index=t.index:"delete"===t.type?e.delete(t.sessionId):os(t.type)}else if("delete"===s.type)if("insert"===t.type)e.set(t.sessionId,t);else{if("update"===t.type)throw new TypeError(`invalid update sessionId: '${t.sessionId}'`);if("delete"===t.type)throw new TypeError(`duplication delete sessionId: '${t.sessionId}'`);os(t.type)}else os(s.type);else e.set(t.sessionId,t)}async addSession(t,e){if(this._ready.is_resolved||await this._ready.promise,this._sessionMap.has(t))return!1;if(this._sessionMap.set(t,e),this._sessionList.unshift(e),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"insert",index:s,sessionId:t})}if(void 0!==this.helper.handshakeSession){const s=await this.helper.handshakeSession(t);void 0!==s&&await this.helper.sendMessage(e,[ls.SESSION,t,s])}return!0}async getSessionInfo(t){return this._ready.is_resolved||await this._ready.promise,this._sessionMap.get(t)}async updateSession(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._sessionList.indexOf(s);if(s!==e&&(this._sessionMap.set(t,e),this._sessionList.splice(n,1,e)),this._doSort(),await this._store.setJsObject(["session",t],e),this._needEmitOrderChange){const s=this._sessionList.indexOf(e);this._emitOrderChange({type:"update",index:s,oldIndex:n,sessionId:t})}return!0}async getSessionList(t={}){this._ready.is_resolved||await this._ready.promise;const{offset:e=0,limit:s=1/0}=t;return this._sessionList.slice(e,s+e)}_getCryptolalia(t){let e=this._laliaMap.get(t);if(void 0===e){const s={postMessage:e=>{const s=this._sessionMap.get(t);if(void 0!==s)return this.helper.sendMessage(s,[ls.SYNC,t,e])}},n=c(oe,new l([[h(it),this.storage.fork([t])],[Ut.ARGS.SYNC_CHANNE,s],[h(vt),this._timeHelper],[h(at),this.config],[h(ot),this._msgHelper],[h(st),this._cryptoHelper]]));this._laliaMap.set(t,e={cryptolalia:n,syncChannel:s})}return e}async sendMessage(t,e){this._ready.is_resolved||await this._ready.promise;const s=this._sessionMap.get(t);if(void 0===s)return!1;const n=this._getCryptolalia(t);return!!(await n.cryptolalia.addMsg(e))&&(await this.helper.sendMessage(s,[ls.MSG,t,e]),!0)}async getMessageList(t,e){var s;return this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t)?[]:this._getCryptolalia(t).cryptolalia.getMsgList(null!=(s=e.timestamp)?s:this._timeHelper.now(),e)}async doSync(t){return this._ready.is_resolved||await this._ready.promise,!1===this._sessionMap.has(t)?[]:this._getCryptolalia(t).cryptolalia.sync.doSync()}};var ls,hs;cs.ARGS=as,t([rt(["session"],"_store","_trs"),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",Promise)],cs.prototype,"_initMemory",null),cs=t([e(),s("design:paramtypes",["function"==typeof(ts=void 0!==it&&it)?ts:Object,"function"==typeof(es=void 0!==Ze&&Ze)?es:Object,"function"==typeof(ss=void 0!==at&&at)?ss:Object,"function"==typeof(ns=void 0!==vt&&vt)?ns:Object,"function"==typeof(is=void 0!==ot&&ot)?is:Object,"function"==typeof(rs=void 0!==st&&st)?rs:Object])],cs),(hs=ls||(ls={}))[hs.MSG=0]="MSG",hs[hs.SESSION=1]="SESSION",hs[hs.SYNC=2]="SYNC";class ds extends st{async sha256Binary(t){return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}sha256HashBuilder(){return new us}}class us extends class{}{constructor(){super(...arguments),this.chunks=[],this.len=0}update(t){return this.chunks.push(t),this.len+=t.length,this}async digest(){const t=new Uint8Array(this.len);let e=0;for(const s of this.chunks)t.set(s,e),e+=s.length;return new Uint8Array(await crypto.subtle.digest("SHA-256",t))}}const ps=new l;c(ce,ps);{class t extends at{constructor(){super(...arguments),this.branchGroupCount=64,this.timespan=1e4,this.startTime=+new Date("2021-9-15")}}c(t,ps)}{const t=new TextEncoder;class e extends ot{getSignature(e){const s=t.encode(JSON.stringify(e)),n=new Uint8Array(32);for(let t=0;t<s.length;++t){const e=t%n.length;n[e]+=s[t];for(let s=(e+1)%n.length;s<n.length;++s)n[s]=t*s+n[e]}return n}getCreateTime(t){return t.time}}c(e,ps)}c(ds,ps);const fs={postMessage(t){},get onMessage(){return gs.postMessage},set onMessage(t){gs.postMessage=t}},gs={postMessage(t){},get onMessage(){return fs.postMessage},set onMessage(t){fs.postMessage=t}},ys=new l([[Ut.ARGS.SYNC_CHANNE,fs]],ps);c(Xe,ys.installMask(new l([[Xe.ARGS.TARGET_DIR,"user1"]])));const ws=new l([[Ut.ARGS.SYNC_CHANNE,gs]],ps);c(Xe,ws.installMask(new l([[Xe.ARGS.TARGET_DIR,"user2"]])));const ms=c(oe,ys),_s=c(oe,ws),vs=t=>{var e;const s=new l([],ps);{const n=Symbol("localId");s.set(n,t);class i extends Ze{constructor(){super(...arguments),this.bchanne=new BroadcastChannel("chatsApp"),this.handshakeSession=async(t,e)=>void 0===e?{senderId:this.localId}:void(await this.app.addSession(t,{nickname:e.senderId,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1}))}getSessionId(t){return[this.localId,t.nickname].sort().join("-")}compare(t,e){return t.isCollection&&!e.isCollection?-1:e.isCollection&&!t.isCollection?1:e.lastMsgTime-t.lastMsgTime}sendMessage(t,e){this.bchanne.postMessage(["chatsApp",t.nickname,e])}bfOnInit(){this.bchanne.addEventListener("message",(t=>{if(console.log("event",t.data),void 0===this.onNewMessage)return;const{data:e}=t;Array.isArray(e)&&3===e.length&&"chatsApp"===e[0]&&e[1]===this.localId&&this.onNewMessage(e[2])}))}}d([r(n),u("design:type",String)],i.prototype,"localId",void 0),d([r(cs),u("design:type","function"==typeof(e=void 0!==cs&&cs)?e:Object)],i.prototype,"app",void 0),console.log("MyChatsAppHelper",h(i)),c(i,s)}c(Xe,s.installMask(new l([[Xe.ARGS.TARGET_DIR,"online-"+t]])));return c(cs,s)};function bs(t,e,s){const n=t.slice();return n[14]=e[s],n[16]=s,n}function Is(t,e){let s,n,i,r,a,o,c,l,h,d,u,p,f,g,T,j=new Date(e[14].time).toLocaleTimeString()+"",C=e[14].sender+"",k=e[14].content+"";return{key:t,first:null,c(){s=y("li"),n=y("span"),i=w(j),r=m(),a=y("div"),o=y("address"),c=w(C),l=m(),h=y("p"),d=w(k),u=m(),_(n,"class","time-tip svelte-47040z"),_(o,"class","avator svelte-47040z"),_(h,"class","message svelte-47040z"),_(a,"class","content-area svelte-47040z"),_(s,"class","item svelte-47040z"),v(s,"self",e[0](e[14].sender)),this.first=s},m(t,f){b(t,s,f),I(s,n),I(n,i),I(s,r),I(s,a),I(a,o),I(o,c),I(a,l),I(a,h),I(h,d),I(s,u),g||(T=S(p=Ms.call(null,s,0===e[16]?{introend:e[12]}:{})),g=!0)},p(t,n){e=t,2&n&&j!==(j=new Date(e[14].time).toLocaleTimeString()+"")&&M(i,j),2&n&&C!==(C=e[14].sender+"")&&M(c,C),2&n&&k!==(k=e[14].content+"")&&M(d,k),p&&B(p.update)&&18&n&&p.update.call(null,0===e[16]?{introend:e[12]}:{}),3&n&&v(s,"self",e[0](e[14].sender))},i(t){f||E((()=>{f=D(s,$,{delay:100*Math.log2(e[16]+1),duration:300,y:e[4]?-50:50,opacity:0}),f.start()}))},o:L,d(t){t&&O(s),g=!1,T()}}}function Ss(t){let e,s,n,i,r,a,o,c,l,h,d=[],u=new Map,p=t[1];const f=t=>t[14].time;for(let g=0;g<p.length;g+=1){let e=bs(t,p,g),s=f(e);u.set(s,d[g]=Is(s,e))}return{c(){e=y("ul");for(let t=0;t<d.length;t+=1)d[t].c();s=m(),n=y("div"),i=y("input"),r=m(),a=y("button"),a.textContent="发送",o=m(),c=y("button"),c.textContent="同步",_(e,"class","list svelte-47040z"),v(e,"syncing",t[5]),_(i,"type","text"),_(i,"class","word-to-send"),i.disabled=t[3],_(i,"placeholder","请输入要发送的内容"),_(a,"class","do-send svelte-47040z"),v(a,"activing",t[3]),_(c,"class","do-sync svelte-47040z"),v(c,"activing",t[5]),_(n,"class","controller-panel svelte-47040z")},m(u,p){b(u,e,p);for(let t=0;t<d.length;t+=1)d[t].m(e,null);b(u,s,p),b(u,n,p),I(n,i),T(i,t[2]),I(n,r),I(n,a),I(n,o),I(n,c),l||(h=[j(i,"input",t[13]),j(a,"click",t[6]),j(c,"click",t[7])],l=!0)},p(t,[s]){19&s&&(p=t[1],d=C(d,s,f,1,t,p,u,e,x,Is,null,bs)),32&s&&v(e,"syncing",t[5]),8&s&&(i.disabled=t[3]),4&s&&i.value!==t[2]&&T(i,t[2]),8&s&&v(a,"activing",t[3]),32&s&&v(c,"activing",t[5])},i(t){for(let e=0;e<p.length;e+=1)k(d[e])},o:L,d(t){t&&O(e);for(let e=0;e<d.length;e+=1)d[e].d();t&&O(s),t&&O(n),l=!1,N(h)}}}function Ms(t,e){const s=Object.entries(e).map((([e,s])=>[e,t.addEventListener(e,s)]));return{destroy(){s.forEach((([e,s])=>{t.removeEventListener(e,s)}))}}}function Bs(t,e,s){let n=[],i="",r=!1;let a=!0,o=!1;const c=()=>A(void 0,void 0,void 0,(function*(){if(!o){s(5,o=!0);try{yield h(),s(1,n=yield d())}finally{s(5,o=!1)}}}));let{doSend:l=(t=>{})}=e,{doSync:h=(()=>{})}=e,{getList:d=(()=>[])}=e,{isSelf:u=(t=>!1)}=e;H(c);return t.$$set=t=>{"doSend"in t&&s(8,l=t.doSend),"doSync"in t&&s(9,h=t.doSync),"getList"in t&&s(10,d=t.getList),"isSelf"in t&&s(0,u=t.isSelf)},[u,n,i,r,a,o,()=>A(void 0,void 0,void 0,(function*(){if(r)return;const t=i.trim();if(0!==t.length){s(3,r=!0);try{yield h(),console.log("do send",t),yield l(t),s(2,i=""),s(1,n=yield d())}finally{s(3,r=!1)}}})),c,l,h,d,()=>c(),()=>s(4,a=!1),function(){i=this.value,s(2,i)}]}class Es extends p{constructor(t){super(),f(this,t,Bs,Ss,g,{doSend:8,doSync:9,getList:10,isSelf:0,onListChanged:11})}get onListChanged(){return this.$$.ctx[11]}}function Ds(t){let e,s,n,i,r,a,o,c;return n=new Es({props:{doSend:t[0],doSync:t[2],getList:t[4],isSelf:t[6]}}),a=new Es({props:{doSend:t[1],doSync:t[3],getList:t[5],isSelf:t[7]}}),{c(){e=y("main"),s=y("section"),R(n.$$.fragment),i=m(),r=y("section"),R(a.$$.fragment),_(s,"class","chat-panel panel-1 svelte-16sysco"),_(r,"class","chat-panel panel-2 svelte-16sysco"),_(e,"class","chat-panels svelte-16sysco")},m(t,o){b(t,e,o),I(e,s),P(n,s,null),I(e,i),I(e,r),P(a,r,null),c=!0},p:L,i(t){c||(k(n.$$.fragment,t),k(a.$$.fragment,t),o||E((()=>{o=D(e,q,{}),o.start()})),c=!0)},o(t){F(n.$$.fragment,t),F(a.$$.fragment,t),c=!1},d(t){t&&O(e),G(n),G(a)}}}function $s(t){const e=(t,e)=>s=>e.addMsg({content:s,sender:t,time:Date.now()}),s=t=>()=>A(void 0,void 0,void 0,(function*(){console.group("do sync"),yield t.sync.doSync(),console.groupEnd()})),n=t=>()=>A(void 0,void 0,void 0,(function*(){const e=[];for(const s of yield t.getMsgList(Date.now(),{offset:0,limit:100,order:-1}))e.push(s.content);return e}));return[e("user1",ms),e("user2",_s),s(ms),s(_s),n(ms),n(_s),t=>"user1"===t,t=>"user2"===t]}class Ls extends p{constructor(t){super(),f(this,t,$s,Ds,g,{})}}function Os(t,e,s){const n=t.slice();return n[22]=e[s],n}function Ts(t){let e,s,n,i,r,a,o,c,l,h,d,u,p,f,g=[],S=new Map,B=t[3];const E=t=>t[22].nickname;for(let y=0;y<B.length;y+=1){let e=Os(t,B,y),s=E(e);S.set(s,g[y]=Hs(s,e))}return{c(){e=y("section"),s=y("h2"),n=w("Welcome 💜 "),i=w(t[1]),r=m(),a=y("ul"),o=y("li"),c=y("input"),l=m(),h=y("button"),h.textContent="添加好友",d=m();for(let t=0;t<g.length;t+=1)g[t].c();_(c,"type","text"),v(h,"activing",t[5]),_(o,"class","add-friend"),_(a,"class","friend-list svelte-9jvscy")},m(y,w){b(y,e,w),I(e,s),I(s,n),I(s,i),I(e,r),I(e,a),I(a,o),I(o,c),T(c,t[4]),I(o,l),I(o,h),I(a,d);for(let t=0;t<g.length;t+=1)g[t].m(a,null);u=!0,p||(f=[j(c,"input",t[17]),j(h,"click",t[9])],p=!0)},p(t,e){(!u||2&e)&&M(i,t[1]),16&e&&c.value!==t[4]&&T(c,t[4]),32&e&&v(h,"activing",t[5]),64712&e&&(B=t[3],J(),g=C(g,e,E,1,t,B,S,a,U,Hs,null,Os),W())},i(t){if(!u){for(let t=0;t<B.length;t+=1)k(g[t]);u=!0}},o(t){for(let e=0;e<g.length;e+=1)F(g[e]);u=!1},d(t){t&&O(e);for(let e=0;e<g.length;e+=1)g[e].d();p=!1,N(f)}}}function js(t){let e,s,n,i,r,a,o,c,l;return{c(){e=y("session"),s=y("h2"),s.textContent="Hi~ Please Login",n=m(),i=y("div"),r=y("input"),a=m(),o=y("button"),o.textContent="登录",_(r,"placeholder","请输入您的名字"),_(o,"class","login-btn svelte-9jvscy"),v(o,"activing",t[2]),_(i,"class","form svelte-9jvscy"),_(e,"class","login-panel svelte-9jvscy")},m(h,d){b(h,e,d),I(e,s),I(e,n),I(e,i),I(i,r),T(r,t[1]),I(i,a),I(i,o),c||(l=[j(r,"input",t[16]),j(o,"click",t[8])],c=!0)},p(t,e){2&e&&r.value!==t[1]&&T(r,t[1]),4&e&&v(o,"activing",t[2])},i:L,o:L,d(t){t&&O(e),c=!1,N(l)}}}function Cs(t){let e,s,n=t[22].badge+"";return{c(){e=y("sup"),s=w(n),_(e,"title","未读"),_(e,"class","badge svelte-9jvscy")},m(t,n){b(t,e,n),I(e,s)},p(t,e){8&e&&n!==(n=t[22].badge+"")&&M(s,n)},d(t){t&&O(e)}}}function ks(t){let e,s,n,i,r,a,o,c=t[22].lastMsgPreview+"",l=new Date(t[22].lastMsgTime).toLocaleTimeString()+"";return{c(){e=y("div"),s=y("span"),n=w(c),i=m(),r=y("span"),a=w(l),_(s,"class","msg-preview svelte-9jvscy"),_(r,"class","msg-time"),_(e,"class","last-msg svelte-9jvscy")},m(t,o){b(t,e,o),I(e,s),I(s,n),I(e,i),I(e,r),I(r,a)},p(t,e){8&e&&c!==(c=t[22].lastMsgPreview+"")&&M(n,c),8&e&&l!==(l=new Date(t[22].lastMsgTime).toLocaleTimeString()+"")&&M(a,l)},i(t){o||E((()=>{o=D(e,Y,{duration:300}),o.start()}))},o:L,d(t){t&&O(e)}}}function Ns(t){let e,s,n,i,r;function a(e){t[20](e)}let o={doSend:t[12],doSync:t[13],getList:t[14],isSelf:t[15]};return void 0!==t[7]&&(o.onListChanged=t[7]),s=new Es({props:o}),z.push((()=>Q(s,"onListChanged",a))),{c(){e=y("div"),R(s.$$.fragment),_(e,"class","chat-panel svelte-9jvscy")},m(t,n){b(t,e,n),P(s,e,null),r=!0},p(t,e){const i={};!n&&128&e&&(n=!0,i.onListChanged=t[7],K((()=>n=!1))),s.$set(i)},i(t){r||(k(s.$$.fragment,t),i||E((()=>{i=D(e,Y,{duration:300}),i.start()})),r=!0)},o(t){F(s.$$.fragment,t),r=!1},d(t){t&&O(e),G(s)}}}function Hs(t,e){let s,n,i,r,a,o,c,l,h,d,u,p,f,g,v,S,B,E=e[22].nickname+"",D=e[22].isCollection?"❤️":"🤍",$=0!==e[22].badge&&Cs(e);function L(){return e[18](e[22])}function T(){return e[19](e[22])}const C=[Ns,ks],H=[];function x(t,e){return t[6]===t[22]?0:t[22].lastMsgPreview?1:-1}return~(p=x(e))&&(f=H[p]=C[p](e)),{key:t,first:null,c(){s=y("li"),n=y("div"),i=y("span"),r=w(E),a=m(),$&&$.c(),o=m(),c=y("span"),l=w(D),h=m(),d=y("button"),d.textContent="💬",u=m(),f&&f.c(),g=m(),_(i,"class","nickname svelte-9jvscy"),_(c,"title","收藏"),_(c,"class","collection svelte-9jvscy"),_(d,"title","开始聊天"),_(d,"class","start-chat-btn"),_(n,"class","base-info svelte-9jvscy"),_(s,"class","friend-info svelte-9jvscy"),this.first=s},m(t,e){b(t,s,e),I(s,n),I(n,i),I(i,r),I(i,a),$&&$.m(i,null),I(n,o),I(n,c),I(c,l),I(n,h),I(n,d),I(s,u),~p&&H[p].m(s,null),I(s,g),v=!0,S||(B=[j(c,"click",L),j(d,"click",T)],S=!0)},p(t,n){e=t,(!v||8&n)&&E!==(E=e[22].nickname+"")&&M(r,E),0!==e[22].badge?$?$.p(e,n):($=Cs(e),$.c(),$.m(i,null)):$&&($.d(1),$=null),(!v||8&n)&&D!==(D=e[22].isCollection?"❤️":"🤍")&&M(l,D);let a=p;p=x(e),p===a?~p&&H[p].p(e,n):(f&&(J(),F(H[a],1,1,(()=>{H[a]=null})),W()),~p?(f=H[p],f?f.p(e,n):(f=H[p]=C[p](e),f.c()),k(f,1),f.m(s,g)):f=null)},i(t){v||(k(f),v=!0)},o(t){F(f),v=!1},d(t){t&&O(s),$&&$.d(),~p&&H[p].d(),S=!1,N(B)}}}function xs(t){let e,s,n,i,r;const a=[js,Ts],o=[];function c(t,e){return void 0===t[0]?0:1}return s=c(t),n=o[s]=a[s](t),{c(){e=y("main"),n.c()},m(t,n){b(t,e,n),o[s].m(e,null),r=!0},p(t,[i]){let r=s;s=c(t),s===r?o[s].p(t,i):(J(),F(o[r],1,1,(()=>{o[r]=null})),W(),n=o[s],n?n.p(t,i):(n=o[s]=a[s](t),n.c()),k(n,1),n.m(e,null))},i(t){r||(k(n),i||E((()=>{i=D(e,q,{}),i.start()})),r=!0)},o(t){F(n),r=!1},d(t){t&&O(e),o[s].d()}}}function As(t,e,s){let n,i="",r=!1;let a=[],o="",c=!1;const l=t=>A(void 0,void 0,void 0,(function*(){t.isCollection=!t.isCollection;const e=n.helper.getSessionId(t);(yield n.updateSession(e,t))&&s(3,a=yield n.getSessionList())}));let h,d="";const u=t=>{s(6,h=h===t?void 0:t),d=h?n.helper.getSessionId(h):""};let p;return[n,i,r,a,o,c,h,p,()=>A(void 0,void 0,void 0,(function*(){s(2,r=!0);try{if(s(1,i=i.trim()),0===i.length)return;s(0,n=vs(i)),console.log("chatsApp",n),s(3,a=yield n.getSessionList()),s(0,n.onOrderChange=()=>A(void 0,void 0,void 0,(function*(){s(3,a=yield n.getSessionList())})),n),s(0,n.onNewMessage=([t,e])=>A(void 0,void 0,void 0,(function*(){t===d&&p();const s=yield n.getSessionInfo(t);void 0!==s&&(s.lastMsgPreview=e.content,s.lastMsgTime=Date.now(),t!==d&&(s.badge+=1),yield n.updateSession(t,s))})),n)}finally{s(2,r=!1)}})),()=>A(void 0,void 0,void 0,(function*(){try{if(s(5,c=!0),s(4,o=o.trim()),0===o.length)return;const t={nickname:o,badge:0,lastMsgPreview:"",lastMsgTime:Date.now(),isCollection:!1},e=n.helper.getSessionId(t);(yield n.addSession(e,t))&&s(3,a=yield n.getSessionList()),s(4,o="")}finally{s(5,c=!1)}})),l,u,t=>n.sendMessage(d,{sender:i,content:t,time:Date.now()}),()=>{if(console.log("no need sync~"),0!==(null==h?void 0:h.badge))return s(6,h.badge=0,h),n.updateSession(d,h)},()=>A(void 0,void 0,void 0,(function*(){return(yield n.getMessageList(d,{limit:100,order:-1})).map((t=>t.content))})),t=>t===i,function(){i=this.value,s(1,i)},function(){o=this.value,s(4,o)},t=>l(t),t=>u(t),function(t){p=t,s(7,p)}]}class Rs extends p{constructor(t){super(),f(this,t,As,xs,g,{})}}function Ps(t){let e;return{c(){e=w("Local Chat Demo")},m(t,s){b(t,e,s)},d(t){t&&O(e)}}}function Fs(t){let e;return{c(){e=w("Chat Online Demo")},m(t,s){b(t,e,s)},d(t){t&&O(e)}}}function Gs(t){let e,s;return e=new Ls({}),{c(){R(e.$$.fragment)},m(t,n){P(e,t,n),s=!0},i(t){s||(k(e.$$.fragment,t),s=!0)},o(t){F(e.$$.fragment,t),s=!1},d(t){G(e,t)}}}function qs(t){let e,s,n,i,r,a,o,c;return o=new Rs({}),{c(){e=y("p"),s=w("提示：该DEMO使用BroadcastChannel模块网络广播，"),n=y("a"),i=w("打开更多同域页面"),r=w("即可多账户登录"),a=m(),R(o.$$.fragment),_(n,"href",location.href),_(n,"target","_blank"),_(e,"class","tip svelte-15fozii")},m(t,l){b(t,e,l),I(e,s),I(e,n),I(n,i),I(e,r),b(t,a,l),P(o,t,l),c=!0},p:L,i(t){c||(k(o.$$.fragment,t),c=!0)},o(t){F(o.$$.fragment,t),c=!1},d(t){t&&O(e),t&&O(a),G(o,t)}}}function Js(t){let e,s,n,i,r,a,o,c,l,h,d,u,p;return r=new Z({props:{getProps:Us,to:"/",$$slots:{default:[Ps]},$$scope:{ctx:t}}}),o=new Z({props:{getProps:Us,to:"/online",$$slots:{default:[Fs]},$$scope:{ctx:t}}}),h=new tt({props:{path:"/",$$slots:{default:[Gs]},$$scope:{ctx:t}}}),u=new tt({props:{path:"/online",$$slots:{default:[qs]},$$scope:{ctx:t}}}),{c(){e=y("header"),s=y("h1"),s.textContent="Cryptolalia Demo",n=m(),i=y("nav"),R(r.$$.fragment),a=m(),R(o.$$.fragment),c=m(),l=y("main"),R(h.$$.fragment),d=m(),R(u.$$.fragment),_(s,"class","svelte-15fozii"),_(i,"class","svelte-15fozii"),_(e,"class","svelte-15fozii"),_(l,"class","svelte-15fozii")},m(t,f){b(t,e,f),I(e,s),I(e,n),I(e,i),P(r,i,null),I(i,a),P(o,i,null),b(t,c,f),b(t,l,f),P(h,l,null),I(l,d),P(u,l,null),p=!0},p(t,e){const s={};4&e&&(s.$$scope={dirty:e,ctx:t}),r.$set(s);const n={};4&e&&(n.$$scope={dirty:e,ctx:t}),o.$set(n);const i={};4&e&&(i.$$scope={dirty:e,ctx:t}),h.$set(i);const a={};4&e&&(a.$$scope={dirty:e,ctx:t}),u.$set(a)},i(t){p||(k(r.$$.fragment,t),k(o.$$.fragment,t),k(h.$$.fragment,t),k(u.$$.fragment,t),p=!0)},o(t){F(r.$$.fragment,t),F(o.$$.fragment,t),F(h.$$.fragment,t),F(u.$$.fragment,t),p=!1},d(t){t&&O(e),G(r),G(o),t&&O(c),t&&O(l),G(h),G(u)}}}function Ws(t){let e,s;return e=new V({props:{history:t[0],$$slots:{default:[Js]},$$scope:{ctx:t}}}),{c(){R(e.$$.fragment)},m(t,n){P(e,t,n),s=!0},p(t,[s]){const n={};4&s&&(n.$$scope={dirty:s,ctx:t}),e.$set(n)},i(t){s||(k(e.$$.fragment,t),s=!0)},o(t){F(e.$$.fragment,t),s=!1},d(t){G(e,t)}}}function Us({location:t,href:e,isPartiallyCurrent:s,isCurrent:n}){return("/"===e?n:s||n)?{class:"nav-item active"}:{class:"nav-item"}}function Ys(t){return[X(function(){const t=et({});let e=[];return t.listen((s=>{"POP"===t.action&&e.forEach((t=>t(s)))})),{get location(){return t.location},addEventListener(t,s){"popstate"===t&&e.push(s)},removeEventListener(t,s){"popstate"===t&&(e=e.filter((t=>t!==s)))},history:{get state(){return t.location.state},pushState(e,s,n){t.push(n,e)},replaceState(e,s,n){t.replace(n,e)},go(e){t.go(e)}}}}())]}new class extends p{constructor(t){super(),f(this,t,Ys,Ws,g,{})}}({target:document.getElementById("app")});
